<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CTL Warranty Board Report</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Space+Mono:wght@400;700&display=swap');
:root{--bg-primary:#0c1220;--bg-card:#111a2e;--bg-card-alt:#152036;--border:#1e3050;--border-glow:#2a5a8f;--text-primary:#e8edf5;--text-secondary:#8899b0;--text-muted:#5a6a80;--accent-blue:#4aa3df;--accent-cyan:#22d3ee;--accent-green:#34d399;--accent-yellow:#fbbf24;--accent-orange:#f97316;--accent-red:#ef4444;--accent-purple:#a78bfa;--accent-pink:#f472b6;--positive:#34d399;--negative:#ef4444;--font-main:'DM Sans',sans-serif;--font-mono:'Space Mono',monospace}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font-main);background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-x:hidden}
.password-overlay{position:fixed;inset:0;z-index:1000;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:24px}
.password-overlay.hidden{display:none}
.password-overlay h1{font-size:28px;font-weight:600;color:var(--accent-cyan)}
.password-overlay p{color:var(--text-secondary);font-size:14px}
.password-overlay input{background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);padding:12px 20px;border-radius:8px;font-size:16px;width:280px;text-align:center;font-family:var(--font-mono)}
.password-overlay input:focus{outline:none;border-color:var(--accent-cyan)}
.password-overlay button{background:linear-gradient(135deg,var(--accent-blue),var(--accent-cyan));border:none;color:#fff;padding:10px 32px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:transform .15s}
.password-overlay button:hover{transform:scale(1.03)}
.pw-error{color:var(--accent-red);font-size:13px;min-height:18px}
.loading-overlay{position:fixed;inset:0;z-index:999;background:rgba(12,18,32,.95);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
.loading-overlay.hidden{display:none}
.spinner{width:40px;height:40px;border-radius:50%;border:3px solid var(--border);border-top-color:var(--accent-cyan);animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-overlay p{color:var(--text-secondary);font-size:14px}
.dashboard{max-width:1400px;margin:0 auto;padding:32px 24px}
.dashboard.hidden{display:none}
.header{display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:16px;margin-bottom:32px;padding-bottom:24px;border-bottom:1px solid var(--border)}
.header-left h1{font-size:26px;font-weight:700;letter-spacing:-.5px;background:linear-gradient(135deg,var(--accent-cyan),var(--accent-blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-left .subtitle{color:var(--text-secondary);font-size:13px;margin-top:6px}
.header-left .subtitle span{color:var(--accent-cyan)}
.header-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.header-right label{color:var(--text-secondary);font-size:12px;font-weight:500}
.header-right input[type="date"]{background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);padding:6px 10px;border-radius:6px;font-size:13px;font-family:var(--font-mono)}
.btn{padding:7px 16px;border-radius:6px;border:none;cursor:pointer;font-size:12px;font-weight:600;transition:all .15s}
.btn-primary{background:var(--accent-blue);color:#fff}
.btn-secondary{background:var(--bg-card);color:var(--text-secondary);border:1px solid var(--border)}
.btn:hover{transform:translateY(-1px);filter:brightness(1.1)}
.date-range-label{color:var(--text-muted);font-size:11px;font-family:var(--font-mono)}
.section-header{display:flex;align-items:center;gap:12px;margin:40px 0 20px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.section-header h2{font-size:18px;font-weight:600}
.badge{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:3px 10px;border-radius:20px;font-family:var(--font-mono)}
.badge-blue{background:rgba(74,163,223,.15);color:var(--accent-blue)}
.badge-green{background:rgba(52,211,153,.15);color:var(--accent-green)}
.badge-yellow{background:rgba(251,191,36,.15);color:var(--accent-yellow)}
.badge-red{background:rgba(239,68,68,.15);color:var(--accent-red)}
.badge-purple{background:rgba(167,139,250,.15);color:var(--accent-purple)}
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:32px}
.kpi-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:18px 16px;position:relative;overflow:hidden}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi-card.blue::before{background:var(--accent-blue)}.kpi-card.cyan::before{background:var(--accent-cyan)}.kpi-card.green::before{background:var(--accent-green)}.kpi-card.yellow::before{background:var(--accent-yellow)}.kpi-card.red::before{background:var(--accent-red)}.kpi-card.purple::before{background:var(--accent-purple)}.kpi-card.orange::before{background:var(--accent-orange)}
.kpi-label{font-size:11px;font-weight:500;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px}
.kpi-value{font-size:24px;font-weight:700;margin-top:6px;font-family:var(--font-mono)}
.kpi-sub{font-size:11px;color:var(--text-muted);margin-top:4px}
.chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
.chart-full{grid-column:1/-1}
.chart-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:20px;position:relative}
.chart-card h3{font-size:14px;font-weight:600;margin-bottom:4px}
.chart-card .chart-subtitle{font-size:11px;color:var(--text-muted);margin-bottom:16px}
.chart-card canvas{max-height:380px}
.chart-card.tall canvas{max-height:500px}
.chart-card[data-clickable]::after{content:'Click data for details';position:absolute;bottom:8px;right:14px;font-size:10px;color:var(--text-muted);font-style:italic;opacity:.6}
.insight-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:14px;margin-bottom:32px}
.insight-card{background:var(--bg-card-alt);border:1px solid var(--border);border-radius:10px;padding:18px;font-size:13px;line-height:1.6;color:var(--text-secondary)}
.insight-card .insight-title{font-size:12px;font-weight:700;color:var(--accent-cyan);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.insight-card strong{color:var(--text-primary)}
.trend-indicator{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:700;font-family:var(--font-mono)}
.trend-up{background:rgba(52,211,153,.15);color:var(--accent-green)}
.trend-down{background:rgba(239,68,68,.15);color:var(--accent-red)}
.trend-flat{background:rgba(251,191,36,.15);color:var(--accent-yellow)}
.data-table-container{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:24px}
.data-table-container h3{font-size:14px;font-weight:600;padding:16px 20px 12px;border-bottom:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:10px 16px;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);background:var(--bg-card-alt)}
td{padding:10px 16px;border-bottom:1px solid rgba(30,48,80,.4);color:var(--text-secondary)}
tr:hover td{background:rgba(42,90,143,.08)}
td.mono{font-family:var(--font-mono);font-size:12px}
td.positive{color:var(--accent-green)}
td.negative{color:var(--accent-red)}
.detail-modal-overlay{position:fixed;inset:0;z-index:900;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.detail-modal-overlay.active{opacity:1;pointer-events:all}
.detail-modal{background:var(--bg-card);border:1px solid var(--border-glow);border-radius:12px;max-width:900px;width:95%;max-height:80vh;overflow-y:auto;padding:0;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.detail-modal-header{display:flex;align-items:center;justify-content:space-between;padding:18px 24px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg-card);z-index:2}
.detail-modal-header h3{font-size:16px;font-weight:600}
.close-btn{background:none;border:1px solid var(--border);color:var(--text-secondary);width:32px;height:32px;border-radius:6px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.close-btn:hover{background:var(--bg-card-alt);color:var(--text-primary)}
.detail-modal-body{padding:20px 24px}
.detail-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px}
.detail-stat{background:var(--bg-card-alt);border-radius:8px;padding:12px}
.detail-stat .label{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}
.detail-stat .value{font-size:18px;font-weight:700;font-family:var(--font-mono);margin-top:4px}
.section-label{font-size:12px;font-weight:600;color:var(--accent-cyan);text-transform:uppercase;letter-spacing:.5px;margin:16px 0 8px}
.export-btn{background:var(--bg-card-alt);border:1px solid var(--border);color:var(--accent-green);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:6px;margin-top:12px;transition:all .15s}
.export-btn:hover{background:rgba(52,211,153,.1)}
.data-note{background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);border-radius:8px;padding:12px 16px;margin-bottom:20px;font-size:12px;color:var(--accent-yellow);line-height:1.5}
.footer{text-align:center;padding:24px;margin-top:40px;border-top:1px solid var(--border);color:var(--text-muted);font-size:11px}
.footer span{color:var(--accent-cyan)}
@media(max-width:900px){.chart-grid{grid-template-columns:1fr}.header{flex-direction:column}}
</style>
</head>
<body>
<div class="password-overlay" id="pwOverlay">
  <h1>CTL Warranty Board Report</h1><p>Enter password to access the dashboard</p>
  <input type="password" id="pwInput" placeholder="Password" onkeydown="if(event.key==='Enter')checkPassword()">
  <button onclick="checkPassword()">Access Dashboard</button>
  <div class="pw-error" id="pwError"></div>
</div>
<div class="loading-overlay hidden" id="loadingOverlay"><div class="spinner"></div><p id="loadingMsg">Fetching warranty data...</p></div>
<div class="detail-modal-overlay" id="detailOverlay" onclick="if(event.target===this)closeDetailModal()">
  <div class="detail-modal"><div class="detail-modal-header"><h3 id="detailTitle">Detail</h3><button class="close-btn" onclick="closeDetailModal()">&times;</button></div><div class="detail-modal-body" id="detailBody"></div></div>
</div>
<div class="dashboard hidden" id="dashboard">
  <div class="header">
    <div class="header-left">
      <h1>CTL Warranty Board Report</h1>
      <div class="subtitle">Data Analysis Dashboard &mdash; <span>Board & Leadership Review</span></div>
      <div class="subtitle" style="margin-top:2px">Repairs filtered by date range &bull; Unit sales use full history for accurate rates</div>
    </div>
    <div class="header-right">
      <div><label>Repairs From</label><br><input type="date" id="startDate" value="2023-01-01"></div>
      <div><label>Repairs To</label><br><input type="date" id="endDate" value="2025-12-31"></div>
      <button class="btn btn-primary" onclick="applyDateFilter()">Apply</button>
      <button class="btn btn-secondary" onclick="refreshData()">Refresh</button>
      <div class="date-range-label" id="dateLabel"></div>
    </div>
  </div>
  <div class="kpi-row" id="kpiRow"></div>

  <div class="section-header"><h2>Warranties Sold &amp; Revenue</h2><span class="badge badge-blue">Sales Overview</span></div>
  <div class="chart-grid">
    <div class="chart-card" data-clickable><h3>Warranty Units Sold by Year</h3><div class="chart-subtitle">Full history â€” not filtered by repair date range</div><canvas id="chartSoldByYear"></canvas></div>
    <div class="chart-card" data-clickable><h3>Warranty Revenue by Year</h3><div class="chart-subtitle">Full history â€” not filtered by repair date range</div><canvas id="chartRevByYear"></canvas></div>
  </div>

  <div class="section-header"><h2>Claim Frequency &amp; Severity</h2><span class="badge badge-yellow">Claims Analysis</span></div>
  <div class="chart-grid">
    <div class="chart-card" data-clickable><h3>Claim Frequency by Warranty Code</h3><div class="chart-subtitle">Number of claims per warranty program</div><canvas id="chartClaimFreq"></canvas></div>
    <div class="chart-card" data-clickable><h3>Claim Severity: Repair Type Breakdown</h3><div class="chart-subtitle">Major vs Minor vs NPU/NPF</div><canvas id="chartSeverity"></canvas></div>
  </div>

  <div class="section-header"><h2>Breakage Rate Trends</h2><span class="badge badge-red">3-Year Trend</span></div>
  <div class="chart-grid">
    <div class="chart-card chart-full tall" data-clickable>
      <h3>Quarterly Repair Count Trends â€” Top Models</h3>
      <div class="chart-subtitle">Repair volume per quarter for top CTL units (click a point for model detail)</div>
      <canvas id="chartBreakageTrends"></canvas>
    </div>
  </div>

  <div class="section-header"><h2>Warranty Cost Distribution</h2><span class="badge badge-purple">Distribution Analysis</span></div>
  <div class="chart-grid">
    <div class="chart-card chart-full" data-clickable>
      <h3>Distribution of Avg Repair Cost per Warranty Code</h3>
      <div class="chart-subtitle">Click any bar to see the warranty codes in that cost range. Green dashed line = avg revenue per warranty.</div>
      <canvas id="chartCostDistribution"></canvas>
    </div>
  </div>

  <div class="section-header"><h2>Cost Trends: Parts &amp; Labor</h2><span class="badge badge-green">Cost Tracking</span></div>
  <div class="data-note"><strong>Note:</strong> Parts vs. Labor split is estimated by repair type classification. Actual breakdowns are not in the source data.</div>
  <div class="chart-grid">
    <div class="chart-card" data-clickable><h3>Parts Cost Trend by Quarter</h3><div class="chart-subtitle">Estimated parts cost over time</div><canvas id="chartPartsTrend"></canvas></div>
    <div class="chart-card" data-clickable><h3>Labor Cost Trend by Quarter</h3><div class="chart-subtitle">Estimated labor/diagnostic cost over time</div><canvas id="chartLaborTrend"></canvas></div>
  </div>

  <div class="section-header"><h2>Claims vs. Product Age in Field</h2><span class="badge badge-blue">Field Analysis</span></div>
  <div class="chart-grid">
    <div class="chart-card chart-full tall" data-clickable>
      <h3>Warranty Claims by Length of Product in Field â€” Top CTL Models</h3>
      <div class="chart-subtitle">Hover highlights the specific model line. Click a point for full model detail.</div>
      <canvas id="chartProductInField"></canvas>
    </div>
  </div>

  <div class="section-header"><h2>Key Insights</h2><span class="badge badge-green">Auto-Generated</span></div>
  <div class="insight-grid" id="insightGrid"></div>

  <div class="data-table-container"><h3>Top Models Summary</h3>
    <table><thead><tr><th>Model</th><th>Units Sold</th><th>Repairs</th><th>Repair Rate</th><th>Warranty Rev</th><th>Total Cost</th><th>Net P/L</th><th>Trend</th></tr></thead><tbody id="summaryBody"></tbody></table>
  </div>

  <div class="footer">CTL Warranty Board Report &bull; <span>Live from Google Sheets</span><br>All models with repairs shown &bull; Sales use full history &bull; Repairs filtered by date</div>
</div>

<script>
const PASSWORD='CTLdata2026',SHIPPING=10;
const REPAIR_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vS9yLbvcLU16R73aNEIqwAVzJwz82UghVY5buEK5uuX9LHojAE9JoQoJ00-uuR2KzXTL-e6AwepOlFq/pub?gid=986703446&single=true&output=csv';
const SALES_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vS9yLbvcLU16R73aNEIqwAVzJwz82UghVY5buEK5uuX9LHojAE9JoQoJ00-uuR2KzXTL-e6AwepOlFq/pub?gid=235319241&single=true&output=csv';
const EST_COSTS={'AC Adapter':50,Accidental:100,Battery:100,Camera:50,Daughterboard:50,'DC Port':50,Declined:50,'Headphone Port':50,Hinge:50,'Hinge Cover':50,Keyboard:50,'Keyboard Keys':50,'LTE Module':50,LVDS:50,Mainboard:100,NPF:20,NPU:20,'OS Issue':50,Other:50,Panel:100,Plastics:50,'Please Select':20,Replacement:100,Storage:100,'Tear Down':50,Touchpad:50,'USB Port':50,'USB-C Port':50,'Wifi Module':50};
const PARTS=new Set(['Panel','Mainboard','Battery','Storage','Keyboard','Keyboard Keys','Daughterboard','Camera','LTE Module','LVDS','AC Adapter','Wifi Module','Touchpad','DC Port','USB Port','USB-C Port','Headphone Port','Hinge','Hinge Cover','Plastics','Replacement','Accidental']);
const CC=['#22d3ee','#4aa3df','#a78bfa','#f472b6','#fbbf24','#34d399','#f97316','#ef4444','#818cf8','#2dd4bf','#fb923c','#c084fc'];
let rawR=null,rawS=null,allMD=[],sLookup={},charts=[];
let _codeAgg={},_qAgg={},_bins=[],_codeCosts=[];

const fmt=n=>n==null?'N/A':n.toLocaleString('en-US');
const fmtD=n=>n==null?'N/A':'$'+Math.round(n).toLocaleString('en-US');
const fmtP=n=>n==null?'N/A':n.toFixed(2)+'%';
function trend(v){const f=v.filter(x=>x!=null);if(f.length<2)return{t:'N/A',c:'flat'};const a=f[0],b=f[f.length-1];if(!a&&!b)return{t:'FLAT',c:'flat'};if(!a)return{t:'â†‘ UP',c:'up'};const p=((b-a)/Math.abs(a))*100;if(p>10)return{t:`â†‘ +${p.toFixed(0)}%`,c:'up'};if(p<-10)return{t:`â†“ ${p.toFixed(0)}%`,c:'down'};return{t:'â†’ FLAT',c:'flat'};}

function checkPassword(){if(document.getElementById('pwInput').value===PASSWORD){document.getElementById('pwOverlay').classList.add('hidden');document.getElementById('loadingOverlay').classList.remove('hidden');fetchAll();}else document.getElementById('pwError').textContent='Incorrect password';}
function fetchAll(){
  document.getElementById('loadingMsg').textContent='Fetching repair data...';
  let rd=false,sd=false;
  Papa.parse(REPAIR_URL,{download:true,header:true,skipEmptyLines:true,complete:r=>{rawR=r.data;rd=true;document.getElementById('loadingMsg').textContent='Fetching sales data...';if(sd)go();},error:e=>{document.getElementById('loadingMsg').textContent='Error: repair â€” '+(e.message||JSON.stringify(e));}});
  Papa.parse(SALES_URL,{download:true,header:true,skipEmptyLines:true,complete:r=>{rawS=r.data;sd=true;if(rd)go();},error:e=>{document.getElementById('loadingMsg').textContent='Error: sales â€” '+(e.message||JSON.stringify(e));}});
}
function refreshData(){document.getElementById('loadingOverlay').classList.remove('hidden');rawR=rawS=null;fetchAll();}
function applyDateFilter(){if(rawR&&rawS){document.getElementById('loadingOverlay').classList.remove('hidden');document.getElementById('loadingMsg').textContent='Reprocessing...';setTimeout(go,50);}}

function getDR(){const s=document.getElementById('startDate').value,e=document.getElementById('endDate').value;const[sy,sm,sd]=s.split('-').map(Number),[ey,em,ed]=e.split('-').map(Number);return{start:new Date(sy,sm-1,sd),end:new Date(ey,em-1,ed,23,59,59),sy,ey};}
function pDate(s){if(!s)return null;const d=new Date(s);if(isNaN(d))return null;return new Date(d.getFullYear(),d.getMonth(),d.getDate());}
function qLabel(d){return`${d.getFullYear()} Q${Math.floor(d.getMonth()/3)+1}`;}

function buildSL(data){
  const L={};
  data.forEach(r=>{
    const it=(r['Item No']||'').trim(),co=(r['Warranty Code']||'').trim(),yr=(r['Year']||'').trim();
    const qt=parseFloat(r['Total Sales Qty'])||0,pr=parseFloat((r['Price']||'').replace(/[$,]/g,''))||0;
    let rv=parseFloat((r['Total Sales']||'').replace(/[$,]/g,''))||0;
    if(!rv&&qt&&pr)rv=qt*pr;
    if(!it||!co)return;
    if(!L[it])L[it]={_byYr:{},_total:0};
    if(!L[it][co])L[it][co]={qty:0,price:pr,rev:0,byYr:{}};
    L[it][co].qty+=qt;L[it][co].rev+=rv;L[it]._total+=qt;
    if(yr){if(!L[it][co].byYr[yr])L[it][co].byYr[yr]={qty:0,rev:0};L[it][co].byYr[yr].qty+=qt;L[it][co].byYr[yr].rev+=rv;L[it]._byYr[yr]=(L[it]._byYr[yr]||0)+qt;}
  });
  return L;
}

function go(){
  const{start,end,sy,ey}=getDR();
  sLookup=buildSL(rawS);
  const filt=rawR.filter(r=>{const m=(r['Model Name']||'').trim(),it=(r['Item Number']||'').trim(),ds=(r['Order Received Date']||'').trim();if(!ds||!m||m==='No Match'||!it||it==='No Match')return false;const d=pDate(ds);return d&&d>=start&&d<=end;});
  const grp={};filt.forEach(r=>{const it=(r['Item Number']||'').trim();if(!grp[it])grp[it]=[];grp[it].push(r);});
  allMD=[];
  Object.entries(grp).forEach(([itemN,rows])=>{
    const model=rows[0]['Model Name'].trim();
    let tot=rows.length,maj=0,min=0,npu=0,acc=0,aCost=0,eCost=0,rRev=0,inW=0,outW=0;
    const yR={},rTC={},qD={},wCR={};
    rows.forEach(r=>{
      const rep=(r['Repair']||'').trim(),isMaj=(r['Major Repairs']||'').trim().toLowerCase()==='yes',isNPU=/npu|npf/i.test(rep);
      const isAcc=['yes','liquid'].includes((r['Accidental Damage']||'').trim().toLowerCase());
      const cost=(parseFloat(r['Costs'])||0)+SHIPPING,est=EST_COSTS[rep]||50,rev=parseFloat(r['Repair Revenue'])||0;
      const ws=(r['Warranty Status']||'').trim(),wc=(r['Warranty Code']||'').trim();
      const d=pDate(r['Order Received Date']),yr=d?d.getFullYear().toString():'?',qt=d?qLabel(d):'?';
      if(isNPU)npu++;else if(isMaj)maj++;else min++;
      if(isAcc)acc++;aCost+=cost;eCost+=est;rRev+=rev;
      if(ws==='In Warranty')inW++;else if(ws==='Out of Warranty')outW++;
      rTC[rep]=(rTC[rep]||0)+1;
      if(!yR[yr])yR[yr]={rep:0,cost:0,est:0,rRev:0,maj:0,min:0,npu:0,acc:0,inW:0,outW:0};
      const y=yR[yr];y.rep++;y.cost+=cost;y.est+=est;y.rRev+=rev;if(isNPU)y.npu++;else if(isMaj)y.maj++;else y.min++;if(isAcc)y.acc++;if(ws==='In Warranty')y.inW++;else if(ws==='Out of Warranty')y.outW++;
      if(!qD[qt])qD[qt]={rep:0,pC:0,lC:0,tC:0,pR:0,lR:0};const q=qD[qt];q.rep++;q.tC+=cost;if(PARTS.has(rep)){q.pC+=cost;q.pR++;}else{q.lC+=cost;q.lR++;}
      if(wc){if(!wCR[wc])wCR[wc]={cnt:0,cost:0,est:0};wCR[wc].cnt++;wCR[wc].cost+=cost;wCR[wc].est+=est;}
    });
    let sold=0,wRev=0;const yS={},yWR={};const iS=sLookup[itemN];
    if(iS){sold=iS._total||0;Object.entries(iS._byYr||{}).forEach(([yr,q])=>{yS[yr]=q;});
      Object.entries(iS).forEach(([co,sd])=>{if(co.startsWith('_'))return;Object.entries(sd.byYr||{}).forEach(([yr,yd])=>{yWR[yr]=(yWR[yr]||0)+yd.rev;});wRev+=sd.rev;
        if(!wCR[co])wCR[co]={cnt:0,cost:0,est:0};wCR[co].qS=sd.qty;wCR[co].wR=sd.rev;wCR[co].uP=sd.price;});
    }
    const rr=sold>0?(tot/sold*100):null,nPL=wRev+rRev-aCost;
    const sn=model.replace(/^CTL Chromebook /i,'').replace(/^CTL /i,'').substring(0,30);
    let eY=null;Object.keys(yS).forEach(yr=>{const y=parseInt(yr);if(!eY||y<eY)eY=y;});
    const mR={};if(eY)rows.forEach(r=>{const d=pDate(r['Order Received Date']);if(!d)return;const mo=(d.getFullYear()-eY)*12+d.getMonth();if(mo>=0)mR[mo]=(mR[mo]||0)+1;});
    allMD.push({model,itemNumber:itemN,shortName:sn,total:tot,major:maj,minor:min,npu,accidental:acc,actualCost:aCost,estimatedCost:eCost,repairRevenue:rRev,inWarranty:inW,outWarranty:outW,sold,warrantyRevenue:wRev,repairRate:rr,netPL:nPL,yearlyRepairs:yR,yearlySold:yS,yearlyWarrantyRevenue:yWR,quarterlyData:qD,repairTypeCounts:rTC,warrantyCodeRepairs:wCR,monthlyRepairs:mR,earliestSaleYear:eY});
  });
  allMD.sort((a,b)=>b.total-a.total);
  document.getElementById('dateLabel').textContent=`Repairs: ${document.getElementById('startDate').value} â€” ${document.getElementById('endDate').value} | Sales: All Years`;
  render();document.getElementById('loadingOverlay').classList.add('hidden');document.getElementById('dashboard').classList.remove('hidden');
}

function openDM(title,html){document.getElementById('detailTitle').textContent=title;document.getElementById('detailBody').innerHTML=html;document.getElementById('detailOverlay').classList.add('active');}
function closeDetailModal(){document.getElementById('detailOverlay').classList.remove('active');}
function exportCSV(tid){const t=document.getElementById(tid);if(!t)return;const rows=[];t.querySelectorAll('tr').forEach(tr=>{const c=Array.from(tr.querySelectorAll('th,td')).map(c=>'"'+c.textContent.replace(/"/g,'""').trim()+'"');if(c.length)rows.push(c.join(','));});const b=new Blob(['\ufeff'+rows.join('\n')],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='export.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);}

function modelHTML(m){
  const tR=Object.entries(m.repairTypeCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const wC=Object.entries(m.warrantyCodeRepairs).filter(([c])=>c).sort((a,b)=>(b[1].cnt||0)-(a[1].cnt||0));
  let h=`<div class="detail-stats">
    <div class="detail-stat"><div class="label">Units Sold</div><div class="value">${fmt(m.sold)}</div></div>
    <div class="detail-stat"><div class="label">Repairs</div><div class="value">${fmt(m.total)}</div></div>
    <div class="detail-stat"><div class="label">Repair Rate</div><div class="value">${m.repairRate!=null?fmtP(m.repairRate):'N/A'}</div></div>
    <div class="detail-stat"><div class="label">Total Cost</div><div class="value">${fmtD(m.actualCost)}</div></div>
    <div class="detail-stat"><div class="label">Warranty Rev</div><div class="value">${fmtD(m.warrantyRevenue)}</div></div>
    <div class="detail-stat"><div class="label">Net P/L</div><div class="value" style="color:${m.netPL>=0?'var(--positive)':'var(--negative)'}">${fmtD(m.netPL)}</div></div>
    <div class="detail-stat"><div class="label">Maj / Min / NPU</div><div class="value" style="font-size:14px">${fmt(m.major)} / ${fmt(m.minor)} / ${fmt(m.npu)}</div></div>
    <div class="detail-stat"><div class="label">Accidental %</div><div class="value">${m.total>0?fmtP(m.accidental/m.total*100):'N/A'}</div></div>
  </div>`;
  h+=`<div class="section-label">Top Repair Types</div><table id="dtR"><thead><tr><th>Repair</th><th>Count</th><th>%</th></tr></thead><tbody>`;
  tR.forEach(([r,c])=>{h+=`<tr><td>${r}</td><td class="mono">${fmt(c)}</td><td class="mono">${fmtP(c/m.total*100)}</td></tr>`;});h+=`</tbody></table>`;
  if(wC.length){h+=`<div class="section-label">Warranty Codes</div><table><thead><tr><th>Code</th><th>Repairs</th><th>Sold</th><th>Cost</th><th>Revenue</th></tr></thead><tbody>`;
    wC.forEach(([c,d])=>{h+=`<tr><td>${c}</td><td class="mono">${fmt(d.cnt)}</td><td class="mono">${fmt(d.qS||0)}</td><td class="mono">${fmtD(d.cost)}</td><td class="mono">${fmtD(d.wR||0)}</td></tr>`;});h+=`</tbody></table>`;}
  const yrs=Object.keys(m.yearlyRepairs).sort();
  if(yrs.length){h+=`<div class="section-label">Year-by-Year</div><table><thead><tr><th>Year</th><th>Repairs</th><th>Major</th><th>Minor</th><th>NPU</th><th>Cost</th><th>Sold</th></tr></thead><tbody>`;
    yrs.forEach(yr=>{const d=m.yearlyRepairs[yr];h+=`<tr><td>${yr}</td><td class="mono">${fmt(d.rep)}</td><td class="mono">${fmt(d.maj)}</td><td class="mono">${fmt(d.min)}</td><td class="mono">${fmt(d.npu)}</td><td class="mono">${fmtD(d.cost)}</td><td class="mono">${fmt(m.yearlySold[yr]||0)}</td></tr>`;});h+=`</tbody></table>`;}
  h+=`<button class="export-btn" onclick="exportCSV('dtR')">ðŸ“¥ Export CSV</button>`;return h;
}

function destroyCharts(){charts.forEach(c=>{try{c.destroy();}catch(e){}});charts=[];}

function render(){
  destroyCharts();const{sy,ey}=getDR();
  const aYrs=new Set();allMD.forEach(m=>{Object.keys(m.yearlySold).forEach(y=>aYrs.add(y));Object.keys(m.yearlyRepairs).forEach(y=>aYrs.add(y));});
  const salesYrs=[...aYrs].sort();const rYrs=[...new Set([...allMD.flatMap(m=>Object.keys(m.yearlyRepairs))])].sort();
  let tSold=0,tRep=0,tCost=0,tEst=0,tAcc=0,tInW=0,tOutW=0,tWRev=0,tRRev=0;
  const ytS={},ytR={},ytC={},ytWR={};
  allMD.forEach(m=>{tSold+=m.sold;tRep+=m.total;tCost+=m.actualCost;tEst+=m.estimatedCost;tAcc+=m.accidental;tInW+=m.inWarranty;tOutW+=m.outWarranty;tWRev+=m.warrantyRevenue;tRRev+=m.repairRevenue;
    Object.entries(m.yearlySold).forEach(([y,q])=>{ytS[y]=(ytS[y]||0)+q;});Object.entries(m.yearlyRepairs).forEach(([y,d])=>{ytR[y]=(ytR[y]||0)+d.rep;ytC[y]=(ytC[y]||0)+d.cost;});Object.entries(m.yearlyWarrantyRevenue).forEach(([y,r])=>{ytWR[y]=(ytWR[y]||0)+r;});});
  const oRate=tSold>0?(tRep/tSold*100):null,accP=tRep>0?(tAcc/tRep*100):0,inWP=(tInW+tOutW)>0?(tInW/(tInW+tOutW)*100):0,nPL=tWRev+tRRev-tCost;
  document.getElementById('kpiRow').innerHTML=`
    <div class="kpi-card cyan"><div class="kpi-label">Units Sold (All Years)</div><div class="kpi-value">${fmt(tSold)}</div></div>
    <div class="kpi-card yellow"><div class="kpi-label">Total Repairs</div><div class="kpi-value">${fmt(tRep)}</div><div class="kpi-sub">${sy}â€“${ey}</div></div>
    <div class="kpi-card red"><div class="kpi-label">Repair Rate</div><div class="kpi-value">${oRate!=null?fmtP(oRate):'N/A'}</div></div>
    <div class="kpi-card orange"><div class="kpi-label">Repair Cost</div><div class="kpi-value">${fmtD(tCost)}</div><div class="kpi-sub">Est: ${fmtD(tEst)}</div></div>
    <div class="kpi-card purple"><div class="kpi-label">Accidental %</div><div class="kpi-value">${fmtP(accP)}</div></div>
    <div class="kpi-card green"><div class="kpi-label">In Warranty %</div><div class="kpi-value">${fmtP(inWP)}</div></div>
    <div class="kpi-card blue"><div class="kpi-label">Warranty Revenue</div><div class="kpi-value">${fmtD(tWRev)}</div></div>
    <div class="kpi-card ${nPL>=0?'green':'red'}"><div class="kpi-label">Net P/L</div><div class="kpi-value" style="color:${nPL>=0?'var(--positive)':'var(--negative)'}">${fmtD(nPL)}</div></div>`;

  // Chart 1: Sold by Year
  charts.push(new Chart(document.getElementById('chartSoldByYear'),{type:'bar',data:{labels:salesYrs,datasets:[{label:'Units Sold',data:salesYrs.map(y=>ytS[y]||0),backgroundColor:salesYrs.map((_,i)=>CC[i%CC.length]),borderRadius:6,barPercentage:.6}]},options:{responsive:true,onClick:(e,el)=>{if(el.length)showYrDet(salesYrs[el[0].index],'sold');},plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmt(c.raw)+' units'}}},scales:{y:{ticks:{color:'#8899b0',callback:v=>fmt(v)},grid:{color:'#1e3050'}},x:{ticks:{color:'#8899b0'},grid:{display:false}}}}}));

  // Chart 2: Revenue by Year
  charts.push(new Chart(document.getElementById('chartRevByYear'),{type:'bar',data:{labels:salesYrs,datasets:[{label:'Revenue',data:salesYrs.map(y=>ytWR[y]||0),backgroundColor:salesYrs.map((_,i)=>CC[(i+3)%CC.length]),borderRadius:6,barPercentage:.6}]},options:{responsive:true,onClick:(e,el)=>{if(el.length)showYrDet(salesYrs[el[0].index],'rev');},plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmtD(c.raw)}}},scales:{y:{ticks:{color:'#8899b0',callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'#1e3050'}},x:{ticks:{color:'#8899b0'},grid:{display:false}}}}}));

  // Chart 3: Claim Freq
  _codeAgg={};allMD.forEach(m=>{Object.entries(m.warrantyCodeRepairs).forEach(([c,d])=>{if(!_codeAgg[c])_codeAgg[c]={cnt:0,cost:0,qS:0,wR:0,models:[]};_codeAgg[c].cnt+=d.cnt||0;_codeAgg[c].cost+=d.cost||0;_codeAgg[c].qS+=d.qS||0;_codeAgg[c].wR+=d.wR||0;if(d.cnt>0)_codeAgg[c].models.push({n:m.shortName,cnt:d.cnt,cost:d.cost});});});
  const tCodes=Object.entries(_codeAgg).filter(([c])=>c).sort((a,b)=>b[1].cnt-a[1].cnt).slice(0,15);
  charts.push(new Chart(document.getElementById('chartClaimFreq'),{type:'bar',data:{labels:tCodes.map(([c])=>c),datasets:[{label:'Claims',data:tCodes.map(([,d])=>d.cnt),backgroundColor:tCodes.map((_,i)=>CC[i%CC.length]),borderRadius:4}]},options:{indexAxis:'y',responsive:true,onClick:(e,el)=>{if(el.length)showCodeDet(tCodes[el[0].index][0]);},plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#8899b0'},grid:{color:'#1e3050'}},y:{ticks:{color:'#8899b0',font:{size:10,family:'Space Mono'}},grid:{display:false}}}}}));

  // Chart 4: Severity
  let tMaj=0,tMin=0,tNPU=0;allMD.forEach(m=>{tMaj+=m.major;tMin+=m.minor;tNPU+=m.npu;});
  charts.push(new Chart(document.getElementById('chartSeverity'),{type:'doughnut',data:{labels:['Major','Minor','NPU/NPF'],datasets:[{data:[tMaj,tMin,tNPU],backgroundColor:['#ef4444','#fbbf24','#4aa3df'],borderWidth:0}]},options:{responsive:true,cutout:'55%',onClick:(e,el)=>{if(el.length)showSevDet(['Major','Minor','NPU/NPF'][el[0].index]);},plugins:{legend:{position:'bottom',labels:{color:'#8899b0',padding:16}},tooltip:{callbacks:{label:c=>c.label+': '+fmt(c.raw)+' ('+((c.raw/tRep)*100).toFixed(1)+'%)'}}}}}));

  // Chart 5: Breakage Trends (COUNTS, not rates)
  const topR=allMD.filter(m=>m.sold>0).sort((a,b)=>b.total-a.total).slice(0,10);
  const aQ=new Set();topR.forEach(m=>Object.keys(m.quarterlyData).forEach(q=>aQ.add(q)));
  for(let yr=sy;yr<=ey;yr++)for(let q=1;q<=4;q++)aQ.add(`${yr} Q${q}`);
  const sQ=[...aQ].sort();
  const tDS=topR.map((m,i)=>({label:m.shortName,data:sQ.map(q=>m.quarterlyData[q]?.rep||0),borderColor:CC[i%CC.length],backgroundColor:CC[i%CC.length]+'20',tension:.3,pointRadius:3,pointHoverRadius:6,borderWidth:2.5,fill:false}));
  charts.push(new Chart(document.getElementById('chartBreakageTrends'),{type:'line',data:{labels:sQ,datasets:tDS},options:{responsive:true,interaction:{mode:'index',intersect:false},onClick:(e,el)=>{if(el.length){const m=topR[el[0].datasetIndex];if(m)openDM(m.model,modelHTML(m));}},plugins:{legend:{position:'bottom',labels:{color:'#8899b0',padding:12,font:{size:11,family:'Space Mono'},usePointStyle:true,pointStyle:'circle'}},tooltip:{callbacks:{label:c=>c.dataset.label+': '+c.raw+' repairs'}}},scales:{y:{title:{display:true,text:'Repairs per Quarter',color:'#8899b0'},ticks:{color:'#8899b0'},grid:{color:'#1e3050'}},x:{ticks:{color:'#8899b0',font:{size:10},maxRotation:45},grid:{color:'#1e305030'}}}}}));

  // Chart 6: Cost Distribution
  _codeCosts=[];Object.entries(_codeAgg).forEach(([c,d])=>{if(d.cnt>0)_codeCosts.push({code:c,avgC:d.cost/d.cnt,avgR:d.qS>0?d.wR/d.qS:0,cnt:d.cnt,qS:d.qS,wR:d.wR});});
  _codeCosts.sort((a,b)=>a.avgC-b.avgC);
  const cVals=_codeCosts.map(c=>c.avgC),mnC=Math.min(...cVals,0),mxC=Math.max(...cVals,200),bs=20;
  _bins=[];for(let b=Math.floor(mnC/bs)*bs;b<=mxC+bs;b+=bs)_bins.push({min:b,max:b+bs,label:`$${b}-${b+bs}`,codes:[],n:0});
  _codeCosts.forEach(c=>{const bin=_bins.find(b=>c.avgC>=b.min&&c.avgC<b.max);if(bin){bin.codes.push(c);bin.n++;}});
  const oAvgR=Object.values(_codeAgg).reduce((s,d)=>s+(d.wR||0),0)/Math.max(Object.values(_codeAgg).reduce((s,d)=>s+(d.qS||0),0),1);
  charts.push(new Chart(document.getElementById('chartCostDistribution'),{type:'bar',data:{labels:_bins.map(b=>b.label),datasets:[{type:'bar',label:'Warranty Codes',data:_bins.map(b=>b.n),backgroundColor:'rgba(167,139,250,.5)',borderColor:'#a78bfa',borderWidth:1,borderRadius:4,yAxisID:'y'},{type:'line',label:`Avg Rev/Warranty: ${fmtD(oAvgR)}`,data:_bins.map(()=>oAvgR),borderColor:'#34d399',borderWidth:2.5,borderDash:[8,4],pointRadius:0,fill:false,yAxisID:'y1'}]},options:{responsive:true,onClick:(e,el)=>{if(el.length&&el[0].datasetIndex===0){const b=_bins[el[0].index];if(b)showBinDet(b);}},plugins:{legend:{position:'bottom',labels:{color:'#8899b0',padding:16}},tooltip:{callbacks:{label:c=>{if(c.datasetIndex===0)return c.raw+' warranty codes';return'Avg Revenue: '+fmtD(c.raw);}}}},scales:{y:{title:{display:true,text:'# Warranty Codes',color:'#8899b0'},ticks:{color:'#8899b0'},grid:{color:'#1e3050'}},y1:{position:'right',title:{display:true,text:'Revenue ($)',color:'#34d399'},ticks:{color:'#34d399',callback:v=>'$'+v.toFixed(0)},grid:{display:false},min:0},x:{ticks:{color:'#8899b0',font:{size:10},maxRotation:45},grid:{display:false}}}}}));

  // Charts 7&8: Parts & Labor
  _qAgg={};allMD.forEach(m=>{Object.entries(m.quarterlyData).forEach(([q,d])=>{if(!_qAgg[q])_qAgg[q]={pC:0,lC:0,tC:0,pR:0,lR:0,tR:0};const a=_qAgg[q];a.pC+=d.pC;a.lC+=d.lC;a.tC+=d.tC;a.pR+=d.pR;a.lR+=d.lR;a.tR+=d.rep;});});
  for(let yr=sy;yr<=ey;yr++)for(let q=1;q<=4;q++){const k=`${yr} Q${q}`;if(!_qAgg[k])_qAgg[k]={pC:0,lC:0,tC:0,pR:0,lR:0,tR:0};}
  const sQA=Object.keys(_qAgg).sort();
  charts.push(new Chart(document.getElementById('chartPartsTrend'),{type:'line',data:{labels:sQA,datasets:[{label:'Total Parts Cost',data:sQA.map(q=>_qAgg[q].pC),borderColor:'#f97316',backgroundColor:'#f9731620',fill:true,tension:.3,borderWidth:2.5,pointRadius:4,yAxisID:'y'},{label:'Avg/Parts Repair',data:sQA.map(q=>{const d=_qAgg[q];return d.pR>0?Math.round(d.pC/d.pR):null;}),borderColor:'#fbbf24',backgroundColor:'transparent',borderDash:[6,3],tension:.3,borderWidth:2,pointRadius:3,yAxisID:'y1'}]},options:{responsive:true,interaction:{mode:'index',intersect:false},onClick:(e,el)=>{if(el.length)showQDet(sQA[el[0].index],'parts');},plugins:{legend:{position:'bottom',labels:{color:'#8899b0',padding:12,usePointStyle:true}},tooltip:{callbacks:{label:c=>c.dataset.label+': '+fmtD(c.raw)}}},scales:{y:{title:{display:true,text:'Total Cost',color:'#f97316'},ticks:{color:'#f97316',callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'#1e3050'}},y1:{position:'right',title:{display:true,text:'Avg/Repair',color:'#fbbf24'},ticks:{color:'#fbbf24',callback:v=>'$'+v},grid:{display:false}},x:{ticks:{color:'#8899b0',font:{size:10},maxRotation:45},grid:{display:false}}}}}));

  charts.push(new Chart(document.getElementById('chartLaborTrend'),{type:'line',data:{labels:sQA,datasets:[{label:'Total Labor Cost',data:sQA.map(q=>_qAgg[q].lC),borderColor:'#a78bfa',backgroundColor:'#a78bfa20',fill:true,tension:.3,borderWidth:2.5,pointRadius:4,yAxisID:'y'},{label:'Avg/Labor Repair',data:sQA.map(q=>{const d=_qAgg[q];return d.lR>0?Math.round(d.lC/d.lR):null;}),borderColor:'#f472b6',backgroundColor:'transparent',borderDash:[6,3],tension:.3,borderWidth:2,pointRadius:3,yAxisID:'y1'}]},options:{responsive:true,interaction:{mode:'index',intersect:false},onClick:(e,el)=>{if(el.length)showQDet(sQA[el[0].index],'labor');},plugins:{legend:{position:'bottom',labels:{color:'#8899b0',padding:12,usePointStyle:true}},tooltip:{callbacks:{label:c=>c.dataset.label+': '+fmtD(c.raw)}}},scales:{y:{title:{display:true,text:'Total Cost',color:'#a78bfa'},ticks:{color:'#a78bfa',callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'#1e3050'}},y1:{position:'right',title:{display:true,text:'Avg/Repair',color:'#f472b6'},ticks:{color:'#f472b6',callback:v=>'$'+v},grid:{display:false}},x:{ticks:{color:'#8899b0',font:{size:10},maxRotation:45},grid:{display:false}}}}}));

  // Chart 9: Product in Field with HIGHLIGHT
  const topS=allMD.filter(m=>m.sold>100&&m.earliestSaleYear).sort((a,b)=>b.sold-a.sold).slice(0,10);
  let mxMo=0;topS.forEach(m=>Object.keys(m.monthlyRepairs).forEach(mo=>{mxMo=Math.max(mxMo,parseInt(mo));}));
  const bSz=3,bLbls=[];for(let i=0;i<=mxMo;i+=bSz)bLbls.push(`${i}-${i+bSz} mo`);
  const fDS=topS.map((m,i)=>({label:m.shortName,data:bLbls.map((_,idx)=>{let s=0;for(let mo=idx*bSz;mo<(idx+1)*bSz;mo++)s+=m.monthlyRepairs[mo]||0;return s||null;}),borderColor:CC[i%CC.length],backgroundColor:CC[i%CC.length]+'30',tension:.35,pointRadius:3,pointHoverRadius:7,borderWidth:2.5,fill:false,spanGaps:true}));

  const fieldChart=new Chart(document.getElementById('chartProductInField'),{type:'line',data:{labels:bLbls,datasets:fDS},options:{
    responsive:true,interaction:{mode:'index',intersect:false},
    onClick:(e,el)=>{if(el.length){const m=topS[el[0].datasetIndex];if(m)openDM(m.model,modelHTML(m));}},
    onHover:(evt,activeEls,chart)=>{
      if(activeEls.length>0){
        const hi=activeEls[0].datasetIndex;
        chart.data.datasets.forEach((ds,i)=>{ds.borderWidth=i===hi?5:1.5;ds.pointRadius=i===hi?6:1;ds.borderColor=CC[i%CC.length]+(i===hi?'':'44');});
      }else{chart.data.datasets.forEach((ds,i)=>{ds.borderWidth=2.5;ds.pointRadius=3;ds.borderColor=CC[i%CC.length];});}
      chart.update('none');
    },
    plugins:{legend:{position:'bottom',labels:{color:'#8899b0',padding:12,font:{size:11,family:'Space Mono'},usePointStyle:true,pointStyle:'circle'}},
      tooltip:{
        backgroundColor:'rgba(17,26,46,.95)',borderColor:'#2a5a8f',borderWidth:1,padding:12,
        titleFont:{size:13,weight:'bold'},bodyFont:{size:12,family:'Space Mono'},
        itemSort:(a,b)=>(b.raw||0)-(a.raw||0),
        callbacks:{
          label:c=>c.dataset.label+': '+(c.raw||0)+' claims',
          labelTextColor:c=>{const ae=c.chart.getActiveElements();if(ae.length>0){return c.datasetIndex===ae[0].datasetIndex?'#ffffff':'#555566';}return'#8899b0';}
        }
      }
    },
    scales:{y:{title:{display:true,text:'# Warranty Claims',color:'#8899b0'},ticks:{color:'#8899b0'},grid:{color:'#1e3050'}},x:{title:{display:true,text:'Months Since First Sale Year',color:'#8899b0'},ticks:{color:'#8899b0',font:{size:10},maxRotation:45},grid:{color:'#1e305030'}}}
  }});charts.push(fieldChart);

  renderInsights(rYrs);renderSummary();
}

// Detail modal builders
function showYrDet(yr,type){
  const ms=allMD.filter(m=>(type==='sold'?m.yearlySold[yr]:m.yearlyWarrantyRevenue[yr])).sort((a,b)=>(type==='sold'?(b.yearlySold[yr]||0)-(a.yearlySold[yr]||0):(b.yearlyWarrantyRevenue[yr]||0)-(a.yearlyWarrantyRevenue[yr]||0))).slice(0,25);
  const tot=type==='sold'?ms.reduce((s,m)=>s+(m.yearlySold[yr]||0),0):ms.reduce((s,m)=>s+(m.yearlyWarrantyRevenue[yr]||0),0);
  let h=`<div class="detail-stats"><div class="detail-stat"><div class="label">Year</div><div class="value">${yr}</div></div><div class="detail-stat"><div class="label">${type==='sold'?'Total Sold':'Total Revenue'}</div><div class="value">${type==='sold'?fmt(tot):fmtD(tot)}</div></div></div>`;
  h+=`<div class="section-label">Top Models</div><table id="dtY"><thead><tr><th>Model</th><th>${type==='sold'?'Units Sold':'Revenue'}</th><th>%</th></tr></thead><tbody>`;
  ms.forEach(m=>{const v=type==='sold'?(m.yearlySold[yr]||0):(m.yearlyWarrantyRevenue[yr]||0);h+=`<tr><td>${m.shortName}</td><td class="mono">${type==='sold'?fmt(v):fmtD(v)}</td><td class="mono">${tot>0?fmtP(v/tot*100):'â€”'}</td></tr>`;});
  h+=`</tbody></table><button class="export-btn" onclick="exportCSV('dtY')">ðŸ“¥ Export</button>`;
  openDM(`${yr} â€” ${type==='sold'?'Units Sold':'Revenue'}`,h);
}
function showCodeDet(code){
  const d=_codeAgg[code];if(!d)return;const ms=(d.models||[]).sort((a,b)=>b.cnt-a.cnt);
  let h=`<div class="detail-stats"><div class="detail-stat"><div class="label">Code</div><div class="value" style="font-size:16px">${code}</div></div><div class="detail-stat"><div class="label">Claims</div><div class="value">${fmt(d.cnt)}</div></div><div class="detail-stat"><div class="label">Cost</div><div class="value">${fmtD(d.cost)}</div></div><div class="detail-stat"><div class="label">Sold</div><div class="value">${fmt(d.qS)}</div></div><div class="detail-stat"><div class="label">Revenue</div><div class="value">${fmtD(d.wR)}</div></div><div class="detail-stat"><div class="label">Avg/Claim</div><div class="value">${d.cnt>0?fmtD(d.cost/d.cnt):'â€”'}</div></div></div>`;
  if(ms.length){h+=`<div class="section-label">Model Breakdown</div><table id="dtC"><thead><tr><th>Model</th><th>Claims</th><th>Cost</th><th>%</th></tr></thead><tbody>`;ms.forEach(m=>{h+=`<tr><td>${m.n}</td><td class="mono">${fmt(m.cnt)}</td><td class="mono">${fmtD(m.cost)}</td><td class="mono">${d.cnt>0?fmtP(m.cnt/d.cnt*100):'â€”'}</td></tr>`;});h+=`</tbody></table><button class="export-btn" onclick="exportCSV('dtC')">ðŸ“¥ Export</button>`;}
  openDM(`${code} â€” Detail`,h);
}
function showSevDet(type){
  let ms;if(type==='Major')ms=allMD.filter(m=>m.major>0).sort((a,b)=>b.major-a.major).slice(0,25);else if(type==='Minor')ms=allMD.filter(m=>m.minor>0).sort((a,b)=>b.minor-a.minor).slice(0,25);else ms=allMD.filter(m=>m.npu>0).sort((a,b)=>b.npu-a.npu).slice(0,25);
  const tot=type==='Major'?ms.reduce((s,m)=>s+m.major,0):type==='Minor'?ms.reduce((s,m)=>s+m.minor,0):ms.reduce((s,m)=>s+m.npu,0);
  let h=`<div class="detail-stats"><div class="detail-stat"><div class="label">${type} Repairs</div><div class="value">${fmt(tot)}</div></div><div class="detail-stat"><div class="label">Models</div><div class="value">${ms.length}</div></div></div>`;
  h+=`<div class="section-label">Top Models</div><table id="dtS"><thead><tr><th>Model</th><th>${type}</th><th>Total</th><th>%</th></tr></thead><tbody>`;
  ms.forEach(m=>{const c=type==='Major'?m.major:type==='Minor'?m.minor:m.npu;h+=`<tr><td>${m.shortName}</td><td class="mono">${fmt(c)}</td><td class="mono">${fmt(m.total)}</td><td class="mono">${fmtP(c/m.total*100)}</td></tr>`;});
  h+=`</tbody></table><button class="export-btn" onclick="exportCSV('dtS')">ðŸ“¥ Export</button>`;openDM(`${type} Repairs â€” Detail`,h);
}
function showBinDet(bin){
  let h=`<div class="detail-stats"><div class="detail-stat"><div class="label">Cost Range</div><div class="value" style="font-size:16px">${bin.label}</div></div><div class="detail-stat"><div class="label">Codes</div><div class="value">${bin.n}</div></div></div>`;
  if(bin.codes.length){h+=`<div class="section-label">Codes in Range</div><table id="dtB"><thead><tr><th>Code</th><th>Claims</th><th>Avg Cost</th><th>Sold</th><th>Revenue</th></tr></thead><tbody>`;
    bin.codes.sort((a,b)=>b.cnt-a.cnt).forEach(c=>{h+=`<tr><td>${c.code}</td><td class="mono">${fmt(c.cnt)}</td><td class="mono">${fmtD(c.avgC)}</td><td class="mono">${fmt(c.qS)}</td><td class="mono">${fmtD(c.wR)}</td></tr>`;});
    h+=`</tbody></table><button class="export-btn" onclick="exportCSV('dtB')">ðŸ“¥ Export</button>`;}
  openDM(`Cost Distribution: ${bin.label}`,h);
}
function showQDet(q,type){
  const d=_qAgg[q];if(!d)return;const lb=type==='parts'?'Parts':'Labor',tc=type==='parts'?d.pC:d.lC,tr=type==='parts'?d.pR:d.lR;
  const mb=[];allMD.forEach(m=>{const qd=m.quarterlyData[q];if(qd){const c=type==='parts'?qd.pC:qd.lC,r=type==='parts'?qd.pR:qd.lR;if(r>0)mb.push({n:m.shortName,c,r});}});mb.sort((a,b)=>b.c-a.c);
  let h=`<div class="detail-stats"><div class="detail-stat"><div class="label">Quarter</div><div class="value">${q}</div></div><div class="detail-stat"><div class="label">${lb} Cost</div><div class="value">${fmtD(tc)}</div></div><div class="detail-stat"><div class="label">${lb} Repairs</div><div class="value">${fmt(tr)}</div></div><div class="detail-stat"><div class="label">Avg</div><div class="value">${tr>0?fmtD(tc/tr):'â€”'}</div></div></div>`;
  h+=`<div class="section-label">Top Models</div><table id="dtQ"><thead><tr><th>Model</th><th>Repairs</th><th>Cost</th><th>Avg</th></tr></thead><tbody>`;
  mb.slice(0,20).forEach(m=>{h+=`<tr><td>${m.n}</td><td class="mono">${fmt(m.r)}</td><td class="mono">${fmtD(m.c)}</td><td class="mono">${fmtD(m.c/m.r)}</td></tr>`;});
  h+=`</tbody></table><button class="export-btn" onclick="exportCSV('dtQ')">ðŸ“¥ Export</button>`;openDM(`${q} â€” ${lb} Cost`,h);
}

function renderInsights(yrs){
  const g=document.getElementById('insightGrid');
  const rByY=yrs.map(y=>{let r=0;allMD.forEach(m=>{r+=m.yearlyRepairs[y]?.rep||0;});return r;});
  const rT=trend(rByY);const cByY=yrs.map(y=>{let c=0;allMD.forEach(m=>{c+=m.yearlyRepairs[y]?.cost||0;});return c;});const cT=trend(cByY);
  const hR=allMD.filter(m=>m.repairRate!=null).sort((a,b)=>b.repairRate-a.repairRate)[0];
  const lR=allMD.filter(m=>m.repairRate!=null&&m.sold>50).sort((a,b)=>a.repairRate-b.repairRate)[0];
  const hC=[...allMD].sort((a,b)=>b.actualCost-a.actualCost)[0];
  const tw=allMD.reduce((s,m)=>s+m.warrantyRevenue,0),tc=allMD.reduce((s,m)=>s+m.actualCost,0),tr=allMD.reduce((s,m)=>s+m.repairRevenue,0),n=tw+tr-tc;
  let h=`<div class="insight-card"><div class="insight-title">Repair Volume Trend</div>Repair count is <span class="trend-indicator trend-${rT.c}">${rT.t}</span>. ${yrs.map((y,i)=>`${y}: <strong>${fmt(rByY[i])}</strong>`).join(' â†’ ')}</div>`;
  h+=`<div class="insight-card"><div class="insight-title">Cost Trend</div>Total cost is <span class="trend-indicator trend-${cT.c}">${cT.t}</span>. ${yrs.map((y,i)=>`${y}: <strong>${fmtD(cByY[i])}</strong>`).join(' â†’ ')}</div>`;
  if(hR)h+=`<div class="insight-card"><div class="insight-title">Highest Repair Rate</div><strong>${hR.shortName}</strong> at <strong>${fmtP(hR.repairRate)}</strong> (${fmt(hR.total)} / ${fmt(hR.sold)} sold)</div>`;
  if(lR)h+=`<div class="insight-card"><div class="insight-title">Most Reliable (50+ sold)</div><strong>${lR.shortName}</strong> at <strong>${fmtP(lR.repairRate)}</strong> (${fmt(lR.total)} / ${fmt(lR.sold)} sold)</div>`;
  if(hC)h+=`<div class="insight-card"><div class="insight-title">Highest Cost Model</div><strong>${hC.shortName}</strong>: <strong>${fmtD(hC.actualCost)}</strong> across ${fmt(hC.total)} repairs</div>`;
  h+=`<div class="insight-card"><div class="insight-title">Net P/L</div>Rev <strong>${fmtD(tw)}</strong> + Repair Rev <strong>${fmtD(tr)}</strong> âˆ’ Cost <strong>${fmtD(tc)}</strong> = <strong style="color:${n>=0?'var(--positive)':'var(--negative)'}">${fmtD(n)}</strong></div>`;
  g.innerHTML=h;
}
function renderSummary(){
  const b=document.getElementById('summaryBody');const{sy,ey}=getDR();const yrs=[];for(let y=sy;y<=ey;y++)yrs.push(y.toString());
  const top=allMD.filter(m=>m.sold>0).sort((a,b)=>b.sold-a.sold).slice(0,20);
  b.innerHTML=top.map(m=>{const rv=yrs.map(y=>m.yearlyRepairs[y]?.rep||0);const t=trend(rv);
    return`<tr style="cursor:pointer" onclick='openDM("${m.model.replace(/'/g,"\\'")}",modelHTML(allMD.find(x=>x.itemNumber==="${m.itemNumber}")))'>
      <td>${m.shortName}</td><td class="mono">${fmt(m.sold)}</td><td class="mono">${fmt(m.total)}</td><td class="mono">${m.repairRate!=null?fmtP(m.repairRate):'N/A'}</td><td class="mono">${fmtD(m.warrantyRevenue)}</td><td class="mono">${fmtD(m.actualCost)}</td><td class="mono ${m.netPL>=0?'positive':'negative'}">${fmtD(m.netPL)}</td><td><span class="trend-indicator trend-${t.c}">${t.t}</span></td></tr>`;}).join('');
}

document.getElementById('pwInput').focus();
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeDetailModal();});
</script>
</body>
</html>
