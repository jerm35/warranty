<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTL Warranty Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e4e4e4;
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Password Overlay */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .password-box {
            background: linear-gradient(145deg, #1e3a5f, #1a2d47);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            border: 1px solid rgba(79, 195, 247, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .password-box h2 {
            color: #4fc3f7;
            margin-bottom: 10px;
        }
        
        .password-box p {
            color: #90a4ae;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .password-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #2c5282;
            border-radius: 8px;
            background: #1a2d47;
            color: #e4e4e4;
            font-size: 1rem;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }
        
        .password-box input:focus {
            outline: none;
            border-color: #4fc3f7;
        }
        
        .password-box button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #4fc3f7 0%, #2196f3 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .password-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 195, 247, 0.4);
        }
        
        .password-error {
            color: #ef5350;
            margin-top: 10px;
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 46, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9998;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #2c5282;
            border-top-color: #4fc3f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            color: #4fc3f7;
            font-size: 1.1rem;
        }
        
        /* Header Controls */
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .nav-button {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        }
        
        /* Date Filter Bar */
        .date-filter-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(145deg, #1e3a5f, #1a2d47);
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid rgba(79, 195, 247, 0.15);
            flex-wrap: wrap;
        }
        
        .date-filter-bar label {
            color: #90a4ae;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .date-filter-bar input[type="date"] {
            padding: 7px 12px;
            border: 1px solid #2c5282;
            border-radius: 6px;
            background: #1a2d47;
            color: #e4e4e4;
            font-size: 0.85rem;
            font-family: inherit;
            cursor: pointer;
        }
        
        .date-filter-bar input[type="date"]:focus {
            outline: none;
            border-color: #4fc3f7;
        }
        
        .date-filter-apply {
            padding: 7px 18px;
            background: linear-gradient(135deg, #4fc3f7 0%, #2196f3 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .date-filter-apply:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(79, 195, 247, 0.4);
        }
        
        .date-filter-apply:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .date-filter-active {
            color: #81c784;
            font-size: 0.8rem;
            margin-left: 4px;
        }
        
        .refresh-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .refresh-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }
        
        .last-updated {
            color: #90a4ae;
            font-size: 0.85rem;
        }
        
        .last-updated strong {
            color: #81c784;
        }
        
        /* Dashboard Styles */
        .dashboard {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4fc3f7;
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #90a4ae;
            margin-bottom: 20px;
        }
        
        .header-actions {
            margin-bottom: 20px;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: linear-gradient(145deg, #1e3a5f, #1a2d47);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(79, 195, 247, 0.1);
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4fc3f7;
        }
        
        .kpi-card.warning .kpi-value {
            color: #ffb74d;
        }
        
        .kpi-card.danger .kpi-value {
            color: #ef5350;
        }
        
        .kpi-card.success .kpi-value {
            color: #81c784;
        }
        
        .kpi-card.purple .kpi-value {
            color: #ba68c8;
        }
        
        .kpi-card.clickable {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .kpi-card.clickable:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(79, 195, 247, 0.3);
        }
        
        .kpi-label {
            color: #90a4ae;
            font-size: 0.85rem;
            margin-top: 5px;
        }
        
        /* Charts */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: linear-gradient(145deg, #1e3a5f, #1a2d47);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(79, 195, 247, 0.1);
        }
        
        .chart-container h3 {
            color: #4fc3f7;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .chart-wrapper {
            height: 350px;
            position: relative;
        }
        
        .chart-container.full-width {
            grid-column: 1 / -1;
        }
        
        .click-hint {
            text-align: center;
            color: #90a4ae;
            font-size: 0.8rem;
            margin-top: 10px;
            font-style: italic;
        }
        
        /* Insights */
        .insights {
            background: linear-gradient(145deg, #1e3a5f, #1a2d47);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(79, 195, 247, 0.1);
        }
        
        .insights h3 {
            color: #4fc3f7;
            margin-bottom: 20px;
        }
        
        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .insight-icon {
            font-size: 1.5rem;
        }
        
        .insight-content h4 {
            color: #e4e4e4;
            margin-bottom: 5px;
        }
        
        .insight-content p {
            color: #90a4ae;
            font-size: 0.9rem;
        }
        
        /* Tables */
        .table-container {
            background: linear-gradient(145deg, #1e3a5f, #1a2d47);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(79, 195, 247, 0.1);
            overflow-x: auto;
        }
        
        .table-container h3 {
            color: #4fc3f7;
            margin-bottom: 15px;
        }
        
        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 12px 16px;
            background: rgba(79, 195, 247, 0.1);
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 8px;
            color: #90a4ae;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-width: 140px;
        }
        
        .tab-btn .tab-title {
            display: block;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .tab-btn .tab-stats {
            display: block;
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        .tab-btn:hover, .tab-btn.active {
            background: rgba(79, 195, 247, 0.2);
            color: #4fc3f7;
            border-color: #4fc3f7;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(79, 195, 247, 0.1);
        }
        
        th {
            background: rgba(0,0,0,0.3);
            color: #4fc3f7;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: rgba(79, 195, 247, 0.05);
        }
        
        tr {
            cursor: pointer;
        }
        
        .rate-high { color: #ef5350; }
        .rate-medium { color: #ffb74d; }
        .rate-low { color: #81c784; }
        
        /* Sortable columns */
        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        th.sortable:hover {
            background: rgba(79, 195, 247, 0.2);
        }
        
        th.sort-asc::after {
            content: ' ‚ñ≤';
            color: #4fc3f7;
        }
        
        th.sort-desc::after {
            content: ' ‚ñº';
            color: #4fc3f7;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(145deg, #1e3a5f, #1a2d47);
            padding: 30px;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(79, 195, 247, 0.2);
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #90a4ae;
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: #ef5350;
        }
        
        .modal-title {
            color: #4fc3f7;
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .sheets-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.08);
            transition: background 0.2s, transform 0.2s;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .sheets-link:hover {
            background: rgba(255, 255, 255, 0.18);
            transform: scale(1.1);
        }
        
        .sheets-link svg {
            width: 18px;
            height: 18px;
        }
        
        .wc-expandable {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .wc-expandable:hover {
            background: rgba(79, 195, 247, 0.08);
        }
        
        .wc-expandable .wc-arrow {
            display: inline-block;
            transition: transform 0.2s;
            margin-right: 4px;
            font-size: 0.75em;
            color: #4fc3f7;
        }
        
        .wc-expandable.expanded .wc-arrow {
            transform: rotate(90deg);
        }
        
        .wc-detail {
            display: none;
            padding: 8px 0 8px 20px;
            border-left: 2px solid rgba(79, 195, 247, 0.3);
            margin-left: 8px;
        }
        
        .wc-detail.visible {
            display: block;
        }
        
        .wc-detail table {
            width: 100%;
            font-size: 0.82rem;
        }
        
        .wc-detail th {
            color: #4fc3f7;
            padding: 4px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.78rem;
            border-bottom: 1px solid rgba(79, 195, 247, 0.2);
        }
        
        .wc-detail td {
            padding: 3px 8px;
            color: #b0bec5;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        
        .modal-subtitle {
            color: #90a4ae;
            margin-bottom: 20px;
        }
        
        .modal-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .modal-stat {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .modal-stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #4fc3f7;
        }
        
        .modal-stat-value.warning { color: #ffb74d; }
        .modal-stat-value.danger { color: #ef5350; }
        .modal-stat-value.success { color: #81c784; }
        .modal-stat-value.purple { color: #ba68c8; }
        
        .modal-stat-label {
            color: #90a4ae;
            font-size: 0.75rem;
            margin-top: 5px;
        }
        
        .comparison {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .comparison h4 {
            color: #4fc3f7;
            margin-bottom: 10px;
        }
        
        .comparison-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(79, 195, 247, 0.1);
        }
        
        .comparison-item:last-child {
            border-bottom: none;
        }
        
        .top-repairs {
            margin-top: 20px;
        }
        
        .top-repairs h4 {
            color: #4fc3f7;
            margin-bottom: 15px;
        }
        
        .repair-table {
            width: 100%;
        }
        
        .repair-table th, .repair-table td {
            padding: 10px;
            font-size: 0.9rem;
        }
        
        /* Assumptions Panel */
        .assumptions-panel {
            margin-top: 30px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(79, 195, 247, 0.15);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .assumptions-panel:hover {
            border-color: rgba(79, 195, 247, 0.3);
        }
        .assumptions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            color: #90a4ae;
            font-size: 0.95rem;
            font-weight: 500;
        }
        .assumptions-arrow {
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }
        .assumptions-panel.expanded .assumptions-arrow {
            transform: rotate(90deg);
        }
        .assumptions-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }
        .assumptions-panel.expanded .assumptions-body {
            max-height: 2000px;
        }
        .assumptions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            padding: 0 20px 20px;
        }
        .assumption-section {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            padding: 14px;
        }
        .assumption-section h4 {
            color: #4fc3f7;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        .assumption-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .assumption-section li {
            color: #b0bec5;
            font-size: 0.8rem;
            padding: 3px 0;
            padding-left: 12px;
            position: relative;
        }
        .assumption-section li::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: #607d8b;
        }

        .footer {
            text-align: center;
            color: #607d8b;
            margin-top: 30px;
            padding: 20px;
            border-top: 1px solid rgba(79, 195, 247, 0.1);
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 1.5rem; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .header-controls { flex-direction: column; gap: 15px; align-items: flex-start; }
            .refresh-section { flex-direction: column; align-items: flex-start; }
            .date-filter-bar { flex-direction: column; align-items: flex-start; gap: 8px; }
        }
    </style>
</head>
<body>
    <!-- Password Overlay -->
    <div class="password-overlay" id="passwordOverlay">
        <div class="password-box">
            <h2>üîê CTL Warranty Dashboard</h2>
            <p>Enter password to access the dashboard</p>
            <input type="password" id="passwordInput" placeholder="Enter password" onkeypress="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()">Access Dashboard</button>
            <p class="password-error" id="passwordError">Incorrect password. Please try again.</p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
        <p class="loading-text" id="loadingText">Loading data from Google Sheets...</p>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard hidden" id="dashboard">
        <div class="header-controls">
            <div class="date-filter-bar">
                <label>üìÖ Date Range:</label>
                <input type="date" id="filterStartDate" value="2023-01-01">
                <span style="color: #90a4ae;">to</span>
                <input type="date" id="filterEndDate" value="2025-12-31">
                <button class="date-filter-apply" id="applyDateFilter" onclick="applyDateFilter()">Apply</button>
                <span class="date-filter-active" id="dateFilterStatus">Showing: 1/1/2023 ‚Äì 12/31/2025</span>
            </div>
            <div class="refresh-section">
                <div class="last-updated">
                    Last updated: <strong id="lastUpdated">Never</strong>
                    <span id="autoRefreshNote" style="color: #90a4ae;"> ‚Ä¢ Auto-refresh every 6 hours</span>
                </div>
                <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">
                    <span class="refresh-icon">üîÑ</span> Refresh Data
                </button>
            </div>
        </div>
        <h1>üìä CTL Warranty Analysis Dashboard</h1>
        <p class="subtitle" id="dashboardSubtitle">Repair Data | Only models with >1,000 units sold showing in charts | All Models</p>
        <div class="header-actions">
            <span style="color: #81c784; font-size: 0.9rem;">‚úì All models included ‚Ä¢ Only completed repairs (Order Received Date required)</span>
            <br><span style="color: #90caf9; font-size: 0.85rem;">Unit Sales and Warranty Revenue are based on years only ‚Äì Repairs are granular</span>
        </div>
        
        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card clickable" onclick="openKpiModal('unitsSold')">
                <div class="kpi-value" id="kpiUnitsSold">-</div>
                <div class="kpi-label">Total Units Sold</div>
            </div>
            <div class="kpi-card warning clickable" onclick="openKpiModal('totalRepairs')">
                <div class="kpi-value" id="kpiTotalRepairs">-</div>
                <div class="kpi-label">Total Repairs</div>
            </div>
            <div class="kpi-card danger clickable" onclick="openKpiModal('repairRate')">
                <div class="kpi-value" id="kpiRepairRate">-</div>
                <div class="kpi-label">Overall Repair Rate</div>
            </div>
            <div class="kpi-card warning clickable" onclick="openKpiModal('totalCost')">
                <div class="kpi-value" id="kpiTotalCost">-</div>
                <div class="kpi-label">Total Repair Cost</div>
                <div class="kpi-value" id="kpiEstimatedCost" style="font-size: 1.4rem; color: #90caf9; margin-top: 4px;">-</div>
                <div class="kpi-label" style="font-size: 0.7rem; color: #78909c;">Estimated Cost</div>
            </div>
            <div class="kpi-card purple clickable" onclick="openKpiModal('accidental')">
                <div class="kpi-value" id="kpiAccidental">-</div>
                <div class="kpi-label">Accidental Damage %</div>
            </div>
            <div class="kpi-card success clickable" onclick="openKpiModal('inWarranty')">
                <div class="kpi-value" id="kpiInWarranty">-</div>
                <div class="kpi-label">In Warranty %</div>
            </div>
        </div>
        
        <!-- Financial KPI Row -->
        <div class="kpi-grid" style="margin-top: 15px;">
            <div class="kpi-card clickable" style="border-left: 3px solid #4fc3f7;" onclick="openKpiModal('warrantyRevenue')">
                <div class="kpi-value" id="kpiWarrantyRevenue" style="color: #4fc3f7;">-</div>
                <div class="kpi-label">Warranty Revenue</div>
            </div>
            <div class="kpi-card clickable" style="border-left: 3px solid #ffb74d;" onclick="openKpiModal('repairRevenue')">
                <div class="kpi-value" id="kpiRepairRevenue" style="color: #ffb74d;">-</div>
                <div class="kpi-label">Repair Revenue (OOW)</div>
            </div>
            <div class="kpi-card clickable" id="kpiNetCard" onclick="openKpiModal('netPL')">
                <div class="kpi-value" id="kpiNetPL">-</div>
                <div class="kpi-label">Net Warranty P/L</div>
            </div>
        </div>
        
        <!-- Charts Row 1 -->
        <div class="chart-grid">
            <div class="chart-container full-width">
                <h3>üîß Number of Repairs by Model (Highest to Lowest)</h3>
                <div class="chart-wrapper" style="height: 400px;">
                    <canvas id="repairRateChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any bar to view detailed model information</p>
            </div>
        </div>
        
        <!-- Charts Row 2 -->
        <div class="chart-grid">
            <div class="chart-container">
                <h3>üí∞ Repair Cost by Model</h3>
                <div class="chart-wrapper">
                    <canvas id="costChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any bar to view detailed model information</p>
            </div>
            <div class="chart-container">
                <h3>üîß Repair Type Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="repairTypeChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any segment to view model breakdown</p>
            </div>
        </div>
        
        <!-- Charts Row 3 -->
        <div class="chart-grid">
            <div class="chart-container">
                <h3>üí• Accidental vs Non-Accidental</h3>
                <div class="chart-wrapper">
                    <canvas id="accidentalPieChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any segment to view model breakdown</p>
            </div>
            <div class="chart-container">
                <h3>üíµ Cost Breakdown by Repair Type</h3>
                <div class="chart-wrapper">
                    <canvas id="costPieChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any segment to view model breakdown</p>
            </div>
        </div>
        
        <!-- Charts Row 4 -->
        <div class="chart-grid">
            <div class="chart-container">
                <h3>‚ö†Ô∏è Accidental Damage Rate by Model <span style="font-size: 0.7rem; color: #90a4ae; font-weight: normal;">(100+ repairs only)</span></h3>
                <div class="chart-wrapper">
                    <canvas id="accidentalChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any bar to view detailed model information</p>
            </div>
            <div class="chart-container">
                <h3>üìã Warranty Status Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="warrantyChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any segment to view model breakdown</p>
            </div>
        </div>
        
        <!-- Cost Analysis Charts -->
        <div class="chart-grid">
            <div class="chart-container">
                <h3>üí• Accidental Damage Cost by Model <span style="font-size: 0.7rem; color: #90a4ae; font-weight: normal;">(100+ repairs only)</span></h3>
                <div class="chart-wrapper">
                    <canvas id="accidentalCostChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any bar to view detailed model information</p>
            </div>
            <div class="chart-container">
                <h3>üìã Total Cost: In Warranty vs Out of Warranty</h3>
                <div class="chart-wrapper">
                    <canvas id="warrantyCostChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on a segment to view model breakdown</p>
            </div>
        </div>
        
        <div class="chart-grid">
            <div class="chart-container">
                <h3>üè∑Ô∏è Warranty Repair Cost Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="warrantyCodeChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on a segment to view devices with that warranty code</p>
            </div>
            <div class="chart-container">
                <h3>üíµ Repair Cost by Customer</h3>
                <div class="chart-wrapper">
                    <canvas id="revenueBreakdownChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on a segment to view customer breakdown</p>
            </div>
        </div>
        
        <!-- Insights Section -->
        <div class="insights">
            <h3>üîç Key Insights & Analysis</h3>
            <div id="insightsList"></div>
        </div>
        
        <!-- Data Tables -->
        <div class="table-container">
            <h3>üìä Model Analysis Tables <span style="font-size: 0.8rem; color: #90a4ae; font-weight: normal;">(click any box for details)</span></h3>
            
            <!-- Warranty Code Summary Chart -->
            <div class="chart-container" style="margin-bottom: 20px;">
                <h3>üè∑Ô∏è Warranty Code Financial Summary <span style="font-size: 0.7rem; color: #90a4ae; font-weight: normal;">(Revenue vs Cost by Warranty Code)</span></h3>
                <div class="chart-wrapper" style="height: 350px;">
                    <canvas id="warrantyCodeSummaryChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any bar to see all devices with that warranty code</p>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-btn active" id="tabBtnWorst" onclick="showTab('worstTab')">‚ö†Ô∏è Highest Repair Rate</button>
                <button class="tab-btn" id="tabBtnBest" onclick="showTab('bestTab')">‚úÖ Most Reliable</button>
                <button class="tab-btn" id="tabBtnCost" onclick="showTab('costTab')">üí∞ Highest Cost</button>
                <button class="tab-btn" id="tabBtnAccidental" onclick="showTab('accidentalTab')">üí• Accidental Damage</button>
                <button class="tab-btn" id="tabBtnWarranty" onclick="showTab('warrantyTab')">üìã Warranty Status</button>
                <button class="tab-btn" id="tabBtnRevenue" onclick="showTab('revenueTab')">üíµ Warranty & Revenue</button>
                <button class="tab-btn" id="tabBtnWarrantyCode" onclick="showTab('warrantyCodeTab')">üè∑Ô∏è Warranty Codes</button>
                <button class="tab-btn" id="tabBtnAll" onclick="showTab('allTab')">üìÑ All Models</button>
            </div>
            
            <div id="worstTab" class="tab-content active">
                <table>
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Item #</th>
                            <th>Units Sold</th>
                            <th>Total Repairs</th>
                            <th>Repair Rate</th>
                            <th>Cost</th>
                        </tr>
                    </thead>
                    <tbody id="worstTable"></tbody>
                </table>
            </div>
            
            <div id="bestTab" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Item #</th>
                            <th>Units Sold</th>
                            <th>Total Repairs</th>
                            <th>Repair Rate</th>
                            <th>Cost</th>
                        </tr>
                    </thead>
                    <tbody id="bestTable"></tbody>
                </table>
            </div>
            
            <div id="costTab" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Item #</th>
                            <th>Total Repairs</th>
                            <th>Major</th>
                            <th>Minor</th>
                            <th>NPU/NPF</th>
                            <th>Actual Cost</th>
                            <th>Avg/Repair</th>
                        </tr>
                    </thead>
                    <tbody id="costTable"></tbody>
                </table>
            </div>
            
            <div id="accidentalTab" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Item #</th>
                            <th>Total Repairs</th>
                            <th>Accidental</th>
                            <th>Non-Accidental</th>
                            <th>Accidental %</th>
                        </tr>
                    </thead>
                    <tbody id="accidentalTable"></tbody>
                </table>
            </div>
            
            <div id="warrantyTab" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Item #</th>
                            <th>Total Repairs</th>
                            <th>In Warranty</th>
                            <th>Out of Warranty</th>
                            <th>In Warranty %</th>
                        </tr>
                    </thead>
                    <tbody id="warrantyTable"></tbody>
                </table>
            </div>
            
            <div id="revenueTab" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Repairs</th>
                            <th>Repair Cost</th>
                            <th>Warranty Rev</th>
                            <th>Repair Rev (OOW)</th>
                            <th>Net P/L</th>
                        </tr>
                    </thead>
                    <tbody id="revenueTable"></tbody>
                </table>
            </div>
            
            <div id="warrantyCodeTab" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Warranty Code</th>
                            <th>Units Sold</th>
                            <th>Sell Price</th>
                            <th>Repairs</th>
                            <th>Repair Cost</th>
                            <th>Warranty Rev</th>
                            <th>Repair Rev</th>
                            <th>Net P/L</th>
                        </tr>
                    </thead>
                    <tbody id="warrantyCodeTable"></tbody>
                </table>
            </div>
            
            <div id="allTab" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" data-column="model" onclick="sortAllModels('model')">Model ‚Üï</th>
                            <th class="sortable" data-column="item" onclick="sortAllModels('item')">Item # ‚Üï</th>
                            <th class="sortable" data-column="sold" onclick="sortAllModels('sold')">Units Sold ‚Üï</th>
                            <th class="sortable" data-column="total" onclick="sortAllModels('total')">Repairs ‚Üï</th>
                            <th class="sortable" data-column="rate" onclick="sortAllModels('rate')">Rate ‚Üï</th>
                            <th class="sortable" data-column="major" onclick="sortAllModels('major')">Major ‚Üï</th>
                            <th class="sortable" data-column="minor" onclick="sortAllModels('minor')">Minor ‚Üï</th>
                            <th class="sortable" data-column="npu" onclick="sortAllModels('npu')">NPU ‚Üï</th>
                            <th class="sortable" data-column="accidental" onclick="sortAllModels('accidental')">Accidental ‚Üï</th>
                            <th class="sortable" data-column="inWarranty" onclick="sortAllModels('inWarranty')">In Warranty ‚Üï</th>
                            <th class="sortable" data-column="totalCost" onclick="sortAllModels('totalCost')">Cost ‚Üï</th>
                            <th class="sortable" data-column="warrantyRevenue" onclick="sortAllModels('warrantyRevenue')">War. Rev ‚Üï</th>
                            <th class="sortable" data-column="netTotal" onclick="sortAllModels('netTotal')">Net P/L ‚Üï</th>
                        </tr>
                    </thead>
                    <tbody id="allTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Assumptions Panel -->
        <div class="assumptions-panel" onclick="this.classList.toggle('expanded')">
            <div class="assumptions-header">
                <span>üìã Assumptions &amp; Methodology</span>
                <span class="assumptions-arrow">‚ñ∂</span>
            </div>
            <div class="assumptions-body">
                <div class="assumptions-grid">
                    <div class="assumption-section">
                        <h4>üí∞ Cost Calculations</h4>
                        <ul>
                            <li><strong>Shipping cost:</strong> $10 added to each repair's <strong>actual cost</strong> only</li>
                            <li><strong>Actual cost:</strong> "Costs" field from repair data + $10 shipping per repair</li>
                            <li><strong>Estimated costs</strong> are based on repair type lookup (below) ‚Äî shipping already included in estimates</li>
                            <li><strong>Default estimated cost:</strong> $50 for any unlisted repair type</li>
                        </ul>
                    </div>
                    <div class="assumption-section">
                        <h4>üì¶ Units Sold</h4>
                        <ul>
                            <li>Sourced from <strong>Sales CSV</strong> (Total Sales Qty), not from repair data</li>
                            <li>Filtered by date range (Year column in sales data)</li>
                            <li>Summed across all warranty codes per device</li>
                            <li>Models with &le;1,000 units sold are hidden from charts/tables (data still in KPI totals)</li>
                        </ul>
                    </div>
                    <div class="assumption-section">
                        <h4>üîß Repair Filtering</h4>
                        <ul>
                            <li>Only repairs with an <strong>Order Received Date</strong> are included</li>
                            <li>Rows with "No Match" for Model Name or Item Number are excluded</li>
                            <li>Date range filter applies to repair Order Received Date</li>
                            <li>All models included (no model exclusions)</li>
                        </ul>
                    </div>
                    <div class="assumption-section">
                        <h4>üíµ Revenue</h4>
                        <ul>
                            <li><strong>Warranty Revenue:</strong> from Sales CSV (Total Sales column or Qty &times; Price)</li>
                            <li><strong>Repair Revenue:</strong> from repair data "Repair Revenue" field (out-of-warranty)</li>
                            <li><strong>Net P/L:</strong> Warranty Revenue + Repair Revenue &minus; Actual Cost</li>
                        </ul>
                    </div>
                    <div class="assumption-section">
                        <h4>üìä Repair Classification</h4>
                        <ul>
                            <li><strong>NPU/NPF:</strong> repair name contains "NPU" or "NPF"</li>
                            <li><strong>Major:</strong> "Major Repairs" field = "Yes" (and not NPU/NPF)</li>
                            <li><strong>Minor:</strong> all other repairs</li>
                            <li><strong>Accidental:</strong> "Accidental Damage" = "Yes" or "Liquid"</li>
                            <li><strong>In Warranty:</strong> model-level count from repair data "In Warranty" field</li>
                        </ul>
                    </div>
                    <div class="assumption-section">
                        <h4>üîñ Estimated Repair Costs</h4>
                        <div id="estimatedCostsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 4px; font-size: 0.8rem;"></div>
                        <div style="margin-top: 6px; color: #78909c; font-size: 0.75rem;">Estimated costs already include shipping ‚Äî no additional $10 added</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            CTL Warranty Analysis Dashboard | Live from Google Sheets<br>
            Filtered: Only models with >1,000 units sold showing in charts | Date range applied
        </div>
    </div>

    <!-- Model Detail Modal -->
    <div class="modal" id="modelModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2 class="modal-title" id="modalTitle">Model Name</h2>
            <p class="modal-subtitle" id="modalItemNumber">Item #: XXXXX</p>
            
            <div class="modal-stats-grid" id="modalStatsGrid"></div>
            
            <div class="comparison">
                <h4>üìä Comparison to Fleet Average</h4>
                <div id="comparisonContent"></div>
            </div>
            
            <div class="top-repairs">
                <h4>üîß Top 10 Repairs for This Model</h4>
                <table class="repair-table">
                    <thead>
                        <tr>
                            <th>Repair Type</th>
                            <th>Count</th>
                            <th>% of Model</th>
                        </tr>
                    </thead>
                    <tbody id="modalRepairTable"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Pie Chart Modal -->
    <div class="modal" id="pieModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closePieModal()">&times;</span>
            <h2 class="modal-title" id="pieModalTitle">Category Breakdown</h2>
            <p class="modal-subtitle" id="pieModalSubtitle">Models in this category</p>
            
            <div id="pieModalStats" style="margin-bottom: 20px;"></div>
            
            <div class="top-repairs">
                <h4>üîß Top 10 Repairs in This Category</h4>
                <table class="repair-table">
                    <thead>
                        <tr>
                            <th id="pieModalCol1Header">Repair Type</th>
                            <th id="pieModalCol2Header">Count</th>
                            <th id="pieModalCol3Header">% of Category</th>
                        </tr>
                    </thead>
                    <tbody id="pieModalRepairTable"></tbody>
                </table>
            </div>
            
            <h4 style="color: #4fc3f7; margin: 20px 0 15px;">üìã Models in This Category</h4>
            <table class="repair-table">
                <thead>
                    <tr>
                        <th>Model</th>
                        <th>Count</th>
                        <th>% of Category</th>
                    </tr>
                </thead>
                <tbody id="pieModalModelTable"></tbody>
            </table>
        </div>
    </div>

    <!-- Warranty Code Drill-Down Modal -->
    <div class="modal" id="warrantyCodeModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeWarrantyCodeModal()">&times;</span>
            <h2 class="modal-title" id="warrantyCodeModalTitle">Warranty Code Breakdown</h2>
            <p class="modal-subtitle" id="warrantyCodeModalSubtitle"></p>
            
            <div id="warrantyCodeModalStats" style="margin-bottom: 20px;"></div>
            
            <div class="top-repairs">
                <h4 id="warrantyCodeModalTableTitle">üìã Devices with This Warranty Code</h4>
                <table class="repair-table">
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Units Sold</th>
                            <th>Sell Price</th>
                            <th>Repairs</th>
                            <th>Repair Cost</th>
                            <th>Warranty Rev</th>
                            <th>Repair Rev</th>
                            <th>Net P/L</th>
                        </tr>
                    </thead>
                    <tbody id="warrantyCodeModalTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS9yLbvcLU16R73aNEIqwAVzJwz82UghVY5buEK5uuX9LHojAE9JoQoJ00-uuR2KzXTL-e6AwepOlFq/pub?gid=986703446&single=true&output=csv';
        const SALES_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS9yLbvcLU16R73aNEIqwAVzJwz82UghVY5buEK5uuX9LHojAE9JoQoJ00-uuR2KzXTL-e6AwepOlFq/pub?gid=235319241&single=true&output=csv';
        const AUTO_REFRESH_INTERVAL = 6 * 60 * 60 * 1000; // 6 hours in milliseconds
        
        // Date filter defaults (use constructor to avoid UTC timezone shift)
        let filterStartDate = new Date(2023, 0, 1);   // Jan 1, 2023 local
        let filterEndDate = new Date(2025, 11, 31, 23, 59, 59); // Dec 31, 2025 end-of-day local
        
        // Raw fetched data (before date filtering) - kept for re-filtering without re-fetching
        let rawFetchedData = [];
        let rawFetchedSalesData = [];
        
        // Estimated repair cost lookup by repair type
        const SHIPPING_COST_PER_REPAIR = 10; // $10 shipping cost added to each repair
        const ESTIMATED_REPAIR_COSTS = {
            'AC Adapter': 50, 'Accidental': 100, 'Battery': 100, 'Camera': 50,
            'Daughterboard': 50, 'DC Port': 50, 'Declined': 50, 'Headphone Port': 50,
            'Hinge': 50, 'Hinge Cover': 50, 'Keyboard': 50, 'Keyboard Keys': 50,
            'LTE Module': 50, 'LVDS': 50, 'Mainboard': 100, 'NPF': 20, 'NPU': 20,
            'OS Issue': 50, 'Other': 50, 'Panel': 100, 'Plastics': 50,
            'Please Select': 20, 'Replacement': 100, 'Storage': 100,
            'Tear Down': 50, 'Touchpad': 50, 'USB Port': 50, 'USB-C Port': 50,
            'Wifi Module': 50
        };
        function getEstimatedCost(repairType) {
            return ESTIMATED_REPAIR_COSTS[repairType] || 50; // Default $50 for unknown types
        }
        
        // Generate Google Sheets icon HTML that exports modal data to CSV
        function sheetsIcon(modalId, filenameHint) {
            const safeHint = (filenameHint || 'export').replace(/[^a-z0-9_-]/gi, '_');
            return `<span class="sheets-link" title="Export data to CSV" onclick="event.stopPropagation(); exportModalToCSV('${modalId}', '${safeHint}')">` +
                `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">` +
                `<path d="M14.727 6.727H14V0H4.91c-.905 0-1.637.732-1.637 1.636v20.728c0 .904.732 1.636 1.636 1.636h14.182c.904 0 1.636-.732 1.636-1.636V6.727h-4.91z" fill="#23A566"/>` +
                `<path d="M16.182 0v5.09c0 .905.731 1.637 1.636 1.637H23L16.182 0z" fill="#87CEAC"/>` +
                `<path d="M7 12h10v8H7z" fill="#fff"/>` +
                `<path d="M7 12v8h4.5v-8H7zm0 2.5h4.5m-4.5 2.5h4.5M11.5 12v8m0 0H17v-8h-5.5m0 2.5H17m-5.5 2.5H17" stroke="#23A566" stroke-width=".5" fill="none"/>` +
                `</svg></span>`;
        }
        
        // Export modal contents to CSV
        function exportModalToCSV(modalId, filenameHint) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            const csvCell = (val) => '"' + String(val).replace(/"/g, '""') + '"';
            let rows = [];
            
            // Title & subtitle
            const titleEl = modal.querySelector('.modal-title');
            const title = titleEl ? titleEl.textContent.replace(/\s+/g, ' ').trim() : 'Export';
            const subtitle = modal.querySelector('.modal-subtitle')?.textContent?.trim() || '';
            rows.push([title]);
            if (subtitle) rows.push([subtitle]);
            rows.push([]);
            
            // Stats grid
            const statLabels = [], statValues = [];
            modal.querySelectorAll('.modal-stat').forEach(stat => {
                const label = stat.querySelector('.modal-stat-label')?.textContent?.trim() || '';
                const value = stat.querySelector('.modal-stat-value')?.textContent?.trim() || '';
                if (label) { statLabels.push(label); statValues.push(value); }
            });
            if (statLabels.length) {
                rows.push(statLabels);
                rows.push(statValues);
                rows.push([]);
            }
            
            // Comparison items (model detail modal)
            const comparisonItems = modal.querySelectorAll('.comparison-item');
            if (comparisonItems.length) {
                rows.push(['Metric', 'Value']);
                comparisonItems.forEach(item => {
                    const spans = item.querySelectorAll('span');
                    if (spans.length >= 2) {
                        rows.push([spans[0].textContent.trim(), spans[1].textContent.replace(/\s+/g, ' ').trim()]);
                    }
                });
                rows.push([]);
            }
            
            // All visible tables
            modal.querySelectorAll('table').forEach(table => {
                // Skip hidden tables/parents
                let el = table;
                while (el && el !== modal) {
                    if (el.style && el.style.display === 'none') return;
                    el = el.parentElement;
                }
                
                // Check for a heading above
                const prevH4 = table.previousElementSibling;
                if (!prevH4) {
                    const wrapper = table.closest('.top-repairs');
                    if (wrapper) {
                        const h4 = wrapper.querySelector('h4');
                        if (h4) rows.push([h4.textContent.trim()]);
                    }
                } else if (prevH4.tagName === 'H4') {
                    rows.push([prevH4.textContent.trim()]);
                }
                
                table.querySelectorAll('tr').forEach(row => {
                    const cells = Array.from(row.querySelectorAll('th, td')).map(c => c.textContent.trim());
                    if (cells.some(c => c)) rows.push(cells);
                });
                rows.push([]);
            });
            
            const csv = rows.map(r => r.map(csvCell).join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (filenameHint || 'export') + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Global data store
        let warrantyData = [];
        let dataByItem = {};
        let repairCategories = {};
        let rawData = [];
        let allModelData = []; // All models (for totals), unfiltered by sold qty
        let customerData = []; // Aggregated repair data by parent customer
        let salesLookup = {}; // {itemNo: {warrantyCode: {qty, price, revenue}}}
        let charts = {};
        let autoRefreshTimer = null;
        
        // Password check function
        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            const correctPassword = 'CTLdata2026';
            
            if (password === correctPassword) {
                document.getElementById('passwordOverlay').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // Try to load data from localStorage
                if (loadFromLocalStorage()) {
                    // Data loaded from cache, initialize dashboard
                    initDashboard();
                } else {
                    // No cached data
                    document.getElementById('lastUpdated').textContent = 'Click Refresh to load data';
                }
                
                // Setup auto-refresh timer (6 hours)
                if (autoRefreshTimer) clearInterval(autoRefreshTimer);
                autoRefreshTimer = setInterval(refreshData, AUTO_REFRESH_INTERVAL);
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }
        
        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const storageKey = 'warrantyDashboardData';
                const savedData = localStorage.getItem(storageKey);
                if (!savedData) return false;
                
                const parsed = JSON.parse(savedData);
                allModelData = parsed.allModelData || parsed.warrantyData || [];
                customerData = parsed.customerData || [];
                repairCategories = parsed.repairCategories || {};
                // rawData is not stored - too large
                
                if (allModelData.length === 0) return false;
                
                // Filter to >1000 sold for display
                warrantyData = allModelData.filter(d => d.sold > 1000);
                
                // Rebuild dataByItem lookup
                dataByItem = {};
                allModelData.forEach(d => {
                    dataByItem[d.item] = d;
                });
                
                // Check if data is older than 6 hours
                const lastUpdatedStr = parsed.lastUpdated || '';
                const lastUpdatedTime = new Date(lastUpdatedStr);
                const now = new Date();
                const hoursSinceUpdate = (now - lastUpdatedTime) / (1000 * 60 * 60);
                
                if (hoursSinceUpdate >= 6) {
                    document.getElementById('lastUpdated').textContent = lastUpdatedStr + ' (stale - refreshing...)';
                    console.log('Cached data is older than 6 hours, will auto-refresh');
                    // Schedule refresh after dashboard loads
                    setTimeout(() => refreshData(), 1000);
                } else {
                    document.getElementById('lastUpdated').textContent = lastUpdatedStr + ' (cached)';
                }
                
                console.log('Loaded data from localStorage:', warrantyData.length, 'models');
                return true;
            } catch (e) {
                console.error('Error loading from localStorage:', e);
                return false;
            }
        }
        
        // Save data to localStorage
        function saveToLocalStorage() {
            try {
                const storageKey = 'warrantyDashboardData';
                const dataToSave = {
                    allModelData: allModelData,
                    customerData: customerData,
                    repairCategories: repairCategories,
                    // Don't save rawData - it's too large and can be regenerated
                    lastUpdated: new Date().toLocaleString()
                };
                localStorage.setItem(storageKey, JSON.stringify(dataToSave));
                console.log('Saved data to localStorage:', allModelData.length, 'models');
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                // If quota exceeded, try to clear old data and retry
                if (e.name === 'QuotaExceededError') {
                    console.log('Storage quota exceeded, clearing old data...');
                    localStorage.removeItem('warrantyDashboardData');
                }
            }
        }
        
        // Show/hide loading overlay
        function showLoading(message = 'Loading data from Google Sheets...') {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        // Refresh data function
        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.classList.add('loading');
            showLoading('Refreshing data from Google Sheets...');
            
            // Clear cached data before fetching fresh
            const storageKey = 'warrantyDashboardData';
            localStorage.removeItem(storageKey);
            console.log('Cleared localStorage cache');
            
            try {
                await loadDataAndInit();
            } catch (error) {
                console.error('Error refreshing data:', error);
                alert('Error refreshing data. Please try again.');
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                hideLoading();
            }
        }
        
        // Apply date filter - re-process cached data with new date range
        async function applyDateFilter() {
            const startInput = document.getElementById('filterStartDate').value;
            const endInput = document.getElementById('filterEndDate').value;
            
            if (!startInput || !endInput) {
                alert('Please select both a start and end date.');
                return;
            }
            
            // Parse as local time to avoid UTC timezone shift
            const [sy, sm, sd] = startInput.split('-').map(Number);
            const [ey, em, ed] = endInput.split('-').map(Number);
            const newStart = new Date(sy, sm - 1, sd);
            const newEnd = new Date(ey, em - 1, ed, 23, 59, 59);
            
            if (newStart > newEnd) {
                alert('Start date must be before end date.');
                return;
            }
            
            filterStartDate = newStart;
            filterEndDate = newEnd;
            
            // Update status display
            const startDisplay = newStart.toLocaleDateString('en-US');
            const endDisplay = newEnd.toLocaleDateString('en-US');
            document.getElementById('dateFilterStatus').textContent = 
                `Showing: ${startDisplay} ‚Äì ${endDisplay}`;
            
            // If we have cached raw data, reprocess without re-fetching
            if (rawFetchedData && rawFetchedData.length > 0) {
                showLoading('Applying date filter...');
                try {
                    reprocessWithDateFilter();
                } finally {
                    hideLoading();
                }
            } else {
                // No cached data yet, do a full load
                showLoading('Loading data with date filter...');
                try {
                    await loadDataAndInit();
                } finally {
                    hideLoading();
                }
            }
        }
        
        // Reprocess cached data with current date filter (no network fetch)
        function reprocessWithDateFilter() {
            // Reset rawDataFetchPromise so lazy-fetch will re-filter
            rawDataFetchPromise = null;
            
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') chart.destroy();
            });
            charts = {};
            
            // Reprocess
            salesLookup = buildSalesLookup(rawFetchedSalesData);
            allModelData = processData(rawFetchedData);
            repairCategories = generateRepairCategories();
            
            // Recalculate derived metrics
            dataByItem = {};
            allModelData.forEach(d => {
                d.repairRate = d.sold > 0 ? ((d.total / d.sold) * 100).toFixed(2) : "N/A";
                d.totalCost = d.actualCost;
                d.totalEstimatedCost = d.estimatedCost;
                d.accidentalPct = d.total > 0 ? ((d.accidental / d.total) * 100).toFixed(2) : "0.00";
                d.inWarrantyPct = (d.inWarranty + d.outWarranty) > 0 ? 
                    ((d.inWarranty / (d.inWarranty + d.outWarranty)) * 100).toFixed(2) : "0.00";
                d.outWarrantyPct = (d.inWarranty + d.outWarranty) > 0 ? 
                    ((d.outWarranty / (d.inWarranty + d.outWarranty)) * 100).toFixed(2) : "0.00";
                d.shortName = d.model.replace('CTL Chromebook ', '').replace('CTL ', '').substring(0, 25);
                d.netWarranty = d.warrantyRevenue - d.actualCost;
                d.netTotal = d.warrantyRevenue + d.repairRevenue - d.actualCost;
                d.avgCostPerRepair = d.total > 0 ? Math.round(d.actualCost / d.total) : 0;
                dataByItem[d.item] = d;
            });
            
            // Rebuild customer data
            const validItems = new Set(allModelData.map(d => d.item));
            const custMap = {};
            rawData.forEach(row => {
                const item = (row['Item Number'] || '').trim();
                if (!validItems.has(item)) return;
                const parent = (row['Parent Customer'] || '').trim();
                const child = (row['Child Customer'] || '').trim();
                const custName = parent || child || 'Unknown';
                if (!custMap[custName]) {
                    custMap[custName] = { name: custName, repairs: 0, cost: 0, estimatedCost: 0, repairRevenue: 0, models: new Set() };
                }
                const c = custMap[custName];
                c.repairs++;
                c.cost += (parseFloat(row['Costs']) || 0) + SHIPPING_COST_PER_REPAIR;
                c.estimatedCost += getEstimatedCost((row['Repair'] || '').trim());
                c.repairRevenue += parseFloat(row['Repair Revenue']) || 0;
                const modelName = (row['Model Name'] || '').trim().replace('CTL Chromebook ', '').replace('CTL ', '').substring(0, 25);
                if (modelName) c.models.add(modelName);
            });
            customerData = Object.values(custMap).map(c => ({
                name: c.name,
                repairs: c.repairs,
                cost: Math.round(c.cost),
                estimatedCost: Math.round(c.estimatedCost),
                repairRevenue: Math.round(c.repairRevenue),
                modelCount: c.models.size,
                models: [...c.models]
            })).sort((a, b) => b.cost - a.cost);
            
            // Filter and sort for display
            warrantyData = allModelData.filter(d => d.sold > 1000);
            warrantyData.sort((a, b) => b.total - a.total);
            
            // Re-render dashboard
            initDashboard();
            
            // Save updated data
            saveToLocalStorage();
            
            console.log('Date filter applied:', filterStartDate.toLocaleDateString(), '-', filterEndDate.toLocaleDateString(), 
                        '| Models:', allModelData.length, '| Repairs:', rawData.length);
        }
        
        // Fetch and parse CSV from Google Sheets
        async function fetchData() {
            return new Promise((resolve, reject) => {
                Papa.parse(GOOGLE_SHEETS_URL, {
                    download: true,
                    header: true,
                    complete: function(results) {
                        resolve(results.data);
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }
        
        // Fetch sales data CSV
        async function fetchSalesData() {
            return new Promise((resolve, reject) => {
                Papa.parse(SALES_CSV_URL, {
                    download: true,
                    header: true,
                    complete: function(results) {
                        resolve(results.data);
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }
        
        // Build sales lookup from sales CSV: {itemNo: {warrantyCode: {qty, price, revenue, byYear}, _soldByYear: {year: qty}}}
        function buildSalesLookup(salesData) {
            const lookup = {};
            salesData.forEach(row => {
                const itemNo = (row['Item No'] || '').trim();
                const code = (row['Warranty Code'] || '').trim();
                const qty = parseInt(row['Total Sales Qty']) || 0;
                const price = parseFloat((row['Price'] || '').replace(/[$,]/g, '')) || 0;
                const totalSales = parseFloat((row['Total Sales'] || '').replace(/[$,]/g, '')) || 0;
                const year = (row['Year'] || '').trim();
                
                if (!itemNo || !code) return;
                
                if (!lookup[itemNo]) lookup[itemNo] = { _soldByYear: {} };
                // If same item+code appears multiple times, sum qty and revenue
                if (!lookup[itemNo][code]) {
                    lookup[itemNo][code] = { qty: 0, price: 0, revenue: 0, byYear: {} };
                }
                lookup[itemNo][code].qty += qty;
                if (price > 0 && lookup[itemNo][code].price === 0) {
                    lookup[itemNo][code].price = price;
                }
                const rowRevenue = totalSales > 0 ? totalSales : (qty * price);
                // Use Total Sales column directly if available, otherwise calculate
                lookup[itemNo][code].revenue += rowRevenue;
                
                // Track per-year breakdown per warranty code
                if (year) {
                    if (!lookup[itemNo][code].byYear[year]) {
                        lookup[itemNo][code].byYear[year] = { qty: 0, revenue: 0 };
                    }
                    lookup[itemNo][code].byYear[year].qty += qty;
                    lookup[itemNo][code].byYear[year].revenue += rowRevenue;
                    
                    // Track total units sold per item per year (across all warranty codes)
                    if (!lookup[itemNo]._soldByYear[year]) {
                        lookup[itemNo]._soldByYear[year] = 0;
                    }
                    lookup[itemNo]._soldByYear[year] += qty;
                }
            });
            return lookup;
        }
        
        // Process raw data into aggregated format
        function processData(data) {
            // Filter: Only rows with Order Received Date + date range filter
            const filtered = data.filter(row => {
                const dateStr = (row['Order Received Date'] || '').trim();
                if (!dateStr) return false;
                if (!(row['Model Name'] || '').trim() || 
                    (row['Model Name'] || '').trim().toLowerCase() === 'no match') return false;
                if (!(row['Item Number'] || '').trim() || 
                    (row['Item Number'] || '').trim().toLowerCase() === 'no match') return false;
                
                // Apply date range filter
                const rowDate = new Date(dateStr);
                if (isNaN(rowDate.getTime())) return false;
                if (rowDate < filterStartDate || rowDate > filterEndDate) return false;
                
                return true;
            });
            
            // Store raw data for repair categories
            rawData = filtered;
            
            // Group by Item Number
            const grouped = {};
            filtered.forEach(row => {
                const item = row['Item Number'].trim();
                if (!grouped[item]) {
                    grouped[item] = {
                        model: row['Model Name'].trim(),
                        item: item,
                        rows: []
                    };
                }
                grouped[item].rows.push(row);
            });
            
            // Determine which years overlap with the date filter range
            const startYear = filterStartDate.getFullYear();
            const endYear = filterEndDate.getFullYear();
            
            // Calculate metrics for each model
            const models = [];
            Object.values(grouped).forEach(group => {
                let major = 0, minor = 0, npu = 0, accidental = 0, inWarranty = 0, outWarranty = 0;
                let actualCost = 0, repairRevenue = 0;
                let majorCost = 0, minorCost = 0, npuCost = 0;
                let estimatedCost = 0, estimatedMajorCost = 0, estimatedMinorCost = 0, estimatedNpuCost = 0;
                const warrantyCodes = {};
                const yearlyRepairs = {};  // { year: { repairs, cost, estimatedCost, repairRevenue, major, minor, npu, accidental, majorCost, minorCost, npuCost, inWarranty, outWarranty } }
                
                group.rows.forEach(row => {
                    const repair = (row['Repair'] || '').trim();
                    const isMajor = (row['Major Repairs'] || '').trim().toLowerCase() === 'yes';
                    const accDamage = (row['Accidental Damage'] || '').trim().toLowerCase();
                    const warrantyCode = (row['Warranty Code'] || '').trim();
                    const cost = parseFloat(row['Costs']) || 0;
                    const costWithShipping = cost + SHIPPING_COST_PER_REPAIR;
                    const repRev = parseFloat(row['Repair Revenue']) || 0;
                    const estCost = getEstimatedCost(repair);
                    
                    // Count warranty status from per-row "Warranty Status" column
                    const warrantyStatus = (row['Warranty Status'] || '').trim().toLowerCase();
                    if (warrantyStatus === 'in warranty') {
                        inWarranty++;
                    } else if (warrantyStatus === 'out of warranty') {
                        outWarranty++;
                    }
                    
                    // Count repair types and their costs
                    if (repair.toLowerCase().includes('npu') || repair.toLowerCase().includes('npf')) {
                        npu++;
                        npuCost += costWithShipping;
                        estimatedNpuCost += estCost;
                    } else if (isMajor) {
                        major++;
                        majorCost += costWithShipping;
                        estimatedMajorCost += estCost;
                    } else {
                        minor++;
                        minorCost += costWithShipping;
                        estimatedMinorCost += estCost;
                    }
                    
                    // Count accidental
                    if (accDamage === 'yes' || accDamage === 'liquid') {
                        accidental++;
                    }
                    
                    // Sum actual costs and repair revenue (includes $10 shipping per repair)
                    actualCost += costWithShipping;
                    estimatedCost += estCost;
                    repairRevenue += repRev;
                    
                    // Track warranty codes (repairs only ‚Äî revenue comes from sales data)
                    if (warrantyCode) {
                        if (!warrantyCodes[warrantyCode]) {
                            warrantyCodes[warrantyCode] = { count: 0, cost: 0, repairRev: 0, estimatedCost: 0 };
                        }
                        warrantyCodes[warrantyCode].count++;
                        warrantyCodes[warrantyCode].cost += costWithShipping;
                        warrantyCodes[warrantyCode].repairRev += repRev;
                        warrantyCodes[warrantyCode].estimatedCost += estCost;
                    }
                    
                    // Track yearly repair data
                    const rowDate = new Date((row['Order Received Date'] || '').trim());
                    if (!isNaN(rowDate.getTime())) {
                        const yr = rowDate.getFullYear().toString();
                        if (!yearlyRepairs[yr]) {
                            yearlyRepairs[yr] = { repairs: 0, cost: 0, estimatedCost: 0, repairRevenue: 0, major: 0, minor: 0, npu: 0, accidental: 0, majorCost: 0, minorCost: 0, npuCost: 0, inWarranty: 0, outWarranty: 0 };
                        }
                        yearlyRepairs[yr].repairs++;
                        yearlyRepairs[yr].cost += costWithShipping;
                        yearlyRepairs[yr].estimatedCost += estCost;
                        yearlyRepairs[yr].repairRevenue += repRev;
                        // Track warranty status per year
                        if (warrantyStatus === 'in warranty') {
                            yearlyRepairs[yr].inWarranty++;
                        } else if (warrantyStatus === 'out of warranty') {
                            yearlyRepairs[yr].outWarranty++;
                        }
                        // Track category breakdowns per year
                        if (repair.toLowerCase().includes('npu') || repair.toLowerCase().includes('npf')) {
                            yearlyRepairs[yr].npu++;
                            yearlyRepairs[yr].npuCost += costWithShipping;
                        } else if (isMajor) {
                            yearlyRepairs[yr].major++;
                            yearlyRepairs[yr].majorCost += costWithShipping;
                        } else {
                            yearlyRepairs[yr].minor++;
                            yearlyRepairs[yr].minorCost += costWithShipping;
                        }
                        if (accDamage === 'yes' || accDamage === 'liquid') {
                            yearlyRepairs[yr].accidental++;
                        }
                    }
                });
                
                // Merge sales data into warranty codes
                const itemSales = salesLookup[group.item] || {};
                let warrantyRevenue = 0;
                const yearlyWarrantyRevenue = {};  // { year: revenue }
                
                // Compute units sold from sales CSV, filtered by date range
                const soldByYear = itemSales._soldByYear || {};
                let sold = 0;
                const yearlySold = {};  // { year: qty }
                Object.entries(soldByYear).forEach(([yr, qty]) => {
                    const yearNum = parseInt(yr);
                    if (yearNum >= startYear && yearNum <= endYear) {
                        sold += qty;
                        yearlySold[yr] = qty;
                    }
                });
                
                // Update existing repair codes with sales data + add sales-only codes
                const allCodes = new Set([
                    ...Object.keys(warrantyCodes),
                    ...Object.keys(itemSales).filter(k => !k.startsWith('_'))
                ]);
                const mergedWarrantyCodes = {};
                
                allCodes.forEach(code => {
                    const repairData = warrantyCodes[code] || { count: 0, cost: 0, repairRev: 0, estimatedCost: 0 };
                    const saleData = itemSales[code] || { qty: 0, price: 0, revenue: 0, byYear: {} };
                    
                    // Filter sales data by date range (year-level filtering)
                    let filteredQty = 0, filteredRevenue = 0;
                    Object.entries(saleData.byYear || {}).forEach(([yr, yrData]) => {
                        const yearNum = parseInt(yr);
                        if (yearNum >= startYear && yearNum <= endYear) {
                            filteredQty += yrData.qty;
                            filteredRevenue += yrData.revenue;
                            if (!yearlyWarrantyRevenue[yr]) yearlyWarrantyRevenue[yr] = 0;
                            yearlyWarrantyRevenue[yr] += yrData.revenue;
                        }
                    });
                    
                    mergedWarrantyCodes[code] = {
                        count: repairData.count,
                        cost: Math.round(repairData.cost),
                        estimatedCost: Math.round(repairData.estimatedCost),
                        repairRev: Math.round(repairData.repairRev),
                        qtySold: filteredQty,
                        unitPrice: Math.round(saleData.price * 100) / 100,
                        warrantyRev: Math.round(filteredRevenue)
                    };
                    warrantyRevenue += filteredRevenue;
                });
                
                
                models.push({
                    model: group.model,
                    item: group.item,
                    sold: sold,
                    major: major,
                    minor: minor,
                    npu: npu,
                    accidental: accidental,
                    total: group.rows.length,
                    inWarranty: inWarranty,
                    outWarranty: outWarranty,
                    actualCost: Math.round(actualCost),
                    estimatedCost: Math.round(estimatedCost),
                    majorCost: Math.round(majorCost),
                    minorCost: Math.round(minorCost),
                    npuCost: Math.round(npuCost),
                    estimatedMajorCost: Math.round(estimatedMajorCost),
                    estimatedMinorCost: Math.round(estimatedMinorCost),
                    estimatedNpuCost: Math.round(estimatedNpuCost),
                    repairRevenue: Math.round(repairRevenue),
                    warrantyRevenue: Math.round(warrantyRevenue),
                    warrantyCodes: mergedWarrantyCodes,
                    yearlyRepairs: yearlyRepairs,
                    yearlyWarrantyRevenue: yearlyWarrantyRevenue,
                    yearlySold: yearlySold
                });
            });
            
            return models;
        }
        
        // Generate repair categories from raw data
        function generateRepairCategories() {
            const categories = {
                modelRepairs: {},
                overallTop10: [],
                accidentalTop10: [],
                nonAccidentalTop10: [],
                inWarrantyTop10: [],
                outWarrantyTop10: [],
                majorTop10: [],
                minorTop10: [],
                npuTop10: []
            };
            
            // Filter rawData based on current models
            const validItems = new Set(allModelData.map(d => d.item));
            const filteredRaw = rawData.filter(row => validItems.has(row['Item Number']?.trim()));
            
            // Overall repairs
            const overallCounts = {};
            const accidentalCounts = {};
            const nonAccidentalCounts = {};
            const majorCounts = {};
            const minorCounts = {};
            const npuCounts = {};
            
            // Per-model repairs
            const modelCounts = {};
            
            filteredRaw.forEach(row => {
                const repair = (row['Repair'] || '').trim();
                const item = (row['Item Number'] || '').trim();
                const accDamage = (row['Accidental Damage'] || '').trim().toLowerCase();
                const isMajor = (row['Major Repairs'] || '').trim().toLowerCase() === 'yes';
                
                if (!repair) return;
                
                // Overall
                overallCounts[repair] = (overallCounts[repair] || 0) + 1;
                
                // By model
                if (!modelCounts[item]) modelCounts[item] = {};
                modelCounts[item][repair] = (modelCounts[item][repair] || 0) + 1;
                
                // Accidental vs Non-Accidental
                if (accDamage === 'yes' || accDamage === 'liquid') {
                    accidentalCounts[repair] = (accidentalCounts[repair] || 0) + 1;
                } else {
                    nonAccidentalCounts[repair] = (nonAccidentalCounts[repair] || 0) + 1;
                }
                
                // Major/Minor/NPU
                if (repair.toLowerCase().includes('npu') || repair.toLowerCase().includes('npf')) {
                    npuCounts[repair] = (npuCounts[repair] || 0) + 1;
                } else if (isMajor) {
                    majorCounts[repair] = (majorCounts[repair] || 0) + 1;
                } else {
                    minorCounts[repair] = (minorCounts[repair] || 0) + 1;
                }
            });
            
            // Convert to sorted arrays
            const toSortedArray = (obj) => Object.entries(obj).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            categories.overallTop10 = toSortedArray(overallCounts);
            categories.accidentalTop10 = toSortedArray(accidentalCounts);
            categories.nonAccidentalTop10 = toSortedArray(nonAccidentalCounts);
            categories.majorTop10 = toSortedArray(majorCounts);
            categories.minorTop10 = toSortedArray(minorCounts);
            categories.npuTop10 = toSortedArray(npuCounts);
            
            // Model repairs
            Object.keys(modelCounts).forEach(item => {
                categories.modelRepairs[item] = Object.entries(modelCounts[item])
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
            });
            
            return categories;
        }
        
        // Load data and initialize dashboard
        async function loadDataAndInit() {
            showLoading();
            
            try {
                const [data, salesData] = await Promise.all([fetchData(), fetchSalesData()]);
                rawFetchedData = data;       // Cache for date re-filtering
                rawFetchedSalesData = salesData;
                salesLookup = buildSalesLookup(salesData);
                allModelData = processData(data);
                repairCategories = generateRepairCategories();
                
                // Calculate derived metrics for ALL models
                allModelData.forEach(d => {
                    d.repairRate = d.sold > 0 ? ((d.total / d.sold) * 100).toFixed(2) : "N/A";
                    d.totalCost = d.actualCost;
                    d.totalEstimatedCost = d.estimatedCost;
                    d.accidentalPct = d.total > 0 ? ((d.accidental / d.total) * 100).toFixed(2) : "0.00";
                    d.inWarrantyPct = (d.inWarranty + d.outWarranty) > 0 ? 
                        ((d.inWarranty / (d.inWarranty + d.outWarranty)) * 100).toFixed(2) : "0.00";
                    d.outWarrantyPct = (d.inWarranty + d.outWarranty) > 0 ? 
                        ((d.outWarranty / (d.inWarranty + d.outWarranty)) * 100).toFixed(2) : "0.00";
                    d.shortName = d.model.replace('CTL Chromebook ', '').replace('CTL ', '').substring(0, 25);
                    d.netWarranty = d.warrantyRevenue - d.actualCost;
                    d.netTotal = d.warrantyRevenue + d.repairRevenue - d.actualCost;
                    d.avgCostPerRepair = d.total > 0 ? Math.round(d.actualCost / d.total) : 0;
                    dataByItem[d.item] = d;
                });
                
                // Build customer aggregation from raw repair data
                const validItems = new Set(allModelData.map(d => d.item));
                const custMap = {};
                rawData.forEach(row => {
                    const item = (row['Item Number'] || '').trim();
                    if (!validItems.has(item)) return;
                    const parent = (row['Parent Customer'] || '').trim();
                    const child = (row['Child Customer'] || '').trim();
                    const custName = parent || child || 'Unknown';
                    if (!custMap[custName]) {
                        custMap[custName] = { name: custName, repairs: 0, cost: 0, estimatedCost: 0, repairRevenue: 0, models: new Set() };
                    }
                    const c = custMap[custName];
                    c.repairs++;
                    c.cost += (parseFloat(row['Costs']) || 0) + SHIPPING_COST_PER_REPAIR;
                    c.estimatedCost += getEstimatedCost((row['Repair'] || '').trim());
                    c.repairRevenue += parseFloat(row['Repair Revenue']) || 0;
                    const modelName = (row['Model Name'] || '').trim().replace('CTL Chromebook ', '').replace('CTL ', '').substring(0, 25);
                    if (modelName) c.models.add(modelName);
                });
                customerData = Object.values(custMap).map(c => ({
                    name: c.name,
                    repairs: c.repairs,
                    cost: Math.round(c.cost),
                    estimatedCost: Math.round(c.estimatedCost),
                    repairRevenue: Math.round(c.repairRevenue),
                    modelCount: c.models.size,
                    models: [...c.models]
                })).sort((a, b) => b.cost - a.cost);
                
                // Filter to >1000 units sold for display in charts/tables
                warrantyData = allModelData.filter(d => d.sold > 1000);
                
                // Sort by total repairs (descending) for consistent display
                warrantyData.sort((a, b) => b.total - a.total);
                
                // Initialize dashboard
                initDashboard();
                
                // Update last updated timestamp
                const now = new Date();
                document.getElementById('lastUpdated').textContent = now.toLocaleString();
                
                // Save to localStorage for persistence
                saveToLocalStorage();
                
                // Setup auto-refresh
                if (autoRefreshTimer) clearInterval(autoRefreshTimer);
                autoRefreshTimer = setInterval(refreshData, AUTO_REFRESH_INTERVAL);
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data from Google Sheets. Please check the URL and try again.');
            } finally {
                hideLoading();
            }
        }
        
        // Destroy existing charts
        function destroyCharts() {
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
        }
        
        // Modal functions
        function openModal(itemNumber) {
            const data = dataByItem[itemNumber];
            if (!data) return;
            
            document.getElementById('modalTitle').innerHTML = data.model + ' ' + sheetsIcon('modelModal', data.shortName);
            document.getElementById('modalItemNumber').textContent = `Item #: ${data.item}`;
            
            // Stats grid
            const plVal = data.netTotal;
            const plColor = plVal >= 0 ? '#81c784' : '#ef5350';
            const plText = plVal >= 0 ? '+$' + plVal.toLocaleString() : '-$' + Math.abs(plVal).toLocaleString();
            
            document.getElementById('modalStatsGrid').innerHTML = `
                <div class="modal-stat">
                    <div class="modal-stat-value">${data.sold.toLocaleString()}</div>
                    <div class="modal-stat-label">Units Sold</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value warning">${data.total.toLocaleString()}</div>
                    <div class="modal-stat-label">Total Repairs</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value ${data.repairRate === 'N/A' ? '' : parseFloat(data.repairRate) > 10 ? 'danger' : parseFloat(data.repairRate) > 5 ? 'warning' : 'success'}">${data.repairRate === 'N/A' ? 'N/A' : data.repairRate + '%'}</div>
                    <div class="modal-stat-label">Repair Rate</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value warning">$${data.totalCost.toLocaleString()}</div>
                    <div class="modal-stat-label">Total Repair Cost</div>
                    <div class="modal-stat-value" style="font-size: 0.95rem; color: #90caf9; margin-top: 2px;">$${data.totalEstimatedCost.toLocaleString()}</div>
                    <div class="modal-stat-label" style="font-size: 0.7rem; color: #78909c;">Estimated Cost</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${data.major.toLocaleString()}</div>
                    <div class="modal-stat-label">Major Repairs</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${data.minor.toLocaleString()}</div>
                    <div class="modal-stat-label">Minor Repairs</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${data.npu.toLocaleString()}</div>
                    <div class="modal-stat-label">NPU/NPF</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value purple">${data.accidentalPct}%</div>
                    <div class="modal-stat-label">Accidental %</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value success">${data.inWarrantyPct}%</div>
                    <div class="modal-stat-label">In Warranty %</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value" style="color: #4fc3f7;">$${data.warrantyRevenue.toLocaleString()}</div>
                    <div class="modal-stat-label">Warranty Revenue</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value" style="color: #ffb74d;">$${data.repairRevenue.toLocaleString()}</div>
                    <div class="modal-stat-label">Repair Revenue</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value" style="color: ${plColor};">${plText}</div>
                    <div class="modal-stat-label">Net P/L</div>
                </div>
            `;
            
            // Fleet averages
            const totalSold = allModelData.reduce((sum, d) => sum + d.sold, 0);
            const totalRepairs = allModelData.reduce((sum, d) => sum + d.total, 0);
            const totalAccidental = allModelData.reduce((sum, d) => sum + d.accidental, 0);
            const totalInWarranty = allModelData.reduce((sum, d) => sum + d.inWarranty, 0);
            const totalOutWarranty = allModelData.reduce((sum, d) => sum + d.outWarranty, 0);
            
            const fleetRepairRate = ((totalRepairs / totalSold) * 100).toFixed(2);
            const fleetAccidentalPct = ((totalAccidental / totalRepairs) * 100).toFixed(2);
            const fleetInWarrantyPct = ((totalInWarranty / (totalInWarranty + totalOutWarranty)) * 100).toFixed(2);
            
            const compareRate = (val, fleet, inverse = false) => {
                const diff = parseFloat(val) - parseFloat(fleet);
                const better = inverse ? diff > 0 : diff < 0;
                const color = better ? '#81c784' : '#ef5350';
                const arrow = diff > 0 ? '‚Üë' : '‚Üì';
                return `<span style="color: ${color}">${Math.abs(diff).toFixed(2)}% ${arrow}</span>`;
            };
            
            document.getElementById('comparisonContent').innerHTML = `
                <div class="comparison-item">
                    <span>Repair Rate</span>
                    <span>${data.repairRate === 'N/A' ? 'N/A (no sales data)' : data.repairRate + '% vs ' + fleetRepairRate + '% fleet avg ' + compareRate(data.repairRate, fleetRepairRate)}</span>
                </div>
                <div class="comparison-item">
                    <span>Accidental Damage</span>
                    <span>${data.accidentalPct}% vs ${fleetAccidentalPct}% fleet avg ${compareRate(data.accidentalPct, fleetAccidentalPct)}</span>
                </div>
                <div class="comparison-item">
                    <span>In Warranty</span>
                    <span>${data.inWarrantyPct}% vs ${fleetInWarrantyPct}% fleet avg ${compareRate(data.inWarrantyPct, fleetInWarrantyPct, true)}</span>
                </div>
                ${Object.keys(data.warrantyCodes).length > 0 ? `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <strong style="color: #e4e4e4;">üè∑Ô∏è Warranty Codes: <span style="font-weight: normal; font-size: 0.8em; color: #90a4ae;">(click to expand)</span></strong>
                    ${Object.entries(data.warrantyCodes).sort((a,b) => b[1].warrantyRev - a[1].warrantyRev).map(([code, cd]) => {
                        const detailId = 'wcDetail_' + code.replace(/[^a-zA-Z0-9]/g, '_');
                        return `
                        <div class="comparison-item wc-expandable" onclick="toggleWarrantyCodeDetail('${data.item}', '${code}', this)">
                            <span><span class="wc-arrow">‚ñ∂</span> ${code}</span>
                            <span>${cd.qtySold.toLocaleString()} sold @ $${cd.unitPrice.toFixed(2)}/ea = $${cd.warrantyRev.toLocaleString()} | ${cd.count} repairs | Cost: $${cd.cost.toLocaleString()} | Est: $${cd.estimatedCost.toLocaleString()}</span>
                        </div>
                        <div class="wc-detail" id="${detailId}"></div>`;
                    }).join('')}
                </div>` : ''}
            `;
            
            // Top repairs for this model
            const modelRepairs = repairCategories.modelRepairs[data.item] || [];
            document.getElementById('modalRepairTable').innerHTML = modelRepairs.map(([repair, count]) => `
                <tr>
                    <td>${repair}</td>
                    <td>${count.toLocaleString()}</td>
                    <td>${((count / data.total) * 100).toFixed(1)}%</td>
                </tr>
            `).join('') || '<tr><td colspan="3">No repair data available</td></tr>';
            
            document.getElementById('modelModal').classList.add('active');
        }
        
        // Toggle warranty code detail rows in model modal
        function toggleWarrantyCodeDetail(itemNumber, code, el) {
            const detailId = 'wcDetail_' + code.replace(/[^a-zA-Z0-9]/g, '_');
            const detailEl = document.getElementById(detailId);
            const parentRow = el.closest('.wc-expandable');
            
            if (detailEl.classList.contains('visible')) {
                detailEl.classList.remove('visible');
                parentRow.classList.remove('expanded');
                return;
            }
            
            parentRow.classList.add('expanded');
            
            // Check if already populated
            if (detailEl.dataset.loaded) {
                detailEl.classList.add('visible');
                return;
            }
            
            // If rawData is empty (cached load), fetch it first
            if (!rawData || rawData.length === 0) {
                detailEl.innerHTML = '<div style="color: #90a4ae; padding: 6px 0; font-size: 0.85rem;">Loading repair records...</div>';
                detailEl.classList.add('visible');
                fetchRawDataThen(() => populateWarrantyCodeDetail(detailEl, itemNumber, code));
                return;
            }
            
            populateWarrantyCodeDetail(detailEl, itemNumber, code);
            detailEl.classList.add('visible');
        }
        
        // Fetch raw CSV data on demand (for cached sessions)
        let rawDataFetchPromise = null;
        function fetchRawDataThen(callback) {
            if (rawData && rawData.length > 0) { callback(); return; }
            
            if (rawDataFetchPromise) {
                rawDataFetchPromise.then(callback);
                return;
            }
            
            rawDataFetchPromise = new Promise((resolve) => {
                Papa.parse(GOOGLE_SHEETS_URL, {
                    download: true,
                    header: true,
                    complete: function(results) {
                        rawData = results.data.filter(row => {
                            const dateStr = (row['Order Received Date'] || '').trim();
                            if (!dateStr) return false;
                            if (!(row['Model Name'] || '').trim() || 
                                (row['Model Name'] || '').trim().toLowerCase() === 'no match') return false;
                            if (!(row['Item Number'] || '').trim() || 
                                (row['Item Number'] || '').trim().toLowerCase() === 'no match') return false;
                            const rowDate = new Date(dateStr);
                            if (isNaN(rowDate.getTime())) return false;
                            if (rowDate < filterStartDate || rowDate > filterEndDate) return false;
                            return true;
                        });
                        console.log('Lazy-loaded rawData:', rawData.length, 'rows');
                        resolve();
                    },
                    error: function() {
                        console.error('Failed to lazy-load rawData');
                        resolve();
                    }
                });
            });
            
            rawDataFetchPromise.then(callback);
        }
        
        // Populate warranty code detail panel with repair records
        function populateWarrantyCodeDetail(detailEl, itemNumber, code) {
            const repairs = rawData.filter(row => {
                const ri = (row['Item Number'] || '').trim();
                const rc = (row['Warranty Code'] || '').trim();
                return ri === itemNumber && rc === code;
            });
            
            if (repairs.length === 0) {
                detailEl.innerHTML = '<div style="color: #90a4ae; padding: 6px 0; font-size: 0.85rem;">No individual repair records ‚Äî sales only (no repairs filed under this code)</div>';
            } else {
                const tableRows = repairs.slice(0, 50).map(r => {
                    const repair = (r['Repair'] || '').trim();
                    const isMajor = (r['Major Repairs'] || '').trim().toLowerCase() === 'yes';
                    const accDamage = (r['Accidental Damage'] || '').trim();
                    const cost = parseFloat(r['Costs']) || 0;
                    const costWithShipping = cost + SHIPPING_COST_PER_REPAIR;
                    const repRev = parseFloat(r['Repair Revenue']) || 0;
                    const orderId = (r['Order Id'] || '').trim();
                    const estCost = getEstimatedCost(repair);
                    const type = (repair.toLowerCase().includes('npu') || repair.toLowerCase().includes('npf')) ? 'NPU' : (isMajor ? 'Major' : 'Minor');
                    return `<tr>
                        <td>${orderId}</td>
                        <td title="${repair}">${repair.length > 35 ? repair.substring(0, 35) + '‚Ä¶' : repair}</td>
                        <td>${type}</td>
                        <td>${accDamage || 'No'}</td>
                        <td>$${Math.round(costWithShipping).toLocaleString()}</td>
                        <td>$${estCost}</td>
                        <td>$${Math.round(repRev).toLocaleString()}</td>
                    </tr>`;
                }).join('');
                
                detailEl.innerHTML = `
                    <table>
                        <thead><tr>
                            <th>Order Id</th><th>Repair</th><th>Type</th><th>Accidental</th><th>Cost</th><th>Est</th><th>Rev</th>
                        </tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                    ${repairs.length > 50 ? `<div style="color: #90a4ae; font-size: 0.8rem; padding: 4px 0;">Showing 50 of ${repairs.length} repairs</div>` : ''}
                `;
            }
            
            detailEl.dataset.loaded = '1';
        }
        
        function closeModal() {
            document.getElementById('modelModal').classList.remove('active');
        }
        
        // Pie Modal functions
        function openPieModal(category, index) {
            let title, subtitle, models, topRepairs, totalCount;
            
            // Reset table headers (KPI modals may have changed them)
            setPieModalHeaders('Repair Type', 'Count', '% of Category');
            
            const totalRepairs = allModelData.reduce((sum, d) => sum + d.total, 0);
            const totalMajor = allModelData.reduce((sum, d) => sum + d.major, 0);
            const totalMinor = allModelData.reduce((sum, d) => sum + d.minor, 0);
            const totalNPU = allModelData.reduce((sum, d) => sum + d.npu, 0);
            const totalAccidental = allModelData.reduce((sum, d) => sum + d.accidental, 0);
            const totalInWarranty = allModelData.reduce((sum, d) => sum + d.inWarranty, 0);
            const totalOutWarranty = allModelData.reduce((sum, d) => sum + d.outWarranty, 0);
            
            switch(category) {
                case 'repairType':
                    if (index === 0) { // Major
                        title = 'üîß Major Repairs';
                        totalCount = totalMajor;
                        models = allModelData.map(d => ({ name: d.shortName, count: d.major, item: d.item }))
                            .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        topRepairs = repairCategories.majorTop10;
                    } else if (index === 1) { // Minor
                        title = 'üîß Minor Repairs';
                        totalCount = totalMinor;
                        models = allModelData.map(d => ({ name: d.shortName, count: d.minor, item: d.item }))
                            .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        topRepairs = repairCategories.minorTop10;
                    } else { // NPU
                        title = 'üîß NPU/NPF Repairs';
                        totalCount = totalNPU;
                        models = allModelData.map(d => ({ name: d.shortName, count: d.npu, item: d.item }))
                            .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        topRepairs = repairCategories.npuTop10;
                    }
                    break;
                case 'accidental':
                    if (index === 0) { // Accidental
                        title = 'üí• Accidental Damage';
                        totalCount = totalAccidental;
                        models = allModelData.map(d => ({ name: d.shortName, count: d.accidental, item: d.item }))
                            .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        topRepairs = repairCategories.accidentalTop10;
                    } else { // Non-Accidental
                        title = 'üîß Non-Accidental Damage';
                        totalCount = totalRepairs - totalAccidental;
                        models = allModelData.map(d => ({ name: d.shortName, count: d.total - d.accidental, item: d.item }))
                            .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        topRepairs = repairCategories.nonAccidentalTop10;
                    }
                    break;
                case 'warrantyStatus':
                    if (index === 0) { // In Warranty
                        title = 'üìã In Warranty Repairs';
                        totalCount = totalInWarranty;
                        models = allModelData.map(d => ({ name: d.shortName, count: d.inWarranty, item: d.item }))
                            .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        topRepairs = []; // Per-row warranty classification no longer available
                    } else { // Out of Warranty
                        title = 'üìã Out of Warranty Repairs';
                        totalCount = totalOutWarranty;
                        models = allModelData.map(d => ({ name: d.shortName, count: d.outWarranty, item: d.item }))
                            .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        topRepairs = []; // Per-row warranty classification no longer available
                    }
                    break;
                case 'warrantyCost':
                    {
                        const costModels = allModelData.map(d => {
                            const avgCpr = d.total > 0 ? d.totalCost / d.total : 0;
                            const inCost = Math.round(d.inWarranty * avgCpr);
                            const outCost = Math.round(d.outWarranty * avgCpr);
                            return { name: d.shortName, item: d.item, inCost, outCost };
                        });
                        if (index === 0) { // In Warranty Cost
                            title = 'üí∞ In Warranty Repair Costs';
                            const totalInCost = costModels.reduce((s, m) => s + m.inCost, 0);
                            totalCount = totalInCost;
                            models = costModels.map(m => ({ name: m.name, count: m.inCost, item: m.item }))
                                .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        } else { // Out of Warranty Cost
                            title = 'üí∞ Out of Warranty Repair Costs';
                            const totalOutCost = costModels.reduce((s, m) => s + m.outCost, 0);
                            totalCount = totalOutCost;
                            models = costModels.map(m => ({ name: m.name, count: m.outCost, item: m.item }))
                                .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        }
                        topRepairs = [];
                        subtitle = `$${totalCount.toLocaleString()} total cost in this category`;
                        document.getElementById('pieModalTitle').innerHTML = title + ' ' + sheetsIcon('pieModal', 'Warranty_Cost');
                        document.getElementById('pieModalSubtitle').textContent = subtitle;
                        const totalAllCost = allModelData.reduce((sum, d) => sum + d.totalCost, 0);
                        document.getElementById('pieModalStats').innerHTML = `
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                <div class="modal-stat">
                                    <div class="modal-stat-value">$${totalCount.toLocaleString()}</div>
                                    <div class="modal-stat-label">Total Cost</div>
                                </div>
                                <div class="modal-stat">
                                    <div class="modal-stat-value">${models.length}</div>
                                    <div class="modal-stat-label">Models Affected</div>
                                </div>
                                <div class="modal-stat">
                                    <div class="modal-stat-value">${totalAllCost > 0 ? ((totalCount / totalAllCost) * 100).toFixed(1) : 0}%</div>
                                    <div class="modal-stat-label">% of All Costs</div>
                                </div>
                            </div>
                        `;
                        document.getElementById('pieModalRepairTable').innerHTML = '<tr><td colspan="3">Cost breakdown not available at repair level</td></tr>';
                        document.getElementById('pieModalModelTable').innerHTML = models.slice(0, 15).map(m => `
                            <tr onclick="closePieModal(); openModal('${m.item}')" style="cursor: pointer;">
                                <td>${m.name}</td>
                                <td>$${m.count.toLocaleString()}</td>
                                <td>${totalCount > 0 ? ((m.count / totalCount) * 100).toFixed(1) : 0}%</td>
                            </tr>
                        `).join('');
                        document.querySelector('#pieModal .top-repairs h4').textContent = 'üí∞ Cost Breakdown';
                        document.querySelector('#pieModal h4:last-of-type').style.display = '';
                        document.getElementById('pieModalModelTable').parentElement.style.display = '';
                        document.getElementById('pieModal').classList.add('active');
                        return;
                    }
                case 'customerCost':
                    {
                        const topCusts = customerData.slice(0, 10);
                        const otherCusts = customerData.slice(10);
                        const totalCustCost = customerData.reduce((sum, c) => sum + c.cost, 0);
                        const totalCustEstCost = customerData.reduce((sum, c) => sum + c.estimatedCost, 0);
                        const totalCustRepairs = customerData.reduce((sum, c) => sum + c.repairs, 0);
                        
                        let selectedCust;
                        if (index < topCusts.length) {
                            selectedCust = topCusts[index];
                        } else {
                            // "Other" segment clicked ‚Äî show summary
                            selectedCust = {
                                name: 'Other Customers',
                                repairs: otherCusts.reduce((sum, c) => sum + c.repairs, 0),
                                cost: otherCusts.reduce((sum, c) => sum + c.cost, 0),
                                estimatedCost: otherCusts.reduce((sum, c) => sum + c.estimatedCost, 0),
                                repairRevenue: otherCusts.reduce((sum, c) => sum + c.repairRevenue, 0),
                                modelCount: new Set(otherCusts.flatMap(c => c.models)).size,
                                models: []
                            };
                        }
                        
                        title = 'üíµ ' + selectedCust.name;
                        subtitle = `$${selectedCust.cost.toLocaleString()} repair cost ‚Äî ${selectedCust.repairs.toLocaleString()} repairs across ${selectedCust.modelCount} models`;
                        document.getElementById('pieModalTitle').innerHTML = title + ' ' + sheetsIcon('pieModal', 'Customer_' + selectedCust.name.replace(/[^a-z0-9]/gi, '_').substring(0, 30));
                        document.getElementById('pieModalSubtitle').textContent = subtitle;
                        document.getElementById('pieModalStats').innerHTML = `
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                                <div class="modal-stat">
                                    <div class="modal-stat-value warning">${selectedCust.repairs.toLocaleString()}</div>
                                    <div class="modal-stat-label">Total Repairs</div>
                                </div>
                                <div class="modal-stat">
                                    <div class="modal-stat-value" style="color: #ef5350;">$${selectedCust.cost.toLocaleString()}</div>
                                    <div class="modal-stat-label">Repair Cost</div>
                                    <div class="modal-stat-value" style="font-size: 0.95rem; color: #90caf9; margin-top: 2px;">$${selectedCust.estimatedCost.toLocaleString()}</div>
                                    <div class="modal-stat-label" style="font-size: 0.7rem; color: #78909c;">Estimated</div>
                                </div>
                                <div class="modal-stat">
                                    <div class="modal-stat-value" style="color: #ffb74d;">$${selectedCust.repairRevenue.toLocaleString()}</div>
                                    <div class="modal-stat-label">Repair Revenue</div>
                                </div>
                                <div class="modal-stat">
                                    <div class="modal-stat-value">${selectedCust.modelCount}</div>
                                    <div class="modal-stat-label">Models</div>
                                </div>
                            </div>
                        `;
                        
                        // Show top customers table (all customers, not just this one)
                        setPieModalHeaders('Customer', 'Cost', '% of Total');
                        document.getElementById('pieModalRepairTable').innerHTML = topCusts.map((c, i) => `
                            <tr style="cursor: pointer; ${i === index ? 'background: rgba(79,195,247,0.15);' : ''}" onclick="closePieModal(); openPieModal('customerCost', ${i})">
                                <td>${c.name.length > 40 ? c.name.substring(0, 38) + '‚Ä¶' : c.name}</td>
                                <td>$${c.cost.toLocaleString()}</td>
                                <td>${totalCustCost > 0 ? ((c.cost / totalCustCost) * 100).toFixed(1) : 0}%</td>
                            </tr>
                        `).join('');
                        document.querySelector('#pieModal .top-repairs h4').textContent = 'üíµ Top Customers by Repair Cost';
                        // Hide model table section
                        document.querySelector('#pieModal h4:last-of-type').style.display = 'none';
                        document.getElementById('pieModalModelTable').parentElement.style.display = 'none';
                        document.getElementById('pieModal').classList.add('active');
                        return;
                    }
                default:
                    return;
            }
            
            subtitle = `${totalCount.toLocaleString()} total repairs in this category`;
            
            document.getElementById('pieModalTitle').innerHTML = title + ' ' + sheetsIcon('pieModal', category + '_' + index);
            document.getElementById('pieModalSubtitle').textContent = subtitle;
            
            document.getElementById('pieModalStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div class="modal-stat">
                        <div class="modal-stat-value">${totalCount.toLocaleString()}</div>
                        <div class="modal-stat-label">Total in Category</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${models.length}</div>
                        <div class="modal-stat-label">Models Affected</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${((totalCount / totalRepairs) * 100).toFixed(1)}%</div>
                        <div class="modal-stat-label">% of All Repairs</div>
                    </div>
                </div>
            `;
            
            // Top repairs table
            document.getElementById('pieModalRepairTable').innerHTML = (topRepairs || []).map(([repair, count]) => `
                <tr>
                    <td>${repair}</td>
                    <td>${count.toLocaleString()}</td>
                    <td>${((count / totalCount) * 100).toFixed(1)}%</td>
                </tr>
            `).join('') || '<tr><td colspan="3">No data available</td></tr>';
            
            // Models table
            document.getElementById('pieModalModelTable').innerHTML = models.slice(0, 15).map(m => `
                <tr onclick="closePieModal(); openModal('${m.item}')" style="cursor: pointer;">
                    <td>${m.name}</td>
                    <td>${m.count.toLocaleString()}</td>
                    <td>${((m.count / totalCount) * 100).toFixed(1)}%</td>
                </tr>
            `).join('');
            
            // Restore model table visibility (may have been hidden by KPI modal)
            document.querySelector('#pieModal h4:last-of-type').style.display = '';
            document.getElementById('pieModalModelTable').parentElement.style.display = '';
            
            document.getElementById('pieModal').classList.add('active');
        }
        
        function closePieModal() {
            document.getElementById('pieModal').classList.remove('active');
        }
        
        // Warranty Code Modal functions
        function openWarrantyCodeModal(code) {
            if (!allModelData || allModelData.length === 0) return;
            
            // Gather all models with this warranty code (either repairs or sales)
            const modelsWithCode = [];
            let totalCount = 0, totalCost = 0, totalWarrantyRev = 0, totalRepairRev = 0, totalQtySold = 0;
            let unitPrice = 0;
            
            allModelData.forEach(d => {
                const codeData = d.warrantyCodes[code];
                if (codeData && (codeData.count > 0 || codeData.qtySold > 0)) {
                    const net = codeData.warrantyRev + codeData.repairRev - codeData.cost;
                    
                    if (codeData.unitPrice > 0 && unitPrice === 0) {
                        unitPrice = codeData.unitPrice;
                    }
                    
                    modelsWithCode.push({
                        model: d.shortName,
                        item: d.item,
                        qtySold: codeData.qtySold,
                        unitPrice: codeData.unitPrice,
                        count: codeData.count,
                        cost: codeData.cost,
                        warrantyRev: codeData.warrantyRev,
                        repairRev: codeData.repairRev,
                        net: Math.round(net)
                    });
                    totalCount += codeData.count;
                    totalCost += codeData.cost;
                    totalWarrantyRev += codeData.warrantyRev;
                    totalRepairRev += codeData.repairRev;
                    totalQtySold += codeData.qtySold;
                }
            });
            
            modelsWithCode.sort((a, b) => b.count - a.count);
            
            const totalNet = totalWarrantyRev + totalRepairRev - totalCost;
            const plFmt = (v) => v >= 0 ? '+$' + Math.round(v).toLocaleString() : '-$' + Math.abs(Math.round(v)).toLocaleString();
            const plColor = (v) => v >= 0 ? '#81c784' : '#ef5350';
            
            document.getElementById('warrantyCodeModalTitle').innerHTML = `üè∑Ô∏è ${code} ‚Äî Device Breakdown ` + sheetsIcon('warrantyCodeModal', 'WarrantyCode_' + code);
            document.getElementById('warrantyCodeModalSubtitle').textContent = `${totalQtySold.toLocaleString()} warranties sold | ${totalCount.toLocaleString()} repairs across ${modelsWithCode.length} models`;
            
            document.getElementById('warrantyCodeModalStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div class="modal-stat">
                        <div class="modal-stat-value">${totalQtySold.toLocaleString()}</div>
                        <div class="modal-stat-label">Warranties Sold</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value" style="color: #4fc3f7;">$${unitPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="modal-stat-label">Sell Price</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${totalCount.toLocaleString()}</div>
                        <div class="modal-stat-label">Total Repairs</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value" style="color: #ef5350;">$${totalCost.toLocaleString()}</div>
                        <div class="modal-stat-label">Total Cost</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value" style="color: #4fc3f7;">$${totalWarrantyRev.toLocaleString()}</div>
                        <div class="modal-stat-label">Warranty Revenue</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value" style="color: ${plColor(totalNet)};">${plFmt(totalNet)}</div>
                        <div class="modal-stat-label">Net P/L</div>
                    </div>
                </div>
            `;
            
            document.getElementById('warrantyCodeModalTableTitle').textContent = `üìã Devices with ${code}`;
            document.getElementById('warrantyCodeModalTable').innerHTML = modelsWithCode.map(m => `
                <tr onclick="closeWarrantyCodeModal(); openModal('${m.item}')" style="cursor: pointer;">
                    <td>${m.model}</td>
                    <td>${m.qtySold.toLocaleString()}</td>
                    <td>$${m.unitPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${m.count.toLocaleString()}</td>
                    <td>$${m.cost.toLocaleString()}</td>
                    <td>$${m.warrantyRev.toLocaleString()}</td>
                    <td>$${m.repairRev.toLocaleString()}</td>
                    <td style="color: ${plColor(m.net)};">${plFmt(m.net)}</td>
                </tr>
            `).join('') || '<tr><td colspan="8">No devices found</td></tr>';
            
            document.getElementById('warrantyCodeModal').classList.add('active');
        }
        
        function closeWarrantyCodeModal() {
            document.getElementById('warrantyCodeModal').classList.remove('active');
        }
        
        // KPI Modal function
        // Helper: set pie modal table column headers
        function setPieModalHeaders(col1, col2, col3) {
            document.getElementById('pieModalCol1Header').textContent = col1 || 'Repair Type';
            document.getElementById('pieModalCol2Header').textContent = col2 || 'Count';
            document.getElementById('pieModalCol3Header').textContent = col3 || '% of Category';
        }
        
        // Helper: build year breakdown HTML from allModelData yearly aggregation
        function buildYearBreakdownHTML(type) {
            const yearTotals = {};
            allModelData.forEach(d => {
                if (type === 'unitsSold') {
                    Object.entries(d.yearlySold || {}).forEach(([yr, qty]) => {
                        if (!yearTotals[yr]) yearTotals[yr] = 0;
                        yearTotals[yr] += qty;
                    });
                } else if (type === 'warrantyRevenue') {
                    Object.entries(d.yearlyWarrantyRevenue || {}).forEach(([yr, rev]) => {
                        if (!yearTotals[yr]) yearTotals[yr] = 0;
                        yearTotals[yr] += rev;
                    });
                } else {
                    // All repair-based types use yearlyRepairs
                    Object.entries(d.yearlyRepairs || {}).forEach(([yr, yrData]) => {
                        if (!yearTotals[yr]) yearTotals[yr] = { repairs: 0, cost: 0, estimatedCost: 0, repairRevenue: 0, major: 0, minor: 0, npu: 0, accidental: 0, majorCost: 0, minorCost: 0, npuCost: 0, inWarranty: 0, outWarranty: 0 };
                        const t = yearTotals[yr];
                        t.repairs += yrData.repairs;
                        t.cost += yrData.cost;
                        t.estimatedCost += yrData.estimatedCost;
                        t.repairRevenue += yrData.repairRevenue;
                        t.major += yrData.major || 0;
                        t.minor += yrData.minor || 0;
                        t.npu += yrData.npu || 0;
                        t.accidental += yrData.accidental || 0;
                        t.majorCost += yrData.majorCost || 0;
                        t.minorCost += yrData.minorCost || 0;
                        t.npuCost += yrData.npuCost || 0;
                        t.inWarranty += yrData.inWarranty || 0;
                        t.outWarranty += yrData.outWarranty || 0;
                    });
                }
            });
            
            // Also merge unitsSold per year for repair rate calculation
            let yearSold = {};
            if (type === 'repairRate') {
                allModelData.forEach(d => {
                    Object.entries(d.yearlySold || {}).forEach(([yr, qty]) => {
                        if (!yearSold[yr]) yearSold[yr] = 0;
                        yearSold[yr] += qty;
                    });
                });
            }
            
            const sortedYears = Object.keys(yearTotals).sort();
            if (sortedYears.length === 0) return '';
            
            let heading, headers, rowFn;
            
            switch(type) {
                case 'unitsSold': {
                    const total = sortedYears.reduce((sum, yr) => sum + yearTotals[yr], 0);
                    heading = 'üìÖ Units Sold by Year';
                    headers = '<th>Year</th><th>Units Sold</th><th>% of Total</th>';
                    rowFn = yr => `<tr><td><strong>${yr}</strong></td><td>${yearTotals[yr].toLocaleString()}</td><td>${total > 0 ? ((yearTotals[yr] / total) * 100).toFixed(1) : 0}%</td></tr>`;
                    break;
                }
                case 'warrantyRevenue': {
                    const total = sortedYears.reduce((sum, yr) => sum + yearTotals[yr], 0);
                    heading = 'üìÖ Warranty Revenue by Year';
                    headers = '<th>Year</th><th>Revenue</th><th>% of Total</th>';
                    rowFn = yr => `<tr><td><strong>${yr}</strong></td><td>$${Math.round(yearTotals[yr]).toLocaleString()}</td><td>${total > 0 ? ((yearTotals[yr] / total) * 100).toFixed(1) : 0}%</td></tr>`;
                    break;
                }
                case 'repairs': {
                    const total = sortedYears.reduce((sum, yr) => sum + yearTotals[yr].repairs, 0);
                    heading = 'üìÖ Repairs by Year';
                    headers = '<th>Year</th><th>Repairs</th><th>Major</th><th>Minor</th><th>NPU/NPF</th><th>% of Total</th>';
                    rowFn = yr => {
                        const y = yearTotals[yr];
                        return `<tr><td><strong>${yr}</strong></td><td>${y.repairs.toLocaleString()}</td><td>${y.major.toLocaleString()}</td><td>${y.minor.toLocaleString()}</td><td>${y.npu.toLocaleString()}</td><td>${total > 0 ? ((y.repairs / total) * 100).toFixed(1) : 0}%</td></tr>`;
                    };
                    break;
                }
                case 'repairRate': {
                    heading = 'üìÖ Repair Rate by Year';
                    headers = '<th>Year</th><th>Repairs</th><th>Units Sold</th><th>Repair Rate</th>';
                    rowFn = yr => {
                        const y = yearTotals[yr];
                        const sold = yearSold[yr] || 0;
                        const rate = sold > 0 ? ((y.repairs / sold) * 100).toFixed(2) : 'N/A';
                        return `<tr><td><strong>${yr}</strong></td><td>${y.repairs.toLocaleString()}</td><td>${sold.toLocaleString()}</td><td>${rate === 'N/A' ? 'N/A' : rate + '%'}</td></tr>`;
                    };
                    break;
                }
                case 'totalCost': {
                    const total = sortedYears.reduce((sum, yr) => sum + yearTotals[yr].cost, 0);
                    heading = 'üìÖ Repair Costs by Year';
                    headers = '<th>Year</th><th>Actual Cost</th><th>Est. Cost</th><th>Major</th><th>Minor</th><th>NPU/NPF</th><th>% of Total</th>';
                    rowFn = yr => {
                        const y = yearTotals[yr];
                        return `<tr><td><strong>${yr}</strong></td><td>$${Math.round(y.cost).toLocaleString()}</td><td>$${Math.round(y.estimatedCost).toLocaleString()}</td><td>$${Math.round(y.majorCost).toLocaleString()}</td><td>$${Math.round(y.minorCost).toLocaleString()}</td><td>$${Math.round(y.npuCost).toLocaleString()}</td><td>${total > 0 ? ((y.cost / total) * 100).toFixed(1) : 0}%</td></tr>`;
                    };
                    break;
                }
                case 'accidental': {
                    const total = sortedYears.reduce((sum, yr) => sum + yearTotals[yr].accidental, 0);
                    heading = 'üìÖ Accidental Damage by Year';
                    headers = '<th>Year</th><th>Accidental</th><th>Total Repairs</th><th>Accidental %</th><th>% of All Accidental</th>';
                    rowFn = yr => {
                        const y = yearTotals[yr];
                        const pct = y.repairs > 0 ? ((y.accidental / y.repairs) * 100).toFixed(1) : '0.0';
                        return `<tr><td><strong>${yr}</strong></td><td>${y.accidental.toLocaleString()}</td><td>${y.repairs.toLocaleString()}</td><td>${pct}%</td><td>${total > 0 ? ((y.accidental / total) * 100).toFixed(1) : 0}%</td></tr>`;
                    };
                    break;
                }
                case 'repairRevenue': {
                    const total = sortedYears.reduce((sum, yr) => sum + yearTotals[yr].repairRevenue, 0);
                    heading = 'üìÖ Repair Revenue (OOW) by Year';
                    headers = '<th>Year</th><th>Revenue</th><th>% of Total</th>';
                    rowFn = yr => {
                        const y = yearTotals[yr];
                        return `<tr><td><strong>${yr}</strong></td><td>$${Math.round(y.repairRevenue).toLocaleString()}</td><td>${total > 0 ? ((y.repairRevenue / total) * 100).toFixed(1) : 0}%</td></tr>`;
                    };
                    break;
                }
                case 'warrantyStatus': {
                    const totalIn = sortedYears.reduce((sum, yr) => sum + yearTotals[yr].inWarranty, 0);
                    const totalOut = sortedYears.reduce((sum, yr) => sum + yearTotals[yr].outWarranty, 0);
                    const totalAll = totalIn + totalOut;
                    const totalInPct = totalAll > 0 ? ((totalIn / totalAll) * 100).toFixed(1) : '0.0';
                    const totalOutPct = totalAll > 0 ? ((totalOut / totalAll) * 100).toFixed(1) : '0.0';
                    return `
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="color: #4fc3f7; margin-bottom: 10px;">üìã In Warranty vs Out of Warranty by Year</h4>
                            <table class="repair-table">
                                <thead><tr><th>Year</th><th>In Warranty</th><th>Out of Warranty</th><th>Total</th><th>In Warranty %</th><th>OOW %</th></tr></thead>
                                <tbody>
                                    ${sortedYears.map(yr => {
                                        const y = yearTotals[yr];
                                        const yrTotal = y.inWarranty + y.outWarranty;
                                        const inPct = yrTotal > 0 ? ((y.inWarranty / yrTotal) * 100).toFixed(1) : '0.0';
                                        const outPct = yrTotal > 0 ? ((y.outWarranty / yrTotal) * 100).toFixed(1) : '0.0';
                                        return `<tr><td><strong>${yr}</strong></td><td style="color:#4ade80">${y.inWarranty.toLocaleString()}</td><td style="color:#f87171">${y.outWarranty.toLocaleString()}</td><td>${yrTotal.toLocaleString()}</td><td>${inPct}%</td><td>${outPct}%</td></tr>`;
                                    }).join('')}
                                    <tr style="border-top: 2px solid rgba(255,255,255,0.3); font-weight: bold;">
                                        <td><strong>Total</strong></td>
                                        <td style="color:#4ade80">${totalIn.toLocaleString()}</td>
                                        <td style="color:#f87171">${totalOut.toLocaleString()}</td>
                                        <td>${totalAll.toLocaleString()}</td>
                                        <td>${totalInPct}%</td>
                                        <td>${totalOutPct}%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                case 'netPL': {
                    // Need warranty revenue by year too
                    const yrWarRev = {};
                    allModelData.forEach(d => {
                        Object.entries(d.yearlyWarrantyRevenue || {}).forEach(([yr, rev]) => {
                            if (!yrWarRev[yr]) yrWarRev[yr] = 0;
                            yrWarRev[yr] += rev;
                        });
                    });
                    // Combine all years from both sources
                    Object.keys(yrWarRev).forEach(yr => {
                        if (!yearTotals[yr]) yearTotals[yr] = { repairs: 0, cost: 0, estimatedCost: 0, repairRevenue: 0, major: 0, minor: 0, npu: 0, accidental: 0, majorCost: 0, minorCost: 0, npuCost: 0, inWarranty: 0, outWarranty: 0 };
                    });
                    const allYears = [...new Set([...Object.keys(yearTotals), ...Object.keys(yrWarRev)])].sort();
                    heading = 'üìÖ Net P/L by Year';
                    headers = '<th>Year</th><th>Warranty Rev</th><th>Repair Rev</th><th>Total Cost</th><th>Net P/L</th>';
                    const plColor = v => v >= 0 ? '#81c784' : '#ef5350';
                    const plFmt2 = v => v >= 0 ? '+$' + v.toLocaleString() : '-$' + Math.abs(v).toLocaleString();
                    return `
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="color: #4fc3f7; margin-bottom: 10px;">${heading}</h4>
                            <table class="repair-table">
                                <thead><tr>${headers}</tr></thead>
                                <tbody>
                                    ${allYears.map(yr => {
                                        const y = yearTotals[yr] || { cost: 0, repairRevenue: 0 };
                                        const wRev = Math.round(yrWarRev[yr] || 0);
                                        const rRev = Math.round(y.repairRevenue);
                                        const cost = Math.round(y.cost);
                                        const net = wRev + rRev - cost;
                                        return `<tr><td><strong>${yr}</strong></td><td>$${wRev.toLocaleString()}</td><td>$${rRev.toLocaleString()}</td><td>$${cost.toLocaleString()}</td><td style="color: ${plColor(net)};">${plFmt2(net)}</td></tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                default:
                    return '';
            }
            
            return `
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #4fc3f7; margin-bottom: 10px;">${heading}</h4>
                    <table class="repair-table">
                        <thead><tr>${headers}</tr></thead>
                        <tbody>${sortedYears.map(rowFn).join('')}</tbody>
                    </table>
                </div>
            `;
        }
        
        function openKpiModal(kpiType) {
            if (!allModelData || allModelData.length === 0) {
                alert('Please load data first by clicking the Refresh button.');
                return;
            }
            
            let title, subtitle, models, totalValue;
            
            // Reset table headers to defaults (overridden per KPI type as needed)
            setPieModalHeaders('Device', 'Count', '% of Category');
            
            const totalSold = allModelData.reduce((sum, d) => sum + d.sold, 0);
            const totalRepairs = allModelData.reduce((sum, d) => sum + d.total, 0);
            const totalCost = allModelData.reduce((sum, d) => sum + d.totalCost, 0);
            const totalEstimatedCost = allModelData.reduce((sum, d) => sum + d.totalEstimatedCost, 0);
            const totalAccidental = allModelData.reduce((sum, d) => sum + d.accidental, 0);
            const totalInWarranty = allModelData.reduce((sum, d) => sum + d.inWarranty, 0);
            const totalOutWarranty = allModelData.reduce((sum, d) => sum + d.outWarranty, 0);
            
            switch(kpiType) {
                case 'unitsSold':
                    title = 'üì¶ Total Units Sold Breakdown';
                    subtitle = `${totalSold.toLocaleString()} total units across ${allModelData.length} models`;
                    models = [...allModelData].sort((a, b) => b.sold - a.sold);
                    totalValue = totalSold;
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value">${totalSold.toLocaleString()}</div>
                                <div class="modal-stat-label">Total Units Sold</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value">${allModelData.length}</div>
                                <div class="modal-stat-label">Models</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value">${Math.round(totalSold / allModelData.length).toLocaleString()}</div>
                                <div class="modal-stat-label">Avg per Model</div>
                            </div>
                        </div>
                        ${buildYearBreakdownHTML('unitsSold')}
                    `;
                    setPieModalHeaders('Device', 'Units Sold', '% of Total');
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td>${d.sold.toLocaleString()}</td>
                            <td>${((d.sold / totalSold) * 100).toFixed(1)}%</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üì¶ Top Models by Units Sold';
                    break;
                    
                case 'totalRepairs':
                    title = 'üîß Total Repairs Breakdown';
                    subtitle = `${totalRepairs.toLocaleString()} total repairs across ${allModelData.length} models`;
                    models = [...allModelData].sort((a, b) => b.total - a.total);
                    totalValue = totalRepairs;
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value warning">${totalRepairs.toLocaleString()}</div>
                                <div class="modal-stat-label">Total Repairs</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value">${allModelData.length}</div>
                                <div class="modal-stat-label">Models</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value">${Math.round(totalRepairs / allModelData.length).toLocaleString()}</div>
                                <div class="modal-stat-label">Avg per Model</div>
                            </div>
                        </div>
                        ${buildYearBreakdownHTML('repairs')}
                        ${buildYearBreakdownHTML('warrantyStatus')}
                    `;
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td>${d.total.toLocaleString()}</td>
                            <td>${((d.total / totalRepairs) * 100).toFixed(1)}%</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üîß Top Models by Total Repairs';
                    break;
                    
                case 'repairRate':
                    title = 'üìä Repair Rate Breakdown';
                    const avgRate = ((totalRepairs / totalSold) * 100).toFixed(2);
                    subtitle = `${avgRate}% overall repair rate`;
                    models = [...allModelData].filter(d => d.sold > 0).sort((a, b) => parseFloat(b.repairRate) - parseFloat(a.repairRate));
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value danger">${avgRate}%</div>
                                <div class="modal-stat-label">Overall Repair Rate</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value danger">${models[0]?.repairRate || 0}%</div>
                                <div class="modal-stat-label">Highest Rate</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value success">${models[models.length-1]?.repairRate || 0}%</div>
                                <div class="modal-stat-label">Lowest Rate</div>
                            </div>
                        </div>
                        ${buildYearBreakdownHTML('repairRate')}
                    `;
                    setPieModalHeaders('Device', 'Rate', 'Repairs / Sold');
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td>${d.repairRate}%</td>
                            <td>${d.total.toLocaleString()} / ${d.sold.toLocaleString()}</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üìä Models by Repair Rate (Highest First)';
                    break;
                    
                case 'totalCost':
                    title = 'üí∞ Repair Cost Breakdown';
                    subtitle = `$${totalCost.toLocaleString()} total repair cost | $${totalEstimatedCost.toLocaleString()} estimated`;
                    models = [...allModelData].sort((a, b) => b.totalCost - a.totalCost);
                    const totalMajorCost = allModelData.reduce((sum, d) => sum + d.majorCost, 0);
                    const totalMinorCost = allModelData.reduce((sum, d) => sum + d.minorCost, 0);
                    const totalNpuCost = allModelData.reduce((sum, d) => sum + d.npuCost, 0);
                    const avgPerRepair = totalRepairs > 0 ? Math.round(totalCost / totalRepairs) : 0;
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value warning">$${totalCost.toLocaleString()}</div>
                                <div class="modal-stat-label">Total Cost</div>
                                <div class="modal-stat-value" style="font-size: 0.95rem; color: #90caf9; margin-top: 2px;">$${totalEstimatedCost.toLocaleString()}</div>
                                <div class="modal-stat-label" style="font-size: 0.7rem; color: #78909c;">Estimated</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value" style="color: #ef5350;">$${totalMajorCost.toLocaleString()}</div>
                                <div class="modal-stat-label">Major Repairs</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value" style="color: #ffb74d;">$${totalMinorCost.toLocaleString()}</div>
                                <div class="modal-stat-label">Minor Repairs</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value" style="color: #4fc3f7;">$${avgPerRepair.toLocaleString()}</div>
                                <div class="modal-stat-label">Avg per Repair</div>
                            </div>
                        </div>
                        ${buildYearBreakdownHTML('totalCost')}
                    `;
                    setPieModalHeaders('Device', 'Cost', '% of Total');
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td>$${d.totalCost.toLocaleString()}</td>
                            <td>${((d.totalCost / totalCost) * 100).toFixed(1)}%</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üí∞ Top Models by Repair Cost';
                    break;
                    
                case 'accidental':
                    title = 'üí• Accidental Damage Breakdown';
                    const accidentalPct = ((totalAccidental / totalRepairs) * 100).toFixed(1);
                    subtitle = `${accidentalPct}% of repairs are accidental (${totalAccidental.toLocaleString()} repairs)`;
                    models = [...allModelData].sort((a, b) => b.accidental - a.accidental);
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value purple">${totalAccidental.toLocaleString()}</div>
                                <div class="modal-stat-label">Accidental Repairs</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value">${(totalRepairs - totalAccidental).toLocaleString()}</div>
                                <div class="modal-stat-label">Non-Accidental</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value purple">${accidentalPct}%</div>
                                <div class="modal-stat-label">Accidental Rate</div>
                            </div>
                        </div>
                        ${buildYearBreakdownHTML('accidental')}
                    `;
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td>${d.accidental.toLocaleString()}</td>
                            <td>${d.accidentalPct}%</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üí• Top Models by Accidental Repairs';
                    break;
                    
                case 'inWarranty':
                    title = 'üìã Warranty Status Breakdown';
                    const inWarrantyPct = ((totalInWarranty / (totalInWarranty + totalOutWarranty)) * 100).toFixed(1);
                    subtitle = `${inWarrantyPct}% of repairs are in warranty (${totalInWarranty.toLocaleString()} repairs)`;
                    models = [...allModelData].sort((a, b) => b.inWarranty - a.inWarranty);
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value success">${totalInWarranty.toLocaleString()}</div>
                                <div class="modal-stat-label">In Warranty</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value danger">${totalOutWarranty.toLocaleString()}</div>
                                <div class="modal-stat-label">Out of Warranty</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value success">${inWarrantyPct}%</div>
                                <div class="modal-stat-label">In Warranty Rate</div>
                            </div>
                        </div>
                        ${buildYearBreakdownHTML('warrantyStatus')}
                    `;
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td>${d.inWarranty.toLocaleString()}</td>
                            <td>${d.inWarrantyPct}%</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üìã Top Models by In Warranty Repairs';
                    break;
                    
                case 'warrantyRevenue':
                    const totWarRev = allModelData.reduce((sum, d) => sum + d.warrantyRevenue, 0);
                    title = 'üíµ Warranty Revenue Breakdown';
                    subtitle = `$${totWarRev.toLocaleString()} total warranty revenue`;
                    models = [...allModelData].sort((a, b) => b.warrantyRevenue - a.warrantyRevenue);
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value" style="color: #4fc3f7;">$${totWarRev.toLocaleString()}</div>
                                <div class="modal-stat-label">Total Warranty Revenue</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value">${allModelData.filter(d => d.warrantyRevenue > 0).length}</div>
                                <div class="modal-stat-label">Models with Revenue</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value">$${totalRepairs > 0 ? Math.round(totWarRev / totalRepairs).toLocaleString() : '0'}</div>
                                <div class="modal-stat-label">Avg per Repair</div>
                            </div>
                        </div>
                        ${buildYearBreakdownHTML('warrantyRevenue')}
                    `;
                    setPieModalHeaders('Device', 'Revenue', '% of Total');
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td>$${d.warrantyRevenue.toLocaleString()}</td>
                            <td>${totWarRev > 0 ? ((d.warrantyRevenue / totWarRev) * 100).toFixed(1) : 0}%</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üíµ Top Models by Warranty Revenue';
                    break;
                    
                case 'repairRevenue':
                    const totRepRev = allModelData.reduce((sum, d) => sum + d.repairRevenue, 0);
                    title = 'üîß Repair Revenue Breakdown (OOW)';
                    subtitle = `$${totRepRev.toLocaleString()} total out-of-warranty repair revenue`;
                    models = [...allModelData].sort((a, b) => b.repairRevenue - a.repairRevenue);
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value" style="color: #ffb74d;">$${totRepRev.toLocaleString()}</div>
                                <div class="modal-stat-label">Total Repair Revenue</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value">${allModelData.filter(d => d.repairRevenue > 0).length}</div>
                                <div class="modal-stat-label">Models with Revenue</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value">${totalOutWarranty.toLocaleString()}</div>
                                <div class="modal-stat-label">Out of Warranty Repairs</div>
                            </div>
                        </div>
                        ${buildYearBreakdownHTML('repairRevenue')}
                    `;
                    setPieModalHeaders('Device', 'Revenue', '% of Total');
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td>$${d.repairRevenue.toLocaleString()}</td>
                            <td>${totRepRev > 0 ? ((d.repairRevenue / totRepRev) * 100).toFixed(1) : 0}%</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üîß Top Models by Repair Revenue';
                    break;
                    
                case 'netPL':
                    const totWR = allModelData.reduce((sum, d) => sum + d.warrantyRevenue, 0);
                    const totRR = allModelData.reduce((sum, d) => sum + d.repairRevenue, 0);
                    const totNet = totWR + totRR - totalCost;
                    title = 'üìä Net Warranty P/L Breakdown';
                    subtitle = `${totNet >= 0 ? '+' : '-'}$${Math.abs(totNet).toLocaleString()} net warranty profit/loss`;
                    models = [...allModelData].sort((a, b) => b.netTotal - a.netTotal);
                    const plFmt = (v) => v >= 0 ? '+$' + v.toLocaleString() : '-$' + Math.abs(v).toLocaleString();
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value" style="color: ${totNet >= 0 ? '#81c784' : '#ef5350'};">${plFmt(totNet)}</div>
                                <div class="modal-stat-label">Net P/L</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value" style="color: #4fc3f7;">$${totWR.toLocaleString()}</div>
                                <div class="modal-stat-label">Warranty Rev</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value" style="color: #ffb74d;">$${totRR.toLocaleString()}</div>
                                <div class="modal-stat-label">Repair Rev</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value" style="color: #ef5350;">$${totalCost.toLocaleString()}</div>
                                <div class="modal-stat-label">Total Costs</div>
                            </div>
                        </div>
                        ${buildYearBreakdownHTML('netPL')}
                    `;
                    setPieModalHeaders('Device', 'Net P/L', 'Rev / Cost');
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td style="color: ${d.netTotal >= 0 ? '#81c784' : '#ef5350'};">${plFmt(d.netTotal)}</td>
                            <td>$${d.warrantyRevenue.toLocaleString()} / $${d.totalCost.toLocaleString()}</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üìä Models by Net P/L (Best to Worst)';
                    break;
                    
                default:
                    return;
            }
            
            document.getElementById('pieModalTitle').innerHTML = title + ' ' + sheetsIcon('pieModal', 'KPI_' + kpiType);
            document.getElementById('pieModalSubtitle').textContent = subtitle;
            
            // Hide the model table section for KPI modals
            document.querySelector('#pieModal h4:last-of-type').style.display = 'none';
            document.getElementById('pieModalModelTable').parentElement.style.display = 'none';
            
            document.getElementById('pieModal').classList.add('active');
        }
        
        // Tab switching
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
        
        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        };
        
        function initDashboard() {
            // Destroy existing charts first
            destroyCharts();
            
            // Calculate totals
            const totalSold = allModelData.reduce((sum, d) => sum + d.sold, 0);
            const totalRepairs = allModelData.reduce((sum, d) => sum + d.total, 0);
            const totalMajor = allModelData.reduce((sum, d) => sum + d.major, 0);
            const totalMinor = allModelData.reduce((sum, d) => sum + d.minor, 0);
            const totalNPU = allModelData.reduce((sum, d) => sum + d.npu, 0);
            const totalAccidental = allModelData.reduce((sum, d) => sum + d.accidental, 0);
            const totalInWarranty = allModelData.reduce((sum, d) => sum + d.inWarranty, 0);
            const totalOutWarranty = allModelData.reduce((sum, d) => sum + d.outWarranty, 0);
            const totalCost = allModelData.reduce((sum, d) => sum + d.totalCost, 0);
            const totalEstimatedCost = allModelData.reduce((sum, d) => sum + d.totalEstimatedCost, 0);
            const totalWarrantyRevenue = allModelData.reduce((sum, d) => sum + d.warrantyRevenue, 0);
            const totalRepairRevenue = allModelData.reduce((sum, d) => sum + d.repairRevenue, 0);
            const totalNetPL = totalWarrantyRevenue + totalRepairRevenue - totalCost;
            
            // Update KPIs
            document.getElementById('kpiUnitsSold').textContent = totalSold.toLocaleString();
            document.getElementById('kpiTotalRepairs').textContent = totalRepairs.toLocaleString();
            document.getElementById('kpiRepairRate').textContent = ((totalRepairs / totalSold) * 100).toFixed(2) + '%';
            document.getElementById('kpiTotalCost').textContent = '$' + totalCost.toLocaleString();
            document.getElementById('kpiEstimatedCost').textContent = '$' + totalEstimatedCost.toLocaleString();
            document.getElementById('kpiAccidental').textContent = ((totalAccidental / totalRepairs) * 100).toFixed(1) + '%';
            document.getElementById('kpiInWarranty').textContent = ((totalInWarranty / (totalInWarranty + totalOutWarranty)) * 100).toFixed(1) + '%';
            
            // Financial KPIs
            document.getElementById('kpiWarrantyRevenue').textContent = '$' + totalWarrantyRevenue.toLocaleString();
            document.getElementById('kpiRepairRevenue').textContent = '$' + totalRepairRevenue.toLocaleString();
            const netPLFormatted = totalNetPL >= 0 ? '+$' + totalNetPL.toLocaleString() : '-$' + Math.abs(totalNetPL).toLocaleString();
            document.getElementById('kpiNetPL').textContent = netPLFormatted;
            document.getElementById('kpiNetPL').style.color = totalNetPL >= 0 ? '#81c784' : '#ef5350';
            const netCard = document.getElementById('kpiNetCard');
            netCard.style.borderLeft = '3px solid ' + (totalNetPL >= 0 ? '#81c784' : '#ef5350');
            
            // Sort data for different views ‚Äî use ALL models for repair-focused views
            const byRepairRate = [...allModelData].filter(d => d.sold > 0).sort((a, b) => parseFloat(b.repairRate) - parseFloat(a.repairRate));
            const byReliable = [...allModelData].filter(d => d.sold > 0).sort((a, b) => parseFloat(a.repairRate) - parseFloat(b.repairRate));
            const byCost = [...allModelData].sort((a, b) => b.totalCost - a.totalCost);
            const byAccidental = [...allModelData].filter(d => d.total >= 100).sort((a, b) => parseFloat(b.accidentalPct) - parseFloat(a.accidentalPct));
            
            // Create click handler for charts
            const createClickHandler = (dataArray) => {
                return function(event, elements) {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        openModal(dataArray[index].item);
                    }
                };
            };
            
            // Color gradients
            const redGradient = byRepairRate.slice(0, 15).map((_, i) => {
                const intensity = 1 - (i / 15) * 0.5;
                return `rgba(239, 83, 80, ${intensity})`;
            });
            
            const orangeGradient = byCost.slice(0, 15).map((_, i) => {
                const intensity = 1 - (i / 15) * 0.5;
                return `rgba(255, 183, 77, ${intensity})`;
            });
            
            const purpleGradient = byAccidental.slice(0, 15).map((_, i) => {
                const intensity = 1 - (i / 15) * 0.5;
                return `rgba(186, 104, 200, ${intensity})`;
            });
            
            // Number of Repairs Chart (sorted by total repairs)
            const byTotalRepairs = [...allModelData].sort((a, b) => b.total - a.total);
            charts.repairRate = new Chart(document.getElementById('repairRateChart'), {
                type: 'bar',
                data: {
                    labels: byTotalRepairs.slice(0, 15).map(d => d.shortName),
                    datasets: [{
                        label: 'Number of Repairs',
                        data: byTotalRepairs.slice(0, 15).map(d => d.total),
                        backgroundColor: redGradient,
                        borderColor: redGradient.map(c => c.replace('0.', '1.')),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: createClickHandler(byTotalRepairs.slice(0, 15)),
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const d = byTotalRepairs[context.dataIndex];
                                    return `Repairs: ${d.total.toLocaleString()}`;
                                },
                                afterLabel: function(context) {
                                    const d = byTotalRepairs[context.dataIndex];
                                    const rate = d.repairRate === 'N/A' ? 'N/A' : d.repairRate + '%';
                                    return `${d.sold.toLocaleString()} units sold | Rate: ${rate}\nClick for details`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'logarithmic',
                            ticks: { 
                                color: '#b0b0b0',
                                callback: function(value) {
                                    if ([1, 10, 100, 1000, 10000].includes(value)) return value.toLocaleString();
                                    return '';
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            title: { display: true, text: 'Number of Repairs (log scale)', color: '#90a4ae' }
                        },
                        y: {
                            ticks: { color: '#e4e4e4', font: { size: 10 } },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Cost Chart
            charts.cost = new Chart(document.getElementById('costChart'), {
                type: 'bar',
                data: {
                    labels: byCost.slice(0, 15).map(d => d.shortName),
                    datasets: [{
                        label: 'Repair Cost ($)',
                        data: byCost.slice(0, 15).map(d => d.totalCost),
                        backgroundColor: orangeGradient,
                        borderColor: orangeGradient.map(c => c.replace('0.', '1.')),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: createClickHandler(byCost.slice(0, 15)),
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Cost: $${context.raw.toLocaleString()}`;
                                },
                                afterLabel: function(context) {
                                    const d = byCost[context.dataIndex];
                                    return `Major: ${d.major} | Minor: ${d.minor} | NPU: ${d.npu}\nClick for details`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#b0b0b0',
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { color: '#e4e4e4', font: { size: 10 } },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Repair Type Pie Chart
            charts.repairType = new Chart(document.getElementById('repairTypeChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Major', 'Minor', 'NPU/NPF'],
                    datasets: [{
                        data: [totalMajor, totalMinor, totalNPU],
                        backgroundColor: ['#ef5350', '#ffb74d', '#4fc3f7'],
                        borderColor: '#1a2d47',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            openPieModal('repairType', elements[0].index);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e4e4e4', padding: 15 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = ((value / totalRepairs) * 100).toFixed(1);
                                    return `${context.label}: ${value.toLocaleString()} (${percentage}%)`;
                                },
                                afterLabel: function() {
                                    return 'Click for model breakdown';
                                }
                            }
                        }
                    }
                }
            });
            
            // Accidental Pie Chart
            charts.accidentalPie = new Chart(document.getElementById('accidentalPieChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Accidental', 'Non-Accidental'],
                    datasets: [{
                        data: [totalAccidental, totalRepairs - totalAccidental],
                        backgroundColor: ['#ba68c8', '#64b5f6'],
                        borderColor: '#1a2d47',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            openPieModal('accidental', elements[0].index);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e4e4e4', padding: 15 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = ((value / totalRepairs) * 100).toFixed(1);
                                    return `${context.label}: ${value.toLocaleString()} (${percentage}%)`;
                                },
                                afterLabel: function() {
                                    return 'Click for model breakdown';
                                }
                            }
                        }
                    }
                }
            });
            
            // Cost Breakdown Pie Chart
            const majorCost = allModelData.reduce((sum, d) => sum + d.majorCost, 0);
            const minorCost = allModelData.reduce((sum, d) => sum + d.minorCost, 0);
            const npuCost = allModelData.reduce((sum, d) => sum + d.npuCost, 0);
            
            charts.costPie = new Chart(document.getElementById('costPieChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Major Repairs', 'Minor Repairs', 'NPU/NPF'],
                    datasets: [{
                        data: [majorCost, minorCost, npuCost],
                        backgroundColor: ['#ef5350', '#ffb74d', '#4fc3f7'],
                        borderColor: '#1a2d47',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            openPieModal('repairType', elements[0].index);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e4e4e4', padding: 15 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = ((value / totalCost) * 100).toFixed(1);
                                    return `${context.label}: $${value.toLocaleString()} (${percentage}%)`;
                                },
                                afterLabel: function() {
                                    return 'Click for model breakdown';
                                }
                            }
                        }
                    }
                }
            });
            
            // Accidental Damage Rate Chart
            charts.accidental = new Chart(document.getElementById('accidentalChart'), {
                type: 'bar',
                data: {
                    labels: byAccidental.slice(0, 15).map(d => d.shortName),
                    datasets: [{
                        label: 'Accidental Damage Rate (%)',
                        data: byAccidental.slice(0, 15).map(d => parseFloat(d.accidentalPct)),
                        backgroundColor: purpleGradient,
                        borderColor: purpleGradient.map(c => c.replace('0.', '1.')),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: createClickHandler(byAccidental.slice(0, 15)),
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Accidental: ${context.raw}%`;
                                },
                                afterLabel: function(context) {
                                    const d = byAccidental[context.dataIndex];
                                    return `${d.accidental.toLocaleString()} of ${d.total.toLocaleString()} repairs\nClick for details`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#b0b0b0' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            title: { display: true, text: 'Accidental %', color: '#90a4ae' }
                        },
                        y: {
                            ticks: { color: '#e4e4e4', font: { size: 10 } },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Warranty Status Chart
            charts.warranty = new Chart(document.getElementById('warrantyChart'), {
                type: 'doughnut',
                data: {
                    labels: ['In Warranty', 'Out of Warranty'],
                    datasets: [{
                        data: [totalInWarranty, totalOutWarranty],
                        backgroundColor: ['#81c784', '#e57373'],
                        borderColor: '#1a2d47',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            openPieModal('warrantyStatus', elements[0].index);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e4e4e4', padding: 15 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = totalInWarranty + totalOutWarranty;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toLocaleString()} (${percentage}%)`;
                                },
                                afterLabel: function() {
                                    return 'Click for model breakdown';
                                }
                            }
                        }
                    }
                }
            });
            
            // Accidental Damage Cost by Model Chart (100+ repairs only)
            const byAccidentalCost = [...allModelData]
                .filter(d => d.total >= 100)
                .map(d => {
                    const avgCostPerRepair = d.totalCost / d.total;
                    const accidentalCost = Math.round(d.accidental * avgCostPerRepair);
                    return { ...d, accidentalCost };
                })
                .sort((a, b) => b.accidentalCost - a.accidentalCost);
            
            const accidentalCostGradient = byAccidentalCost.slice(0, 15).map((_, i) => {
                const intensity = 1 - (i / 15) * 0.5;
                return `rgba(186, 104, 200, ${intensity})`;
            });
            
            charts.accidentalCost = new Chart(document.getElementById('accidentalCostChart'), {
                type: 'bar',
                data: {
                    labels: byAccidentalCost.slice(0, 15).map(d => d.shortName),
                    datasets: [{
                        label: 'Accidental Damage Cost ($)',
                        data: byAccidentalCost.slice(0, 15).map(d => d.accidentalCost),
                        backgroundColor: accidentalCostGradient,
                        borderColor: accidentalCostGradient.map(c => c.replace('0.', '1.')),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: createClickHandler(byAccidentalCost.slice(0, 15)),
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Cost: $${context.raw.toLocaleString()}`;
                                },
                                afterLabel: function(context) {
                                    const d = byAccidentalCost[context.dataIndex];
                                    return `Accidental Repairs: ${d.accidental.toLocaleString()}\nClick for model details`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#b0b0b0',
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { color: '#e4e4e4', font: { size: 10 } },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Warranty Cost Breakdown Chart
            const totalInWarrantyCost = allModelData.reduce((sum, d) => {
                const avgCostPerRepair = d.total > 0 ? d.totalCost / d.total : 0;
                return sum + Math.round(d.inWarranty * avgCostPerRepair);
            }, 0);
            const totalOutWarrantyCost = allModelData.reduce((sum, d) => {
                const avgCostPerRepair = d.total > 0 ? d.totalCost / d.total : 0;
                return sum + Math.round(d.outWarranty * avgCostPerRepair);
            }, 0);
            
            charts.warrantyCost = new Chart(document.getElementById('warrantyCostChart'), {
                type: 'doughnut',
                data: {
                    labels: ['In Warranty', 'Out of Warranty'],
                    datasets: [{
                        data: [totalInWarrantyCost, totalOutWarrantyCost],
                        backgroundColor: ['#81c784', '#e57373'],
                        borderColor: '#1a2d47',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            openPieModal('warrantyCost', elements[0].index);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e4e4e4', padding: 15 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = totalInWarrantyCost + totalOutWarrantyCost;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: $${value.toLocaleString()} (${percentage}%)`;
                                },
                                afterLabel: function() {
                                    return 'Click for model breakdown';
                                }
                            }
                        }
                    }
                }
            });
            
            // Warranty Repair Cost Distribution Chart - aggregate from ALL models
            const allWarrantyCodes = {};
            allModelData.forEach(d => {
                Object.entries(d.warrantyCodes).forEach(([code, data]) => {
                    if (!allWarrantyCodes[code]) {
                        allWarrantyCodes[code] = { count: 0, cost: 0, warrantyRev: 0, repairRev: 0, qtySold: 0, unitPrice: 0 };
                    }
                    allWarrantyCodes[code].count += data.count;
                    allWarrantyCodes[code].cost += data.cost;
                    allWarrantyCodes[code].warrantyRev += data.warrantyRev;
                    allWarrantyCodes[code].repairRev += data.repairRev;
                    allWarrantyCodes[code].qtySold += data.qtySold;
                    if (data.unitPrice > 0 && allWarrantyCodes[code].unitPrice === 0) {
                        allWarrantyCodes[code].unitPrice = data.unitPrice;
                    }
                });
            });
            
            const sortedCodes = Object.entries(allWarrantyCodes)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);
            
            const codeColors = ['#4fc3f7', '#81c784', '#ffb74d', '#ba68c8', '#ef5350', '#90caf9', '#a5d6a7', '#ffe082', '#ce93d8', '#ef9a9a'];
            
            charts.warrantyCode = new Chart(document.getElementById('warrantyCodeChart'), {
                type: 'doughnut',
                data: {
                    labels: sortedCodes.map(([code]) => code),
                    datasets: [{
                        data: sortedCodes.map(([, data]) => data.count),
                        backgroundColor: codeColors.slice(0, sortedCodes.length),
                        borderColor: '#1a2d47',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            const code = sortedCodes[idx][0];
                            openWarrantyCodeModal(code);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e4e4e4', padding: 10, font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const codeData = sortedCodes[context.dataIndex][1];
                                    const total = sortedCodes.reduce((s, [,d]) => s + d.count, 0);
                                    const pct = ((codeData.count / total) * 100).toFixed(1);
                                    return `${context.label}: ${codeData.count.toLocaleString()} repairs (${pct}%)`;
                                },
                                afterLabel: function(context) {
                                    const codeData = sortedCodes[context.dataIndex][1];
                                    return `Sold: ${codeData.qtySold.toLocaleString()} @ $${codeData.unitPrice.toFixed(2)}\nCost: $${codeData.cost.toLocaleString()}\nWarranty Rev: $${codeData.warrantyRev.toLocaleString()}\nClick for device breakdown`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Repair Cost by Customer Chart
            const topCustomers = customerData.slice(0, 10);
            const otherCustomerCost = customerData.slice(10).reduce((sum, c) => sum + c.cost, 0);
            const custLabels = topCustomers.map(c => c.name.length > 30 ? c.name.substring(0, 28) + '‚Ä¶' : c.name);
            const custData = topCustomers.map(c => c.cost);
            if (otherCustomerCost > 0) {
                custLabels.push('Other');
                custData.push(otherCustomerCost);
            }
            const custColors = ['#4fc3f7', '#ef5350', '#ffb74d', '#81c784', '#ce93d8', '#ff8a65', '#a5d6a7', '#90caf9', '#f48fb1', '#fff176', '#b0bec5'];
            charts.revenueBreakdown = new Chart(document.getElementById('revenueBreakdownChart'), {
                type: 'doughnut',
                data: {
                    labels: custLabels,
                    datasets: [{
                        data: custData,
                        backgroundColor: custColors.slice(0, custData.length),
                        borderColor: '#1a2d47',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            openPieModal('customerCost', elements[0].index);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e4e4e4', padding: 10, font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = custData.reduce((a, b) => a + b, 0);
                                    const pct = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: $${value.toLocaleString()} (${pct}%)`;
                                },
                                afterLabel: function(context) {
                                    if (context.dataIndex < topCustomers.length) {
                                        return `${topCustomers[context.dataIndex].repairs} repairs | Click for details`;
                                    }
                                    return 'Click for details';
                                }
                            }
                        }
                    }
                }
            });
            
            // Warranty Code Summary Chart (in tables section)
            const allCodesSorted = Object.entries(allWarrantyCodes)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 15);
            
            charts.warrantyCodeSummary = new Chart(document.getElementById('warrantyCodeSummaryChart'), {
                type: 'bar',
                data: {
                    labels: allCodesSorted.map(([code]) => code),
                    datasets: [
                        {
                            label: 'Warranty Revenue',
                            data: allCodesSorted.map(([, d]) => d.warrantyRev),
                            backgroundColor: 'rgba(79, 195, 247, 0.7)',
                            borderColor: '#4fc3f7',
                            borderWidth: 1
                        },
                        {
                            label: 'Repair Cost',
                            data: allCodesSorted.map(([, d]) => d.cost),
                            backgroundColor: 'rgba(239, 83, 80, 0.7)',
                            borderColor: '#ef5350',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            const code = allCodesSorted[idx][0];
                            openWarrantyCodeModal(code);
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#e4e4e4', padding: 15 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.raw.toLocaleString()}`;
                                },
                                afterBody: function(context) {
                                    const cData = allCodesSorted[context[0].dataIndex][1];
                                    const net = cData.warrantyRev + cData.repairRev - cData.cost;
                                    return `Sold: ${cData.qtySold.toLocaleString()} @ $${cData.unitPrice.toFixed(2)}\nRepairs: ${cData.count.toLocaleString()}\nNet P/L: ${net >= 0 ? '+' : '-'}$${Math.abs(net).toLocaleString()}\nClick for device breakdown`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#e4e4e4', font: { size: 10 } },
                            grid: { display: false }
                        },
                        y: {
                            ticks: { 
                                color: '#b0b0b0',
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
            
            // Generate Insights
            const insights = [
                {
                    icon: '‚ö†Ô∏è',
                    title: `Highest Repair Rate: ${byRepairRate[0]?.model || 'N/A'}`,
                    text: byRepairRate[0] ? `At ${byRepairRate[0].repairRate}% repair rate with ${byRepairRate[0].total.toLocaleString()} repairs from ${byRepairRate[0].sold.toLocaleString()} units sold. This model requires attention for quality improvement.` : 'No data available'
                },
                {
                    icon: '‚úÖ',
                    title: `Most Reliable: ${byReliable[0]?.model || 'N/A'}`,
                    text: byReliable[0] ? `Only ${byReliable[0].repairRate}% repair rate with just ${byReliable[0].total.toLocaleString()} repairs from ${byReliable[0].sold.toLocaleString()} units sold. Excellent reliability performance.` : 'No data available'
                },
                {
                    icon: 'üí∞',
                    title: `Highest Repair Cost: ${byCost[0]?.model || 'N/A'}`,
                    text: byCost[0] ? `Total repair cost of $${byCost[0].totalCost.toLocaleString()} with ${byCost[0].major.toLocaleString()} major, ${byCost[0].minor.toLocaleString()} minor, and ${byCost[0].npu.toLocaleString()} NPU/NPF repairs.` : 'No data available'
                },
                {
                    icon: 'üíµ',
                    title: `Net Warranty P/L: ${totalNetPL >= 0 ? '+' : '-'}$${Math.abs(totalNetPL).toLocaleString()}`,
                    text: `Warranty revenue of $${totalWarrantyRevenue.toLocaleString()} plus OOW repair revenue of $${totalRepairRevenue.toLocaleString()} against total repair costs of $${totalCost.toLocaleString()}.`
                },
                {
                    icon: 'üí•',
                    title: `${((totalAccidental / totalRepairs) * 100).toFixed(1)}% Accidental Damage`,
                    text: byAccidental[0] ? `${((totalAccidental / totalRepairs) * 100).toFixed(1)}% of all repairs are classified as accidental damage (${totalAccidental.toLocaleString()} of ${totalRepairs.toLocaleString()} total repairs). ${byAccidental[0]?.shortName || 'N/A'} has highest at ${byAccidental[0]?.accidentalPct || 0}%.` : 'No data available'
                },
                {
                    icon: 'üìã',
                    title: `${((totalInWarranty / (totalInWarranty + totalOutWarranty)) * 100).toFixed(1)}% In Warranty`,
                    text: `${totalInWarranty.toLocaleString()} repairs performed in warranty vs ${totalOutWarranty.toLocaleString()} out of warranty. This represents significant warranty cost exposure.`
                }
            ];
            
            document.getElementById('insightsList').innerHTML = insights.map(i => `
                <div class="insight-item">
                    <span class="insight-icon">${i.icon}</span>
                    <div class="insight-content">
                        <h4>${i.title}</h4>
                        <p>${i.text}</p>
                    </div>
                </div>
            `).join('');
            
            // Populate tables
            const getRateClass = (rate) => { if (rate === 'N/A') return '';
                const r = parseFloat(rate);
                return r > 10 ? 'rate-high' : r > 5 ? 'rate-medium' : 'rate-low';
            };
            
            // Worst table - 30 rows
            document.getElementById('worstTable').innerHTML = byRepairRate.slice(0, 30).map(d => `
                <tr onclick="openModal('${d.item}')">
                    <td>${d.model}</td>
                    <td>${d.item}</td>
                    <td>${d.sold.toLocaleString()}</td>
                    <td>${d.total.toLocaleString()}</td>
                    <td class="${getRateClass(d.repairRate)}">${d.repairRate === 'N/A' ? 'N/A' : d.repairRate + '%'}</td>
                    <td>$${d.totalCost.toLocaleString()}</td>
                </tr>
            `).join('');
            
            // Best table - 30 rows
            document.getElementById('bestTable').innerHTML = byReliable.slice(0, 30).map(d => `
                <tr onclick="openModal('${d.item}')">
                    <td>${d.model}</td>
                    <td>${d.item}</td>
                    <td>${d.sold.toLocaleString()}</td>
                    <td>${d.total.toLocaleString()}</td>
                    <td class="${getRateClass(d.repairRate)}">${d.repairRate === 'N/A' ? 'N/A' : d.repairRate + '%'}</td>
                    <td>$${d.totalCost.toLocaleString()}</td>
                </tr>
            `).join('');
            
            // Cost table - 30 rows
            document.getElementById('costTable').innerHTML = byCost.slice(0, 30).map(d => `
                <tr onclick="openModal('${d.item}')">
                    <td>${d.model}</td>
                    <td>${d.item}</td>
                    <td>${d.total.toLocaleString()}</td>
                    <td>${d.major.toLocaleString()}</td>
                    <td>${d.minor.toLocaleString()}</td>
                    <td>${d.npu.toLocaleString()}</td>
                    <td>$${d.totalCost.toLocaleString()}</td>
                    <td>$${d.avgCostPerRepair.toLocaleString()}</td>
                </tr>
            `).join('');
            
            // Accidental table - sorted by accidental count descending, 30 rows
            const byAccidentalCount = [...allModelData].sort((a, b) => b.accidental - a.accidental);
            document.getElementById('accidentalTable').innerHTML = byAccidentalCount.slice(0, 30).map(d => `
                <tr onclick="openModal('${d.item}')">
                    <td>${d.model}</td>
                    <td>${d.item}</td>
                    <td>${d.total.toLocaleString()}</td>
                    <td>${d.accidental.toLocaleString()}</td>
                    <td>${(d.total - d.accidental).toLocaleString()}</td>
                    <td class="rate-high">${d.accidentalPct}%</td>
                </tr>
            `).join('');
            
            // Warranty table - sorted by inWarranty count descending, 30 rows
            const byInWarrantyCount = [...allModelData].sort((a, b) => b.inWarranty - a.inWarranty);
            document.getElementById('warrantyTable').innerHTML = byInWarrantyCount.slice(0, 30).map(d => `
                <tr onclick="openModal('${d.item}')">
                    <td>${d.model}</td>
                    <td>${d.item}</td>
                    <td>${d.total.toLocaleString()}</td>
                    <td>${d.inWarranty.toLocaleString()}</td>
                    <td>${d.outWarranty.toLocaleString()}</td>
                    <td>${d.inWarrantyPct}%</td>
                </tr>
            `).join('');
            
            // Revenue table - sorted by net P/L descending
            const byNetPL = [...allModelData].sort((a, b) => b.netTotal - a.netTotal);
            const plClass = (val) => val >= 0 ? 'rate-low' : 'rate-high';
            const plFormat = (val) => val >= 0 ? '+$' + val.toLocaleString() : '-$' + Math.abs(val).toLocaleString();
            document.getElementById('revenueTable').innerHTML = byNetPL.slice(0, 30).map(d => `
                <tr onclick="openModal('${d.item}')">
                    <td>${d.model}</td>
                    <td>${d.total.toLocaleString()}</td>
                    <td>$${d.totalCost.toLocaleString()}</td>
                    <td>$${d.warrantyRevenue.toLocaleString()}</td>
                    <td>$${d.repairRevenue.toLocaleString()}</td>
                    <td class="${plClass(d.netTotal)}">${plFormat(d.netTotal)}</td>
                </tr>
            `).join('');
            
            // Warranty Code table - expanded per model per code
            const codeRows = [];
            allModelData.forEach(d => {
                Object.entries(d.warrantyCodes).forEach(([code, data]) => {
                    const net = data.warrantyRev + data.repairRev - data.cost;
                    codeRows.push({
                        model: d.model,
                        item: d.item,
                        code: code,
                        qtySold: data.qtySold,
                        unitPrice: data.unitPrice,
                        count: data.count,
                        cost: data.cost,
                        warrantyRev: data.warrantyRev,
                        repairRev: data.repairRev,
                        net: Math.round(net)
                    });
                });
            });
            codeRows.sort((a, b) => b.count - a.count);
            document.getElementById('warrantyCodeTable').innerHTML = codeRows.slice(0, 50).map(r => `
                <tr onclick="openModal('${r.item}')">
                    <td>${r.model}</td>
                    <td>${r.code}</td>
                    <td>${r.qtySold.toLocaleString()}</td>
                    <td>$${r.unitPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${r.count.toLocaleString()}</td>
                    <td>$${r.cost.toLocaleString()}</td>
                    <td>$${r.warrantyRev.toLocaleString()}</td>
                    <td>$${r.repairRev.toLocaleString()}</td>
                    <td class="${plClass(r.net)}">${plFormat(r.net)}</td>
                </tr>
            `).join('');
            
            // All models table - initial render
            renderAllModelsTable('total', 'desc');
            
            // Update tab buttons with stats
            updateTabButtons();
        }
        
        function updateTabButtons() {
            const totalSold = allModelData.reduce((sum, d) => sum + d.sold, 0);
            const totalRepairs = allModelData.reduce((sum, d) => sum + d.total, 0);
            const totalCost = allModelData.reduce((sum, d) => sum + d.totalCost, 0);
            const totalAccidental = allModelData.reduce((sum, d) => sum + d.accidental, 0);
            const totalInWarranty = allModelData.reduce((sum, d) => sum + d.inWarranty, 0);
            
            const byRepairRate = [...allModelData].filter(d => d.sold > 0).sort((a, b) => parseFloat(b.repairRate) - parseFloat(a.repairRate));
            const byReliable = [...allModelData].filter(d => d.sold > 0).sort((a, b) => parseFloat(a.repairRate) - parseFloat(b.repairRate));
            const byCost = [...allModelData].sort((a, b) => b.totalCost - a.totalCost);
            
            document.getElementById('tabBtnWorst').innerHTML = `
                <span class="tab-title">‚ö†Ô∏è Highest Repair Rate</span>
                <span class="tab-stats">${byRepairRate[0]?.shortName || 'N/A'}: ${byRepairRate[0]?.repairRate || 0}%</span>
            `;
            
            document.getElementById('tabBtnBest').innerHTML = `
                <span class="tab-title">‚úÖ Most Reliable</span>
                <span class="tab-stats">${byReliable[0]?.shortName || 'N/A'}: ${byReliable[0]?.repairRate || 0}%</span>
            `;
            
            document.getElementById('tabBtnCost').innerHTML = `
                <span class="tab-title">üí∞ Highest Cost</span>
                <span class="tab-stats">$${totalCost.toLocaleString()} total</span>
            `;
            
            document.getElementById('tabBtnAccidental').innerHTML = `
                <span class="tab-title">üí• Accidental Damage</span>
                <span class="tab-stats">${totalAccidental.toLocaleString()} repairs</span>
            `;
            
            document.getElementById('tabBtnWarranty').innerHTML = `
                <span class="tab-title">üìã Warranty Status</span>
                <span class="tab-stats">${totalInWarranty.toLocaleString()} in warranty</span>
            `;
            
            const totalWarRev = allModelData.reduce((sum, d) => sum + d.warrantyRevenue, 0);
            const totalNetPL = totalWarRev + allModelData.reduce((sum, d) => sum + d.repairRevenue, 0) - totalCost;
            document.getElementById('tabBtnRevenue').innerHTML = `
                <span class="tab-title">üíµ Warranty & Revenue</span>
                <span class="tab-stats">Net: ${totalNetPL >= 0 ? '+' : '-'}$${Math.abs(totalNetPL).toLocaleString()}</span>
            `;
            
            const codeCount = new Set();
            allModelData.forEach(d => Object.keys(d.warrantyCodes).forEach(c => codeCount.add(c)));
            document.getElementById('tabBtnWarrantyCode').innerHTML = `
                <span class="tab-title">üè∑Ô∏è Warranty Codes</span>
                <span class="tab-stats">${codeCount.size} codes</span>
            `;
            
            document.getElementById('tabBtnAll').innerHTML = `
                <span class="tab-title">üìÑ All Models</span>
                <span class="tab-stats">${allModelData.length} models | ${totalRepairs.toLocaleString()} repairs</span>
            `;
        }
        
        // All Models table sorting
        let currentSort = { column: 'total', direction: 'desc' };
        
        function renderAllModelsTable(column, direction) {
            currentSort = { column, direction };
            
            const getRateClass = (rate) => { if (rate === 'N/A') return '';
                const r = parseFloat(rate);
                return r > 10 ? 'rate-high' : r > 5 ? 'rate-medium' : 'rate-low';
            };
            
            const plClass = (val) => val >= 0 ? 'rate-low' : 'rate-high';
            const plFormat = (val) => val >= 0 ? '+$' + val.toLocaleString() : '-$' + Math.abs(val).toLocaleString();
            
            const sorted = [...allModelData].sort((a, b) => {
                let aVal, bVal;
                switch(column) {
                    case 'model': aVal = a.model; bVal = b.model; break;
                    case 'item': aVal = a.item; bVal = b.item; break;
                    case 'sold': aVal = a.sold; bVal = b.sold; break;
                    case 'total': aVal = a.total; bVal = b.total; break;
                    case 'rate': aVal = parseFloat(a.repairRate) || 0; bVal = parseFloat(b.repairRate) || 0; break;
                    case 'major': aVal = a.major; bVal = b.major; break;
                    case 'minor': aVal = a.minor; bVal = b.minor; break;
                    case 'npu': aVal = a.npu; bVal = b.npu; break;
                    case 'accidental': aVal = a.accidental; bVal = b.accidental; break;
                    case 'inWarranty': aVal = a.inWarranty; bVal = b.inWarranty; break;
                    case 'totalCost': aVal = a.totalCost; bVal = b.totalCost; break;
                    case 'warrantyRevenue': aVal = a.warrantyRevenue; bVal = b.warrantyRevenue; break;
                    case 'netTotal': aVal = a.netTotal; bVal = b.netTotal; break;
                    default: aVal = a.total; bVal = b.total;
                }
                
                if (typeof aVal === 'string') {
                    return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            document.getElementById('allTable').innerHTML = sorted.map(d => `
                <tr onclick="openModal('${d.item}')">
                    <td>${d.model}</td>
                    <td>${d.item}</td>
                    <td>${d.sold.toLocaleString()}</td>
                    <td>${d.total.toLocaleString()}</td>
                    <td class="${getRateClass(d.repairRate)}">${d.repairRate === 'N/A' ? 'N/A' : d.repairRate + '%'}</td>
                    <td>${d.major.toLocaleString()}</td>
                    <td>${d.minor.toLocaleString()}</td>
                    <td>${d.npu.toLocaleString()}</td>
                    <td>${d.accidental.toLocaleString()}</td>
                    <td>${d.inWarranty.toLocaleString()}</td>
                    <td>$${d.totalCost.toLocaleString()}</td>
                    <td>$${d.warrantyRevenue.toLocaleString()}</td>
                    <td class="${plClass(d.netTotal)}">${plFormat(d.netTotal)}</td>
                </tr>
            `).join('');
            
            // Update header arrows
            document.querySelectorAll('#allTab th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.column === column) {
                    th.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }
        
        function sortAllModels(column) {
            const newDirection = (currentSort.column === column && currentSort.direction === 'desc') ? 'asc' : 'desc';
            renderAllModelsTable(column, newDirection);
        }
        
        // Populate estimated costs grid in assumptions panel
        document.addEventListener('DOMContentLoaded', function() {
            const grid = document.getElementById('estimatedCostsGrid');
            if (grid) {
                grid.innerHTML = Object.entries(ESTIMATED_REPAIR_COSTS)
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([k, v]) => '<span style="color: #b0bec5;"><strong>' + k + ':</strong> $' + v + '</span>')
                    .join('');
            }
        });
    </script>
</body>
</html>
