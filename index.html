<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTL Warranty Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e4e4e4;
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Password Overlay */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .password-box {
            background: linear-gradient(145deg, #1e3a5f, #1a2d47);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            border: 1px solid rgba(79, 195, 247, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .password-box h2 {
            color: #4fc3f7;
            margin-bottom: 10px;
        }
        
        .password-box p {
            color: #90a4ae;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .password-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #2c5282;
            border-radius: 8px;
            background: #1a2d47;
            color: #e4e4e4;
            font-size: 1rem;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }
        
        .password-box input:focus {
            outline: none;
            border-color: #4fc3f7;
        }
        
        .password-box button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #4fc3f7 0%, #2196f3 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .password-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 195, 247, 0.4);
        }
        
        .password-error {
            color: #ef5350;
            margin-top: 10px;
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 46, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9998;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #2c5282;
            border-top-color: #4fc3f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            color: #4fc3f7;
            font-size: 1.1rem;
        }
        
        /* Header Controls */
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .nav-button {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        }
        
        .nav-button.all-models {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        
        .refresh-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .refresh-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }
        
        .last-updated {
            color: #90a4ae;
            font-size: 0.85rem;
        }
        
        .last-updated strong {
            color: #81c784;
        }
        
        /* Dashboard Styles */
        .dashboard {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4fc3f7;
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #90a4ae;
            margin-bottom: 20px;
        }
        
        .header-actions {
            margin-bottom: 20px;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: linear-gradient(145deg, #1e3a5f, #1a2d47);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(79, 195, 247, 0.1);
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4fc3f7;
        }
        
        .kpi-card.warning .kpi-value {
            color: #ffb74d;
        }
        
        .kpi-card.danger .kpi-value {
            color: #ef5350;
        }
        
        .kpi-card.success .kpi-value {
            color: #81c784;
        }
        
        .kpi-card.purple .kpi-value {
            color: #ba68c8;
        }
        
        .kpi-card.clickable {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .kpi-card.clickable:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(79, 195, 247, 0.3);
        }
        
        .kpi-label {
            color: #90a4ae;
            font-size: 0.85rem;
            margin-top: 5px;
        }
        
        /* Charts */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: linear-gradient(145deg, #1e3a5f, #1a2d47);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(79, 195, 247, 0.1);
        }
        
        .chart-container h3 {
            color: #4fc3f7;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .chart-wrapper {
            height: 350px;
            position: relative;
        }
        
        .chart-container.full-width {
            grid-column: 1 / -1;
        }
        
        .click-hint {
            text-align: center;
            color: #90a4ae;
            font-size: 0.8rem;
            margin-top: 10px;
            font-style: italic;
        }
        
        /* Insights */
        .insights {
            background: linear-gradient(145deg, #1e3a5f, #1a2d47);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(79, 195, 247, 0.1);
        }
        
        .insights h3 {
            color: #4fc3f7;
            margin-bottom: 20px;
        }
        
        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .insight-icon {
            font-size: 1.5rem;
        }
        
        .insight-content h4 {
            color: #e4e4e4;
            margin-bottom: 5px;
        }
        
        .insight-content p {
            color: #90a4ae;
            font-size: 0.9rem;
        }
        
        /* Tables */
        .table-container {
            background: linear-gradient(145deg, #1e3a5f, #1a2d47);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(79, 195, 247, 0.1);
            overflow-x: auto;
        }
        
        .table-container h3 {
            color: #4fc3f7;
            margin-bottom: 15px;
        }
        
        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 12px 16px;
            background: rgba(79, 195, 247, 0.1);
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 8px;
            color: #90a4ae;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-width: 140px;
        }
        
        .tab-btn .tab-title {
            display: block;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .tab-btn .tab-stats {
            display: block;
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        .tab-btn:hover, .tab-btn.active {
            background: rgba(79, 195, 247, 0.2);
            color: #4fc3f7;
            border-color: #4fc3f7;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(79, 195, 247, 0.1);
        }
        
        th {
            background: rgba(0,0,0,0.3);
            color: #4fc3f7;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: rgba(79, 195, 247, 0.05);
        }
        
        tr {
            cursor: pointer;
        }
        
        .rate-high { color: #ef5350; }
        .rate-medium { color: #ffb74d; }
        .rate-low { color: #81c784; }
        
        /* Sortable columns */
        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        th.sortable:hover {
            background: rgba(79, 195, 247, 0.2);
        }
        
        th.sort-asc::after {
            content: ' ‚ñ≤';
            color: #4fc3f7;
        }
        
        th.sort-desc::after {
            content: ' ‚ñº';
            color: #4fc3f7;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(145deg, #1e3a5f, #1a2d47);
            padding: 30px;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(79, 195, 247, 0.2);
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #90a4ae;
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: #ef5350;
        }
        
        .modal-title {
            color: #4fc3f7;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .modal-subtitle {
            color: #90a4ae;
            margin-bottom: 20px;
        }
        
        .modal-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .modal-stat {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .modal-stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #4fc3f7;
        }
        
        .modal-stat-value.warning { color: #ffb74d; }
        .modal-stat-value.danger { color: #ef5350; }
        .modal-stat-value.success { color: #81c784; }
        .modal-stat-value.purple { color: #ba68c8; }
        
        .modal-stat-label {
            color: #90a4ae;
            font-size: 0.75rem;
            margin-top: 5px;
        }
        
        .comparison {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .comparison h4 {
            color: #4fc3f7;
            margin-bottom: 10px;
        }
        
        .comparison-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(79, 195, 247, 0.1);
        }
        
        .comparison-item:last-child {
            border-bottom: none;
        }
        
        .top-repairs {
            margin-top: 20px;
        }
        
        .top-repairs h4 {
            color: #4fc3f7;
            margin-bottom: 15px;
        }
        
        .repair-table {
            width: 100%;
        }
        
        .repair-table th, .repair-table td {
            padding: 10px;
            font-size: 0.9rem;
        }
        
        .footer {
            text-align: center;
            color: #607d8b;
            margin-top: 30px;
            padding: 20px;
            border-top: 1px solid rgba(79, 195, 247, 0.1);
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 1.5rem; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .header-controls { flex-direction: column; gap: 15px; align-items: flex-start; }
            .refresh-section { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <!-- Password Overlay -->
    <div class="password-overlay" id="passwordOverlay">
        <div class="password-box">
            <h2>üîê CTL Warranty Dashboard</h2>
            <p>Enter password to access the dashboard</p>
            <input type="password" id="passwordInput" placeholder="Enter password" onkeypress="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()">Access Dashboard</button>
            <p class="password-error" id="passwordError">Incorrect password. Please try again.</p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
        <p class="loading-text" id="loadingText">Loading data from Google Sheets...</p>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard hidden" id="dashboard">
        <div class="header-controls">
            <a href="all-models.html" class="nav-button all-models">
                üìã View All Models (incl. NL71/NL81)
            </a>
            <div class="refresh-section">
                <div class="last-updated">
                    Last updated: <strong id="lastUpdated">Never</strong>
                    <span id="autoRefreshNote" style="color: #90a4ae;"> ‚Ä¢ Auto-refresh every 6 hours</span>
                </div>
                <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">
                    <span class="refresh-icon">üîÑ</span> Refresh Data
                </button>
            </div>
        </div>
        <h1>üìä CTL Warranty Analysis Dashboard</h1>
        <p class="subtitle">Repair Data 2023-2025 | Models with >1,000 units sold | NL72 / PX11E Devices and Newer</p>
        <div class="header-actions">
            <span style="color: #81c784; font-size: 0.9rem;">‚úì Excludes NL71/NL81 legacy models ‚Ä¢ Only completed repairs (Order Received Date required)</span>
        </div>
        
        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card clickable" onclick="openKpiModal('unitsSold')">
                <div class="kpi-value" id="kpiUnitsSold">-</div>
                <div class="kpi-label">Total Units Sold</div>
            </div>
            <div class="kpi-card warning clickable" onclick="openKpiModal('totalRepairs')">
                <div class="kpi-value" id="kpiTotalRepairs">-</div>
                <div class="kpi-label">Total Repairs</div>
            </div>
            <div class="kpi-card danger clickable" onclick="openKpiModal('repairRate')">
                <div class="kpi-value" id="kpiRepairRate">-</div>
                <div class="kpi-label">Overall Repair Rate</div>
            </div>
            <div class="kpi-card warning clickable" onclick="openKpiModal('totalCost')">
                <div class="kpi-value" id="kpiTotalCost">-</div>
                <div class="kpi-label">Est. Total Repair Cost</div>
            </div>
            <div class="kpi-card purple clickable" onclick="openKpiModal('accidental')">
                <div class="kpi-value" id="kpiAccidental">-</div>
                <div class="kpi-label">Accidental Damage %</div>
            </div>
            <div class="kpi-card success clickable" onclick="openKpiModal('inWarranty')">
                <div class="kpi-value" id="kpiInWarranty">-</div>
                <div class="kpi-label">In Warranty %</div>
            </div>
        </div>
        
        <!-- Charts Row 1 -->
        <div class="chart-grid">
            <div class="chart-container full-width">
                <h3>‚ö†Ô∏è Repair Rate by Model (Highest to Lowest)</h3>
                <div class="chart-wrapper" style="height: 400px;">
                    <canvas id="repairRateChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any bar to view detailed model information</p>
            </div>
        </div>
        
        <!-- Charts Row 2 -->
        <div class="chart-grid">
            <div class="chart-container">
                <h3>üí∞ Estimated Repair Cost by Model</h3>
                <div class="chart-wrapper">
                    <canvas id="costChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any bar to view detailed model information</p>
            </div>
            <div class="chart-container">
                <h3>üîß Repair Type Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="repairTypeChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any segment to view model breakdown</p>
            </div>
        </div>
        
        <!-- Charts Row 3 -->
        <div class="chart-grid">
            <div class="chart-container">
                <h3>üí• Accidental vs Non-Accidental</h3>
                <div class="chart-wrapper">
                    <canvas id="accidentalPieChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any segment to view model breakdown</p>
            </div>
            <div class="chart-container">
                <h3>üíµ Cost Breakdown by Repair Type</h3>
                <div class="chart-wrapper">
                    <canvas id="costPieChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any segment to view model breakdown</p>
            </div>
        </div>
        
        <!-- Charts Row 4 -->
        <div class="chart-grid">
            <div class="chart-container">
                <h3>‚ö†Ô∏è Accidental Damage Rate by Model <span style="font-size: 0.7rem; color: #90a4ae; font-weight: normal;">(100+ repairs only)</span></h3>
                <div class="chart-wrapper">
                    <canvas id="accidentalChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any bar to view detailed model information</p>
            </div>
            <div class="chart-container">
                <h3>üìã Warranty Status Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="warrantyChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any segment to view model breakdown</p>
            </div>
        </div>
        
        <!-- Cost Analysis Charts -->
        <div class="chart-grid">
            <div class="chart-container">
                <h3>üí• Accidental Damage Cost by Model <span style="font-size: 0.7rem; color: #90a4ae; font-weight: normal;">(100+ repairs only)</span></h3>
                <div class="chart-wrapper">
                    <canvas id="accidentalCostChart"></canvas>
                </div>
                <p class="click-hint">üí° Click on any bar to view detailed model information</p>
            </div>
            <div class="chart-container">
                <h3>üìã Total Cost: In Warranty vs Out of Warranty</h3>
                <div class="chart-wrapper">
                    <canvas id="warrantyCostChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Insights Section -->
        <div class="insights">
            <h3>üîç Key Insights & Analysis</h3>
            <div id="insightsList"></div>
        </div>
        
        <!-- Data Tables -->
        <div class="table-container">
            <h3>üìä Model Analysis Tables <span style="font-size: 0.8rem; color: #90a4ae; font-weight: normal;">(click any box for details)</span></h3>
            <div class="tab-buttons">
                <button class="tab-btn active" id="tabBtnWorst" onclick="showTab('worstTab')">‚ö†Ô∏è Highest Repair Rate</button>
                <button class="tab-btn" id="tabBtnBest" onclick="showTab('bestTab')">‚úÖ Most Reliable</button>
                <button class="tab-btn" id="tabBtnCost" onclick="showTab('costTab')">üí∞ Highest Cost</button>
                <button class="tab-btn" id="tabBtnAccidental" onclick="showTab('accidentalTab')">üí• Accidental Damage</button>
                <button class="tab-btn" id="tabBtnWarranty" onclick="showTab('warrantyTab')">üìã Warranty Status</button>
                <button class="tab-btn" id="tabBtnAll" onclick="showTab('allTab')">üìÑ All Models</button>
            </div>
            
            <div id="worstTab" class="tab-content active">
                <table>
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Item #</th>
                            <th>Units Sold</th>
                            <th>Total Repairs</th>
                            <th>Repair Rate</th>
                            <th>Est. Cost</th>
                        </tr>
                    </thead>
                    <tbody id="worstTable"></tbody>
                </table>
            </div>
            
            <div id="bestTab" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Item #</th>
                            <th>Units Sold</th>
                            <th>Total Repairs</th>
                            <th>Repair Rate</th>
                            <th>Est. Cost</th>
                        </tr>
                    </thead>
                    <tbody id="bestTable"></tbody>
                </table>
            </div>
            
            <div id="costTab" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Item #</th>
                            <th>Total Repairs</th>
                            <th>Major ($100)</th>
                            <th>Minor ($50)</th>
                            <th>NPU/NPF ($20)</th>
                            <th>Est. Cost</th>
                        </tr>
                    </thead>
                    <tbody id="costTable"></tbody>
                </table>
            </div>
            
            <div id="accidentalTab" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Item #</th>
                            <th>Total Repairs</th>
                            <th>Accidental</th>
                            <th>Non-Accidental</th>
                            <th>Accidental %</th>
                        </tr>
                    </thead>
                    <tbody id="accidentalTable"></tbody>
                </table>
            </div>
            
            <div id="warrantyTab" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Item #</th>
                            <th>Total Repairs</th>
                            <th>In Warranty</th>
                            <th>Out of Warranty</th>
                            <th>In Warranty %</th>
                        </tr>
                    </thead>
                    <tbody id="warrantyTable"></tbody>
                </table>
            </div>
            
            <div id="allTab" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" data-column="model" onclick="sortAllModels('model')">Model ‚Üï</th>
                            <th class="sortable" data-column="item" onclick="sortAllModels('item')">Item # ‚Üï</th>
                            <th class="sortable" data-column="sold" onclick="sortAllModels('sold')">Units Sold ‚Üï</th>
                            <th class="sortable" data-column="total" onclick="sortAllModels('total')">Repairs ‚Üï</th>
                            <th class="sortable" data-column="rate" onclick="sortAllModels('rate')">Rate ‚Üï</th>
                            <th class="sortable" data-column="major" onclick="sortAllModels('major')">Major ‚Üï</th>
                            <th class="sortable" data-column="minor" onclick="sortAllModels('minor')">Minor ‚Üï</th>
                            <th class="sortable" data-column="npu" onclick="sortAllModels('npu')">NPU ‚Üï</th>
                            <th class="sortable" data-column="accidental" onclick="sortAllModels('accidental')">Accidental ‚Üï</th>
                            <th class="sortable" data-column="inWarranty" onclick="sortAllModels('inWarranty')">In Warranty ‚Üï</th>
                        </tr>
                    </thead>
                    <tbody id="allTable"></tbody>
                </table>
            </div>
        </div>
        
        <div class="footer">
            CTL Warranty Analysis Dashboard | Data: 2023-2025 | Live from Google Sheets<br>
            Filtered: Models with >1000 units sold | Excluded: NL71 and NL81 models
        </div>
    </div>

    <!-- Model Detail Modal -->
    <div class="modal" id="modelModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2 class="modal-title" id="modalTitle">Model Name</h2>
            <p class="modal-subtitle" id="modalItemNumber">Item #: XXXXX</p>
            
            <div class="modal-stats-grid" id="modalStatsGrid"></div>
            
            <div class="comparison">
                <h4>üìä Comparison to Fleet Average</h4>
                <div id="comparisonContent"></div>
            </div>
            
            <div class="top-repairs">
                <h4>üîß Top 10 Repairs for This Model</h4>
                <table class="repair-table">
                    <thead>
                        <tr>
                            <th>Repair Type</th>
                            <th>Count</th>
                            <th>% of Model</th>
                        </tr>
                    </thead>
                    <tbody id="modalRepairTable"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Pie Chart Modal -->
    <div class="modal" id="pieModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closePieModal()">&times;</span>
            <h2 class="modal-title" id="pieModalTitle">Category Breakdown</h2>
            <p class="modal-subtitle" id="pieModalSubtitle">Models in this category</p>
            
            <div id="pieModalStats" style="margin-bottom: 20px;"></div>
            
            <div class="top-repairs">
                <h4>üîß Top 10 Repairs in This Category</h4>
                <table class="repair-table">
                    <thead>
                        <tr>
                            <th>Repair Type</th>
                            <th>Count</th>
                            <th>% of Category</th>
                        </tr>
                    </thead>
                    <tbody id="pieModalRepairTable"></tbody>
                </table>
            </div>
            
            <h4 style="color: #4fc3f7; margin: 20px 0 15px;">üìã Models in This Category</h4>
            <table class="repair-table">
                <thead>
                    <tr>
                        <th>Model</th>
                        <th>Count</th>
                        <th>% of Category</th>
                    </tr>
                </thead>
                <tbody id="pieModalModelTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Configuration
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS9yLbvcLU16R73aNEIqwAVzJwz82UghVY5buEK5uuX9LHojAE9JoQoJ00-uuR2KzXTL-e6AwepOlFq/pub?gid=986703446&single=true&output=csv';
        const EXCLUDE_NL71_NL81 = true; // Set to false for all-models version
        const AUTO_REFRESH_INTERVAL = 6 * 60 * 60 * 1000; // 6 hours in milliseconds
        
        // Global data store
        let warrantyData = [];
        let dataByItem = {};
        let repairCategories = {};
        let rawData = [];
        let charts = {};
        let autoRefreshTimer = null;
        
        // Password check function
        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            const correctPassword = 'CTLdata20232026';
            
            if (password === correctPassword) {
                document.getElementById('passwordOverlay').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // Try to load data from localStorage
                if (loadFromLocalStorage()) {
                    // Data loaded from cache, initialize dashboard
                    initDashboard();
                } else {
                    // No cached data
                    document.getElementById('lastUpdated').textContent = 'Click Refresh to load data';
                }
                
                // Setup auto-refresh timer (6 hours)
                if (autoRefreshTimer) clearInterval(autoRefreshTimer);
                autoRefreshTimer = setInterval(refreshData, AUTO_REFRESH_INTERVAL);
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }
        
        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const storageKey = EXCLUDE_NL71_NL81 ? 'warrantyDashboardData' : 'warrantyDashboardDataAll';
                const savedData = localStorage.getItem(storageKey);
                if (!savedData) return false;
                
                const parsed = JSON.parse(savedData);
                warrantyData = parsed.warrantyData || [];
                repairCategories = parsed.repairCategories || {};
                // rawData is not stored - too large
                
                if (warrantyData.length === 0) return false;
                
                // Rebuild dataByItem lookup
                dataByItem = {};
                warrantyData.forEach(d => {
                    dataByItem[d.item] = d;
                });
                
                // Check if data is older than 6 hours
                const lastUpdatedStr = parsed.lastUpdated || '';
                const lastUpdatedTime = new Date(lastUpdatedStr);
                const now = new Date();
                const hoursSinceUpdate = (now - lastUpdatedTime) / (1000 * 60 * 60);
                
                if (hoursSinceUpdate >= 6) {
                    document.getElementById('lastUpdated').textContent = lastUpdatedStr + ' (stale - refreshing...)';
                    console.log('Cached data is older than 6 hours, will auto-refresh');
                    // Schedule refresh after dashboard loads
                    setTimeout(() => refreshData(), 1000);
                } else {
                    document.getElementById('lastUpdated').textContent = lastUpdatedStr + ' (cached)';
                }
                
                console.log('Loaded data from localStorage:', warrantyData.length, 'models');
                return true;
            } catch (e) {
                console.error('Error loading from localStorage:', e);
                return false;
            }
        }
        
        // Save data to localStorage
        function saveToLocalStorage() {
            try {
                const storageKey = EXCLUDE_NL71_NL81 ? 'warrantyDashboardData' : 'warrantyDashboardDataAll';
                const dataToSave = {
                    warrantyData: warrantyData,
                    repairCategories: repairCategories,
                    // Don't save rawData - it's too large and can be regenerated
                    lastUpdated: new Date().toLocaleString()
                };
                localStorage.setItem(storageKey, JSON.stringify(dataToSave));
                console.log('Saved data to localStorage:', warrantyData.length, 'models');
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                // If quota exceeded, try to clear old data and retry
                if (e.name === 'QuotaExceededError') {
                    console.log('Storage quota exceeded, clearing old data...');
                    localStorage.removeItem('warrantyDashboardData');
                    localStorage.removeItem('warrantyDashboardDataAll');
                }
            }
        }
        
        // Show/hide loading overlay
        function showLoading(message = 'Loading data from Google Sheets...') {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        // Refresh data function
        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.classList.add('loading');
            showLoading('Refreshing data from Google Sheets...');
            
            try {
                await loadDataAndInit();
            } catch (error) {
                console.error('Error refreshing data:', error);
                alert('Error refreshing data. Please try again.');
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                hideLoading();
            }
        }
        
        // Fetch and parse CSV from Google Sheets
        async function fetchData() {
            return new Promise((resolve, reject) => {
                Papa.parse(GOOGLE_SHEETS_URL, {
                    download: true,
                    header: true,
                    complete: function(results) {
                        resolve(results.data);
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }
        
        // Process raw data into aggregated format
        function processData(data) {
            // Filter: Only rows with Order Received Date
            const filtered = data.filter(row => 
                row['Order Received Date'] && 
                row['Order Received Date'].trim() !== '' &&
                row['Model Name'] && 
                row['Model Name'].trim() !== '' &&
                row['Model Name'].trim().toLowerCase() !== 'no match' &&
                row['Item Number'] &&
                row['Item Number'].trim() !== '' &&
                row['Item Number'].trim().toLowerCase() !== 'no match'
            );
            
            // Store raw data for repair categories
            rawData = filtered;
            
            // Group by Item Number
            const grouped = {};
            filtered.forEach(row => {
                const item = row['Item Number'].trim();
                if (!grouped[item]) {
                    grouped[item] = {
                        model: row['Model Name'].trim(),
                        item: item,
                        sold: parseInt(row['QTY Sold']) || 0,
                        rows: []
                    };
                }
                grouped[item].rows.push(row);
            });
            
            // Calculate metrics for each model
            const models = [];
            Object.values(grouped).forEach(group => {
                // Filter by QTY Sold > 1000
                if (group.sold <= 1000) return;
                
                // Exclude NL71/NL81 if configured
                if (EXCLUDE_NL71_NL81 && (group.model.includes('NL71') || group.model.includes('NL81'))) {
                    return;
                }
                
                let major = 0, minor = 0, npu = 0, accidental = 0, inWarranty = 0, outWarranty = 0;
                
                group.rows.forEach(row => {
                    const repair = (row['Repair'] || '').trim();
                    const isMajor = (row['Major Repairs'] || '').trim().toLowerCase() === 'yes';
                    const accDamage = (row['Accidental Damage'] || '').trim().toLowerCase();
                    const warranty = (row['Warranty Status'] || '').trim().toLowerCase();
                    
                    // Count repair types
                    if (repair.toLowerCase().includes('npu') || repair.toLowerCase().includes('npf')) {
                        npu++;
                    } else if (isMajor) {
                        major++;
                    } else {
                        minor++;
                    }
                    
                    // Count accidental
                    if (accDamage === 'yes' || accDamage === 'liquid') {
                        accidental++;
                    }
                    
                    // Count warranty status
                    if (warranty === 'in warranty') {
                        inWarranty++;
                    } else if (warranty === 'out of warranty') {
                        outWarranty++;
                    }
                });
                
                models.push({
                    model: group.model,
                    item: group.item,
                    sold: group.sold,
                    major: major,
                    minor: minor,
                    npu: npu,
                    accidental: accidental,
                    total: group.rows.length,
                    inWarranty: inWarranty,
                    outWarranty: outWarranty
                });
            });
            
            return models;
        }
        
        // Generate repair categories from raw data
        function generateRepairCategories() {
            const categories = {
                modelRepairs: {},
                overallTop10: [],
                accidentalTop10: [],
                nonAccidentalTop10: [],
                inWarrantyTop10: [],
                outWarrantyTop10: [],
                majorTop10: [],
                minorTop10: [],
                npuTop10: []
            };
            
            // Filter rawData based on current models
            const validItems = new Set(warrantyData.map(d => d.item));
            const filteredRaw = rawData.filter(row => validItems.has(row['Item Number']?.trim()));
            
            // Overall repairs
            const overallCounts = {};
            const accidentalCounts = {};
            const nonAccidentalCounts = {};
            const inWarrantyCounts = {};
            const outWarrantyCounts = {};
            const majorCounts = {};
            const minorCounts = {};
            const npuCounts = {};
            
            // Per-model repairs
            const modelCounts = {};
            
            filteredRaw.forEach(row => {
                const repair = (row['Repair'] || '').trim();
                const item = (row['Item Number'] || '').trim();
                const accDamage = (row['Accidental Damage'] || '').trim().toLowerCase();
                const warranty = (row['Warranty Status'] || '').trim().toLowerCase();
                const isMajor = (row['Major Repairs'] || '').trim().toLowerCase() === 'yes';
                
                if (!repair) return;
                
                // Overall
                overallCounts[repair] = (overallCounts[repair] || 0) + 1;
                
                // By model
                if (!modelCounts[item]) modelCounts[item] = {};
                modelCounts[item][repair] = (modelCounts[item][repair] || 0) + 1;
                
                // Accidental vs Non-Accidental
                if (accDamage === 'yes' || accDamage === 'liquid') {
                    accidentalCounts[repair] = (accidentalCounts[repair] || 0) + 1;
                } else {
                    nonAccidentalCounts[repair] = (nonAccidentalCounts[repair] || 0) + 1;
                }
                
                // Warranty
                if (warranty === 'in warranty') {
                    inWarrantyCounts[repair] = (inWarrantyCounts[repair] || 0) + 1;
                } else if (warranty === 'out of warranty') {
                    outWarrantyCounts[repair] = (outWarrantyCounts[repair] || 0) + 1;
                }
                
                // Major/Minor/NPU
                if (repair.toLowerCase().includes('npu') || repair.toLowerCase().includes('npf')) {
                    npuCounts[repair] = (npuCounts[repair] || 0) + 1;
                } else if (isMajor) {
                    majorCounts[repair] = (majorCounts[repair] || 0) + 1;
                } else {
                    minorCounts[repair] = (minorCounts[repair] || 0) + 1;
                }
            });
            
            // Convert to sorted arrays
            const toSortedArray = (obj) => Object.entries(obj).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            categories.overallTop10 = toSortedArray(overallCounts);
            categories.accidentalTop10 = toSortedArray(accidentalCounts);
            categories.nonAccidentalTop10 = toSortedArray(nonAccidentalCounts);
            categories.inWarrantyTop10 = toSortedArray(inWarrantyCounts);
            categories.outWarrantyTop10 = toSortedArray(outWarrantyCounts);
            categories.majorTop10 = toSortedArray(majorCounts);
            categories.minorTop10 = toSortedArray(minorCounts);
            categories.npuTop10 = toSortedArray(npuCounts);
            
            // Model repairs
            Object.keys(modelCounts).forEach(item => {
                categories.modelRepairs[item] = Object.entries(modelCounts[item])
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
            });
            
            return categories;
        }
        
        // Load data and initialize dashboard
        async function loadDataAndInit() {
            showLoading();
            
            try {
                const data = await fetchData();
                warrantyData = processData(data);
                repairCategories = generateRepairCategories();
                
                // Calculate derived metrics
                warrantyData.forEach(d => {
                    d.repairRate = ((d.total / d.sold) * 100).toFixed(2);
                    d.totalCost = (d.major * 100) + (d.minor * 50) + (d.npu * 20);
                    d.accidentalPct = d.total > 0 ? ((d.accidental / d.total) * 100).toFixed(2) : "0.00";
                    d.inWarrantyPct = (d.inWarranty + d.outWarranty) > 0 ? 
                        ((d.inWarranty / (d.inWarranty + d.outWarranty)) * 100).toFixed(2) : "0.00";
                    d.outWarrantyPct = (d.inWarranty + d.outWarranty) > 0 ? 
                        ((d.outWarranty / (d.inWarranty + d.outWarranty)) * 100).toFixed(2) : "0.00";
                    d.shortName = d.model.replace('CTL Chromebook ', '').replace('CTL ', '').substring(0, 20);
                    dataByItem[d.item] = d;
                });
                
                // Sort by total repairs (descending) for consistent display
                warrantyData.sort((a, b) => b.total - a.total);
                
                // Initialize dashboard
                initDashboard();
                
                // Update last updated timestamp
                const now = new Date();
                document.getElementById('lastUpdated').textContent = now.toLocaleString();
                
                // Save to localStorage for persistence
                saveToLocalStorage();
                
                // Setup auto-refresh
                if (autoRefreshTimer) clearInterval(autoRefreshTimer);
                autoRefreshTimer = setInterval(refreshData, AUTO_REFRESH_INTERVAL);
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data from Google Sheets. Please check the URL and try again.');
            } finally {
                hideLoading();
            }
        }
        
        // Destroy existing charts
        function destroyCharts() {
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
        }
        
        // Modal functions
        function openModal(itemNumber) {
            const data = dataByItem[itemNumber];
            if (!data) return;
            
            document.getElementById('modalTitle').textContent = data.model;
            document.getElementById('modalItemNumber').textContent = `Item #: ${data.item}`;
            
            // Stats grid
            document.getElementById('modalStatsGrid').innerHTML = `
                <div class="modal-stat">
                    <div class="modal-stat-value">${data.sold.toLocaleString()}</div>
                    <div class="modal-stat-label">Units Sold</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value warning">${data.total.toLocaleString()}</div>
                    <div class="modal-stat-label">Total Repairs</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value ${parseFloat(data.repairRate) > 10 ? 'danger' : parseFloat(data.repairRate) > 5 ? 'warning' : 'success'}">${data.repairRate}%</div>
                    <div class="modal-stat-label">Repair Rate</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value warning">$${data.totalCost.toLocaleString()}</div>
                    <div class="modal-stat-label">Est. Total Cost</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${data.major.toLocaleString()}</div>
                    <div class="modal-stat-label">Major Repairs</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${data.minor.toLocaleString()}</div>
                    <div class="modal-stat-label">Minor Repairs</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value">${data.npu.toLocaleString()}</div>
                    <div class="modal-stat-label">NPU/NPF</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value purple">${data.accidentalPct}%</div>
                    <div class="modal-stat-label">Accidental %</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-value success">${data.inWarrantyPct}%</div>
                    <div class="modal-stat-label">In Warranty %</div>
                </div>
            `;
            
            // Fleet averages
            const totalSold = warrantyData.reduce((sum, d) => sum + d.sold, 0);
            const totalRepairs = warrantyData.reduce((sum, d) => sum + d.total, 0);
            const totalAccidental = warrantyData.reduce((sum, d) => sum + d.accidental, 0);
            const totalInWarranty = warrantyData.reduce((sum, d) => sum + d.inWarranty, 0);
            const totalOutWarranty = warrantyData.reduce((sum, d) => sum + d.outWarranty, 0);
            
            const fleetRepairRate = ((totalRepairs / totalSold) * 100).toFixed(2);
            const fleetAccidentalPct = ((totalAccidental / totalRepairs) * 100).toFixed(2);
            const fleetInWarrantyPct = ((totalInWarranty / (totalInWarranty + totalOutWarranty)) * 100).toFixed(2);
            
            const compareRate = (val, fleet, inverse = false) => {
                const diff = parseFloat(val) - parseFloat(fleet);
                const better = inverse ? diff > 0 : diff < 0;
                const color = better ? '#81c784' : '#ef5350';
                const arrow = diff > 0 ? '‚Üë' : '‚Üì';
                return `<span style="color: ${color}">${Math.abs(diff).toFixed(2)}% ${arrow}</span>`;
            };
            
            document.getElementById('comparisonContent').innerHTML = `
                <div class="comparison-item">
                    <span>Repair Rate</span>
                    <span>${data.repairRate}% vs ${fleetRepairRate}% fleet avg ${compareRate(data.repairRate, fleetRepairRate)}</span>
                </div>
                <div class="comparison-item">
                    <span>Accidental Damage</span>
                    <span>${data.accidentalPct}% vs ${fleetAccidentalPct}% fleet avg ${compareRate(data.accidentalPct, fleetAccidentalPct)}</span>
                </div>
                <div class="comparison-item">
                    <span>In Warranty</span>
                    <span>${data.inWarrantyPct}% vs ${fleetInWarrantyPct}% fleet avg ${compareRate(data.inWarrantyPct, fleetInWarrantyPct, true)}</span>
                </div>
            `;
            
            // Top repairs for this model
            const modelRepairs = repairCategories.modelRepairs[data.item] || [];
            document.getElementById('modalRepairTable').innerHTML = modelRepairs.map(([repair, count]) => `
                <tr>
                    <td>${repair}</td>
                    <td>${count.toLocaleString()}</td>
                    <td>${((count / data.total) * 100).toFixed(1)}%</td>
                </tr>
            `).join('') || '<tr><td colspan="3">No repair data available</td></tr>';
            
            document.getElementById('modelModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('modelModal').classList.remove('active');
        }
        
        // Pie Modal functions
        function openPieModal(category, index) {
            let title, subtitle, models, topRepairs, totalCount;
            
            const totalRepairs = warrantyData.reduce((sum, d) => sum + d.total, 0);
            const totalMajor = warrantyData.reduce((sum, d) => sum + d.major, 0);
            const totalMinor = warrantyData.reduce((sum, d) => sum + d.minor, 0);
            const totalNPU = warrantyData.reduce((sum, d) => sum + d.npu, 0);
            const totalAccidental = warrantyData.reduce((sum, d) => sum + d.accidental, 0);
            const totalInWarranty = warrantyData.reduce((sum, d) => sum + d.inWarranty, 0);
            const totalOutWarranty = warrantyData.reduce((sum, d) => sum + d.outWarranty, 0);
            
            switch(category) {
                case 'repairType':
                    if (index === 0) { // Major
                        title = 'üîß Major Repairs';
                        totalCount = totalMajor;
                        models = warrantyData.map(d => ({ name: d.shortName, count: d.major, item: d.item }))
                            .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        topRepairs = repairCategories.majorTop10;
                    } else if (index === 1) { // Minor
                        title = 'üîß Minor Repairs';
                        totalCount = totalMinor;
                        models = warrantyData.map(d => ({ name: d.shortName, count: d.minor, item: d.item }))
                            .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        topRepairs = repairCategories.minorTop10;
                    } else { // NPU
                        title = 'üîß NPU/NPF Repairs';
                        totalCount = totalNPU;
                        models = warrantyData.map(d => ({ name: d.shortName, count: d.npu, item: d.item }))
                            .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        topRepairs = repairCategories.npuTop10;
                    }
                    break;
                case 'accidental':
                    if (index === 0) { // Accidental
                        title = 'üí• Accidental Damage';
                        totalCount = totalAccidental;
                        models = warrantyData.map(d => ({ name: d.shortName, count: d.accidental, item: d.item }))
                            .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        topRepairs = repairCategories.accidentalTop10;
                    } else { // Non-Accidental
                        title = 'üîß Non-Accidental Damage';
                        totalCount = totalRepairs - totalAccidental;
                        models = warrantyData.map(d => ({ name: d.shortName, count: d.total - d.accidental, item: d.item }))
                            .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        topRepairs = repairCategories.nonAccidentalTop10;
                    }
                    break;
                case 'warrantyStatus':
                    if (index === 0) { // In Warranty
                        title = 'üìã In Warranty Repairs';
                        totalCount = totalInWarranty;
                        models = warrantyData.map(d => ({ name: d.shortName, count: d.inWarranty, item: d.item }))
                            .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        topRepairs = repairCategories.inWarrantyTop10;
                    } else { // Out of Warranty
                        title = 'üìã Out of Warranty Repairs';
                        totalCount = totalOutWarranty;
                        models = warrantyData.map(d => ({ name: d.shortName, count: d.outWarranty, item: d.item }))
                            .filter(m => m.count > 0).sort((a, b) => b.count - a.count);
                        topRepairs = repairCategories.outWarrantyTop10;
                    }
                    break;
                default:
                    return;
            }
            
            subtitle = `${totalCount.toLocaleString()} total repairs in this category`;
            
            document.getElementById('pieModalTitle').textContent = title;
            document.getElementById('pieModalSubtitle').textContent = subtitle;
            
            document.getElementById('pieModalStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div class="modal-stat">
                        <div class="modal-stat-value">${totalCount.toLocaleString()}</div>
                        <div class="modal-stat-label">Total in Category</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${models.length}</div>
                        <div class="modal-stat-label">Models Affected</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${((totalCount / totalRepairs) * 100).toFixed(1)}%</div>
                        <div class="modal-stat-label">% of All Repairs</div>
                    </div>
                </div>
            `;
            
            // Top repairs table
            document.getElementById('pieModalRepairTable').innerHTML = (topRepairs || []).map(([repair, count]) => `
                <tr>
                    <td>${repair}</td>
                    <td>${count.toLocaleString()}</td>
                    <td>${((count / totalCount) * 100).toFixed(1)}%</td>
                </tr>
            `).join('') || '<tr><td colspan="3">No data available</td></tr>';
            
            // Models table
            document.getElementById('pieModalModelTable').innerHTML = models.slice(0, 15).map(m => `
                <tr onclick="closePieModal(); openModal('${m.item}')" style="cursor: pointer;">
                    <td>${m.name}</td>
                    <td>${m.count.toLocaleString()}</td>
                    <td>${((m.count / totalCount) * 100).toFixed(1)}%</td>
                </tr>
            `).join('');
            
            // Restore model table visibility (may have been hidden by KPI modal)
            document.querySelector('#pieModal h4:last-of-type').style.display = '';
            document.getElementById('pieModalModelTable').parentElement.style.display = '';
            
            document.getElementById('pieModal').classList.add('active');
        }
        
        function closePieModal() {
            document.getElementById('pieModal').classList.remove('active');
        }
        
        // KPI Modal function
        function openKpiModal(kpiType) {
            if (!warrantyData || warrantyData.length === 0) {
                alert('Please load data first by clicking the Refresh button.');
                return;
            }
            
            let title, subtitle, models, totalValue;
            
            const totalSold = warrantyData.reduce((sum, d) => sum + d.sold, 0);
            const totalRepairs = warrantyData.reduce((sum, d) => sum + d.total, 0);
            const totalCost = warrantyData.reduce((sum, d) => sum + d.totalCost, 0);
            const totalAccidental = warrantyData.reduce((sum, d) => sum + d.accidental, 0);
            const totalInWarranty = warrantyData.reduce((sum, d) => sum + d.inWarranty, 0);
            const totalOutWarranty = warrantyData.reduce((sum, d) => sum + d.outWarranty, 0);
            
            switch(kpiType) {
                case 'unitsSold':
                    title = 'üì¶ Total Units Sold Breakdown';
                    subtitle = `${totalSold.toLocaleString()} total units across ${warrantyData.length} models`;
                    models = [...warrantyData].sort((a, b) => b.sold - a.sold);
                    totalValue = totalSold;
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value">${totalSold.toLocaleString()}</div>
                                <div class="modal-stat-label">Total Units Sold</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value">${warrantyData.length}</div>
                                <div class="modal-stat-label">Models</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value">${Math.round(totalSold / warrantyData.length).toLocaleString()}</div>
                                <div class="modal-stat-label">Avg per Model</div>
                            </div>
                        </div>
                    `;
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td>${d.sold.toLocaleString()}</td>
                            <td>${((d.sold / totalSold) * 100).toFixed(1)}%</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üì¶ Top Models by Units Sold';
                    break;
                    
                case 'totalRepairs':
                    title = 'üîß Total Repairs Breakdown';
                    subtitle = `${totalRepairs.toLocaleString()} total repairs across ${warrantyData.length} models`;
                    models = [...warrantyData].sort((a, b) => b.total - a.total);
                    totalValue = totalRepairs;
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value warning">${totalRepairs.toLocaleString()}</div>
                                <div class="modal-stat-label">Total Repairs</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value">${warrantyData.length}</div>
                                <div class="modal-stat-label">Models</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value">${Math.round(totalRepairs / warrantyData.length).toLocaleString()}</div>
                                <div class="modal-stat-label">Avg per Model</div>
                            </div>
                        </div>
                    `;
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td>${d.total.toLocaleString()}</td>
                            <td>${((d.total / totalRepairs) * 100).toFixed(1)}%</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üîß Top Models by Total Repairs';
                    break;
                    
                case 'repairRate':
                    title = 'üìä Repair Rate Breakdown';
                    const avgRate = ((totalRepairs / totalSold) * 100).toFixed(2);
                    subtitle = `${avgRate}% overall repair rate`;
                    models = [...warrantyData].sort((a, b) => parseFloat(b.repairRate) - parseFloat(a.repairRate));
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value danger">${avgRate}%</div>
                                <div class="modal-stat-label">Overall Repair Rate</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value danger">${models[0]?.repairRate || 0}%</div>
                                <div class="modal-stat-label">Highest Rate</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value success">${models[models.length-1]?.repairRate || 0}%</div>
                                <div class="modal-stat-label">Lowest Rate</div>
                            </div>
                        </div>
                    `;
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td>${d.repairRate}%</td>
                            <td>${d.total.toLocaleString()} / ${d.sold.toLocaleString()}</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üìä Models by Repair Rate (Highest First)';
                    break;
                    
                case 'totalCost':
                    title = 'üí∞ Repair Cost Breakdown';
                    subtitle = `$${totalCost.toLocaleString()} total estimated repair cost`;
                    models = [...warrantyData].sort((a, b) => b.totalCost - a.totalCost);
                    const totalMajorCost = warrantyData.reduce((sum, d) => sum + (d.major * 100), 0);
                    const totalMinorCost = warrantyData.reduce((sum, d) => sum + (d.minor * 50), 0);
                    const totalNpuCost = warrantyData.reduce((sum, d) => sum + (d.npu * 20), 0);
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value warning">$${totalCost.toLocaleString()}</div>
                                <div class="modal-stat-label">Total Cost</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value" style="color: #ef5350;">$${totalMajorCost.toLocaleString()}</div>
                                <div class="modal-stat-label">Major ($100 ea)</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value" style="color: #ffb74d;">$${totalMinorCost.toLocaleString()}</div>
                                <div class="modal-stat-label">Minor ($50 ea)</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value" style="color: #4fc3f7;">$${totalNpuCost.toLocaleString()}</div>
                                <div class="modal-stat-label">NPU/NPF ($20 ea)</div>
                            </div>
                        </div>
                    `;
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td>$${d.totalCost.toLocaleString()}</td>
                            <td>${((d.totalCost / totalCost) * 100).toFixed(1)}%</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üí∞ Top Models by Repair Cost';
                    break;
                    
                case 'accidental':
                    title = 'üí• Accidental Damage Breakdown';
                    const accidentalPct = ((totalAccidental / totalRepairs) * 100).toFixed(1);
                    subtitle = `${accidentalPct}% of repairs are accidental (${totalAccidental.toLocaleString()} repairs)`;
                    models = [...warrantyData].sort((a, b) => b.accidental - a.accidental);
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value purple">${totalAccidental.toLocaleString()}</div>
                                <div class="modal-stat-label">Accidental Repairs</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value">${(totalRepairs - totalAccidental).toLocaleString()}</div>
                                <div class="modal-stat-label">Non-Accidental</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value purple">${accidentalPct}%</div>
                                <div class="modal-stat-label">Accidental Rate</div>
                            </div>
                        </div>
                    `;
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td>${d.accidental.toLocaleString()}</td>
                            <td>${d.accidentalPct}%</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üí• Top Models by Accidental Repairs';
                    break;
                    
                case 'inWarranty':
                    title = 'üìã Warranty Status Breakdown';
                    const inWarrantyPct = ((totalInWarranty / (totalInWarranty + totalOutWarranty)) * 100).toFixed(1);
                    subtitle = `${inWarrantyPct}% of repairs are in warranty (${totalInWarranty.toLocaleString()} repairs)`;
                    models = [...warrantyData].sort((a, b) => b.inWarranty - a.inWarranty);
                    document.getElementById('pieModalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div class="modal-stat">
                                <div class="modal-stat-value success">${totalInWarranty.toLocaleString()}</div>
                                <div class="modal-stat-label">In Warranty</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value danger">${totalOutWarranty.toLocaleString()}</div>
                                <div class="modal-stat-label">Out of Warranty</div>
                            </div>
                            <div class="modal-stat">
                                <div class="modal-stat-value success">${inWarrantyPct}%</div>
                                <div class="modal-stat-label">In Warranty Rate</div>
                            </div>
                        </div>
                    `;
                    document.getElementById('pieModalRepairTable').innerHTML = models.slice(0, 15).map(d => `
                        <tr onclick="closePieModal(); openModal('${d.item}')" style="cursor: pointer;">
                            <td>${d.shortName}</td>
                            <td>${d.inWarranty.toLocaleString()}</td>
                            <td>${d.inWarrantyPct}%</td>
                        </tr>
                    `).join('');
                    document.querySelector('#pieModal .top-repairs h4').textContent = 'üìã Top Models by In Warranty Repairs';
                    break;
                    
                default:
                    return;
            }
            
            document.getElementById('pieModalTitle').textContent = title;
            document.getElementById('pieModalSubtitle').textContent = subtitle;
            
            // Hide the model table section for KPI modals
            document.querySelector('#pieModal h4:last-of-type').style.display = 'none';
            document.getElementById('pieModalModelTable').parentElement.style.display = 'none';
            
            document.getElementById('pieModal').classList.add('active');
        }
        
        // Tab switching
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
        
        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        };
        
        function initDashboard() {
            // Destroy existing charts first
            destroyCharts();
            
            // Calculate totals
            const totalSold = warrantyData.reduce((sum, d) => sum + d.sold, 0);
            const totalRepairs = warrantyData.reduce((sum, d) => sum + d.total, 0);
            const totalMajor = warrantyData.reduce((sum, d) => sum + d.major, 0);
            const totalMinor = warrantyData.reduce((sum, d) => sum + d.minor, 0);
            const totalNPU = warrantyData.reduce((sum, d) => sum + d.npu, 0);
            const totalAccidental = warrantyData.reduce((sum, d) => sum + d.accidental, 0);
            const totalInWarranty = warrantyData.reduce((sum, d) => sum + d.inWarranty, 0);
            const totalOutWarranty = warrantyData.reduce((sum, d) => sum + d.outWarranty, 0);
            const totalCost = warrantyData.reduce((sum, d) => sum + d.totalCost, 0);
            
            // Update KPIs
            document.getElementById('kpiUnitsSold').textContent = totalSold.toLocaleString();
            document.getElementById('kpiTotalRepairs').textContent = totalRepairs.toLocaleString();
            document.getElementById('kpiRepairRate').textContent = ((totalRepairs / totalSold) * 100).toFixed(2) + '%';
            document.getElementById('kpiTotalCost').textContent = '$' + totalCost.toLocaleString();
            document.getElementById('kpiAccidental').textContent = ((totalAccidental / totalRepairs) * 100).toFixed(1) + '%';
            document.getElementById('kpiInWarranty').textContent = ((totalInWarranty / (totalInWarranty + totalOutWarranty)) * 100).toFixed(1) + '%';
            
            // Sort data for different views
            const byRepairRate = [...warrantyData].sort((a, b) => parseFloat(b.repairRate) - parseFloat(a.repairRate));
            const byReliable = [...warrantyData].sort((a, b) => parseFloat(a.repairRate) - parseFloat(b.repairRate));
            const byCost = [...warrantyData].sort((a, b) => b.totalCost - a.totalCost);
            const byAccidental = [...warrantyData].filter(d => d.total >= 100).sort((a, b) => parseFloat(b.accidentalPct) - parseFloat(a.accidentalPct));
            
            // Create click handler for charts
            const createClickHandler = (dataArray) => {
                return function(event, elements) {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        openModal(dataArray[index].item);
                    }
                };
            };
            
            // Color gradients
            const redGradient = byRepairRate.slice(0, 15).map((_, i) => {
                const intensity = 1 - (i / 15) * 0.5;
                return `rgba(239, 83, 80, ${intensity})`;
            });
            
            const orangeGradient = byCost.slice(0, 15).map((_, i) => {
                const intensity = 1 - (i / 15) * 0.5;
                return `rgba(255, 183, 77, ${intensity})`;
            });
            
            const purpleGradient = byAccidental.slice(0, 15).map((_, i) => {
                const intensity = 1 - (i / 15) * 0.5;
                return `rgba(186, 104, 200, ${intensity})`;
            });
            
            // Repair Rate Chart
            charts.repairRate = new Chart(document.getElementById('repairRateChart'), {
                type: 'bar',
                data: {
                    labels: byRepairRate.slice(0, 15).map(d => d.shortName),
                    datasets: [{
                        label: 'Repair Rate (%)',
                        data: byRepairRate.slice(0, 15).map(d => parseFloat(d.repairRate)),
                        backgroundColor: redGradient,
                        borderColor: redGradient.map(c => c.replace('0.', '1.')),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: createClickHandler(byRepairRate.slice(0, 15)),
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const d = byRepairRate[context.dataIndex];
                                    return `Repair Rate: ${d.repairRate}%`;
                                },
                                afterLabel: function(context) {
                                    const d = byRepairRate[context.dataIndex];
                                    return `${d.total.toLocaleString()} repairs from ${d.sold.toLocaleString()} units\nClick for details`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#b0b0b0' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            title: { display: true, text: 'Repair Rate (%)', color: '#90a4ae' }
                        },
                        y: {
                            ticks: { color: '#e4e4e4', font: { size: 10 } },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Cost Chart
            charts.cost = new Chart(document.getElementById('costChart'), {
                type: 'bar',
                data: {
                    labels: byCost.slice(0, 15).map(d => d.shortName),
                    datasets: [{
                        label: 'Est. Repair Cost ($)',
                        data: byCost.slice(0, 15).map(d => d.totalCost),
                        backgroundColor: orangeGradient,
                        borderColor: orangeGradient.map(c => c.replace('0.', '1.')),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: createClickHandler(byCost.slice(0, 15)),
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Est. Cost: $${context.raw.toLocaleString()}`;
                                },
                                afterLabel: function(context) {
                                    const d = byCost[context.dataIndex];
                                    return `Major: ${d.major} | Minor: ${d.minor} | NPU: ${d.npu}\nClick for details`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#b0b0b0',
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { color: '#e4e4e4', font: { size: 10 } },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Repair Type Pie Chart
            charts.repairType = new Chart(document.getElementById('repairTypeChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Major ($100)', 'Minor ($50)', 'NPU/NPF ($20)'],
                    datasets: [{
                        data: [totalMajor, totalMinor, totalNPU],
                        backgroundColor: ['#ef5350', '#ffb74d', '#4fc3f7'],
                        borderColor: '#1a2d47',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            openPieModal('repairType', elements[0].index);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e4e4e4', padding: 15 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = ((value / totalRepairs) * 100).toFixed(1);
                                    return `${context.label}: ${value.toLocaleString()} (${percentage}%)`;
                                },
                                afterLabel: function() {
                                    return 'Click for model breakdown';
                                }
                            }
                        }
                    }
                }
            });
            
            // Accidental Pie Chart
            charts.accidentalPie = new Chart(document.getElementById('accidentalPieChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Accidental', 'Non-Accidental'],
                    datasets: [{
                        data: [totalAccidental, totalRepairs - totalAccidental],
                        backgroundColor: ['#ba68c8', '#64b5f6'],
                        borderColor: '#1a2d47',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            openPieModal('accidental', elements[0].index);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e4e4e4', padding: 15 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = ((value / totalRepairs) * 100).toFixed(1);
                                    return `${context.label}: ${value.toLocaleString()} (${percentage}%)`;
                                },
                                afterLabel: function() {
                                    return 'Click for model breakdown';
                                }
                            }
                        }
                    }
                }
            });
            
            // Cost Breakdown Pie Chart
            const majorCost = totalMajor * 100;
            const minorCost = totalMinor * 50;
            const npuCost = totalNPU * 20;
            
            charts.costPie = new Chart(document.getElementById('costPieChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Major Repairs', 'Minor Repairs', 'NPU/NPF'],
                    datasets: [{
                        data: [majorCost, minorCost, npuCost],
                        backgroundColor: ['#ef5350', '#ffb74d', '#4fc3f7'],
                        borderColor: '#1a2d47',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            openPieModal('repairType', elements[0].index);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e4e4e4', padding: 15 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = ((value / totalCost) * 100).toFixed(1);
                                    return `${context.label}: $${value.toLocaleString()} (${percentage}%)`;
                                },
                                afterLabel: function() {
                                    return 'Click for model breakdown';
                                }
                            }
                        }
                    }
                }
            });
            
            // Accidental Damage Rate Chart
            charts.accidental = new Chart(document.getElementById('accidentalChart'), {
                type: 'bar',
                data: {
                    labels: byAccidental.slice(0, 15).map(d => d.shortName),
                    datasets: [{
                        label: 'Accidental Damage Rate (%)',
                        data: byAccidental.slice(0, 15).map(d => parseFloat(d.accidentalPct)),
                        backgroundColor: purpleGradient,
                        borderColor: purpleGradient.map(c => c.replace('0.', '1.')),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: createClickHandler(byAccidental.slice(0, 15)),
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Accidental: ${context.raw}%`;
                                },
                                afterLabel: function(context) {
                                    const d = byAccidental[context.dataIndex];
                                    return `${d.accidental.toLocaleString()} of ${d.total.toLocaleString()} repairs\nClick for details`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#b0b0b0' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            title: { display: true, text: 'Accidental %', color: '#90a4ae' }
                        },
                        y: {
                            ticks: { color: '#e4e4e4', font: { size: 10 } },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Warranty Status Chart
            charts.warranty = new Chart(document.getElementById('warrantyChart'), {
                type: 'doughnut',
                data: {
                    labels: ['In Warranty', 'Out of Warranty'],
                    datasets: [{
                        data: [totalInWarranty, totalOutWarranty],
                        backgroundColor: ['#81c784', '#e57373'],
                        borderColor: '#1a2d47',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            openPieModal('warrantyStatus', elements[0].index);
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e4e4e4', padding: 15 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = totalInWarranty + totalOutWarranty;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toLocaleString()} (${percentage}%)`;
                                },
                                afterLabel: function() {
                                    return 'Click for model breakdown';
                                }
                            }
                        }
                    }
                }
            });
            
            // Accidental Damage Cost by Model Chart (100+ repairs only)
            const byAccidentalCost = [...warrantyData]
                .filter(d => d.total >= 100)
                .map(d => {
                    const avgCostPerRepair = d.totalCost / d.total;
                    const accidentalCost = Math.round(d.accidental * avgCostPerRepair);
                    return { ...d, accidentalCost };
                })
                .sort((a, b) => b.accidentalCost - a.accidentalCost);
            
            const accidentalCostGradient = byAccidentalCost.slice(0, 15).map((_, i) => {
                const intensity = 1 - (i / 15) * 0.5;
                return `rgba(186, 104, 200, ${intensity})`;
            });
            
            charts.accidentalCost = new Chart(document.getElementById('accidentalCostChart'), {
                type: 'bar',
                data: {
                    labels: byAccidentalCost.slice(0, 15).map(d => d.shortName),
                    datasets: [{
                        label: 'Accidental Damage Cost ($)',
                        data: byAccidentalCost.slice(0, 15).map(d => d.accidentalCost),
                        backgroundColor: accidentalCostGradient,
                        borderColor: accidentalCostGradient.map(c => c.replace('0.', '1.')),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: createClickHandler(byAccidentalCost.slice(0, 15)),
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Est. Cost: $${context.raw.toLocaleString()}`;
                                },
                                afterLabel: function(context) {
                                    const d = byAccidentalCost[context.dataIndex];
                                    return `Accidental Repairs: ${d.accidental.toLocaleString()}\nClick for model details`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#b0b0b0',
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { color: '#e4e4e4', font: { size: 10 } },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Warranty Cost Breakdown Chart
            const totalInWarrantyCost = warrantyData.reduce((sum, d) => {
                const avgCostPerRepair = d.total > 0 ? d.totalCost / d.total : 0;
                return sum + Math.round(d.inWarranty * avgCostPerRepair);
            }, 0);
            const totalOutWarrantyCost = warrantyData.reduce((sum, d) => {
                const avgCostPerRepair = d.total > 0 ? d.totalCost / d.total : 0;
                return sum + Math.round(d.outWarranty * avgCostPerRepair);
            }, 0);
            
            charts.warrantyCost = new Chart(document.getElementById('warrantyCostChart'), {
                type: 'doughnut',
                data: {
                    labels: ['In Warranty', 'Out of Warranty'],
                    datasets: [{
                        data: [totalInWarrantyCost, totalOutWarrantyCost],
                        backgroundColor: ['#81c784', '#e57373'],
                        borderColor: '#1a2d47',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e4e4e4', padding: 15 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = totalInWarrantyCost + totalOutWarrantyCost;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: $${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Generate Insights
            const insights = [
                {
                    icon: '‚ö†Ô∏è',
                    title: `Highest Repair Rate: ${byRepairRate[0]?.model || 'N/A'}`,
                    text: byRepairRate[0] ? `At ${byRepairRate[0].repairRate}% repair rate with ${byRepairRate[0].total.toLocaleString()} repairs from ${byRepairRate[0].sold.toLocaleString()} units sold. This model requires attention for quality improvement.` : 'No data available'
                },
                {
                    icon: '‚úÖ',
                    title: `Most Reliable: ${byReliable[0]?.model || 'N/A'}`,
                    text: byReliable[0] ? `Only ${byReliable[0].repairRate}% repair rate with just ${byReliable[0].total.toLocaleString()} repairs from ${byReliable[0].sold.toLocaleString()} units sold. Excellent reliability performance.` : 'No data available'
                },
                {
                    icon: 'üí∞',
                    title: `Highest Repair Cost: ${byCost[0]?.model || 'N/A'}`,
                    text: byCost[0] ? `Estimated total repair cost of $${byCost[0].totalCost.toLocaleString()} with ${byCost[0].major.toLocaleString()} major, ${byCost[0].minor.toLocaleString()} minor, and ${byCost[0].npu.toLocaleString()} NPU/NPF repairs.` : 'No data available'
                },
                {
                    icon: 'üí•',
                    title: `${((totalAccidental / totalRepairs) * 100).toFixed(1)}% Accidental Damage`,
                    text: byAccidental[0] ? `${((totalAccidental / totalRepairs) * 100).toFixed(1)}% of all repairs are classified as accidental damage (${totalAccidental.toLocaleString()} of ${totalRepairs.toLocaleString()} total repairs). ${byAccidental[0]?.shortName || 'N/A'} has highest at ${byAccidental[0]?.accidentalPct || 0}%.` : 'No data available'
                },
                {
                    icon: 'üìã',
                    title: `${((totalInWarranty / (totalInWarranty + totalOutWarranty)) * 100).toFixed(1)}% In Warranty`,
                    text: `${totalInWarranty.toLocaleString()} repairs performed in warranty vs ${totalOutWarranty.toLocaleString()} out of warranty. This represents significant warranty cost exposure.`
                }
            ];
            
            document.getElementById('insightsList').innerHTML = insights.map(i => `
                <div class="insight-item">
                    <span class="insight-icon">${i.icon}</span>
                    <div class="insight-content">
                        <h4>${i.title}</h4>
                        <p>${i.text}</p>
                    </div>
                </div>
            `).join('');
            
            // Populate tables
            const getRateClass = (rate) => {
                const r = parseFloat(rate);
                return r > 10 ? 'rate-high' : r > 5 ? 'rate-medium' : 'rate-low';
            };
            
            // Worst table - 30 rows
            document.getElementById('worstTable').innerHTML = byRepairRate.slice(0, 30).map(d => `
                <tr onclick="openModal('${d.item}')">
                    <td>${d.model}</td>
                    <td>${d.item}</td>
                    <td>${d.sold.toLocaleString()}</td>
                    <td>${d.total.toLocaleString()}</td>
                    <td class="${getRateClass(d.repairRate)}">${d.repairRate}%</td>
                    <td>$${d.totalCost.toLocaleString()}</td>
                </tr>
            `).join('');
            
            // Best table - 30 rows
            document.getElementById('bestTable').innerHTML = byReliable.slice(0, 30).map(d => `
                <tr onclick="openModal('${d.item}')">
                    <td>${d.model}</td>
                    <td>${d.item}</td>
                    <td>${d.sold.toLocaleString()}</td>
                    <td>${d.total.toLocaleString()}</td>
                    <td class="${getRateClass(d.repairRate)}">${d.repairRate}%</td>
                    <td>$${d.totalCost.toLocaleString()}</td>
                </tr>
            `).join('');
            
            // Cost table - 30 rows
            document.getElementById('costTable').innerHTML = byCost.slice(0, 30).map(d => `
                <tr onclick="openModal('${d.item}')">
                    <td>${d.model}</td>
                    <td>${d.item}</td>
                    <td>${d.total.toLocaleString()}</td>
                    <td>${d.major.toLocaleString()}</td>
                    <td>${d.minor.toLocaleString()}</td>
                    <td>${d.npu.toLocaleString()}</td>
                    <td>$${d.totalCost.toLocaleString()}</td>
                </tr>
            `).join('');
            
            // Accidental table - sorted by accidental count descending, 30 rows
            const byAccidentalCount = [...warrantyData].sort((a, b) => b.accidental - a.accidental);
            document.getElementById('accidentalTable').innerHTML = byAccidentalCount.slice(0, 30).map(d => `
                <tr onclick="openModal('${d.item}')">
                    <td>${d.model}</td>
                    <td>${d.item}</td>
                    <td>${d.total.toLocaleString()}</td>
                    <td>${d.accidental.toLocaleString()}</td>
                    <td>${(d.total - d.accidental).toLocaleString()}</td>
                    <td class="rate-high">${d.accidentalPct}%</td>
                </tr>
            `).join('');
            
            // Warranty table - sorted by inWarranty count descending, 30 rows
            const byInWarrantyCount = [...warrantyData].sort((a, b) => b.inWarranty - a.inWarranty);
            document.getElementById('warrantyTable').innerHTML = byInWarrantyCount.slice(0, 30).map(d => `
                <tr onclick="openModal('${d.item}')">
                    <td>${d.model}</td>
                    <td>${d.item}</td>
                    <td>${d.total.toLocaleString()}</td>
                    <td>${d.inWarranty.toLocaleString()}</td>
                    <td>${d.outWarranty.toLocaleString()}</td>
                    <td>${d.inWarrantyPct}%</td>
                </tr>
            `).join('');
            
            // All models table - initial render
            renderAllModelsTable('total', 'desc');
            
            // Update tab buttons with stats
            updateTabButtons();
        }
        
        function updateTabButtons() {
            const totalSold = warrantyData.reduce((sum, d) => sum + d.sold, 0);
            const totalRepairs = warrantyData.reduce((sum, d) => sum + d.total, 0);
            const totalCost = warrantyData.reduce((sum, d) => sum + d.totalCost, 0);
            const totalAccidental = warrantyData.reduce((sum, d) => sum + d.accidental, 0);
            const totalInWarranty = warrantyData.reduce((sum, d) => sum + d.inWarranty, 0);
            
            const byRepairRate = [...warrantyData].sort((a, b) => parseFloat(b.repairRate) - parseFloat(a.repairRate));
            const byReliable = [...warrantyData].sort((a, b) => parseFloat(a.repairRate) - parseFloat(b.repairRate));
            const byCost = [...warrantyData].sort((a, b) => b.totalCost - a.totalCost);
            
            document.getElementById('tabBtnWorst').innerHTML = `
                <span class="tab-title">‚ö†Ô∏è Highest Repair Rate</span>
                <span class="tab-stats">${byRepairRate[0]?.shortName || 'N/A'}: ${byRepairRate[0]?.repairRate || 0}%</span>
            `;
            
            document.getElementById('tabBtnBest').innerHTML = `
                <span class="tab-title">‚úÖ Most Reliable</span>
                <span class="tab-stats">${byReliable[0]?.shortName || 'N/A'}: ${byReliable[0]?.repairRate || 0}%</span>
            `;
            
            document.getElementById('tabBtnCost').innerHTML = `
                <span class="tab-title">üí∞ Highest Cost</span>
                <span class="tab-stats">$${totalCost.toLocaleString()} total</span>
            `;
            
            document.getElementById('tabBtnAccidental').innerHTML = `
                <span class="tab-title">üí• Accidental Damage</span>
                <span class="tab-stats">${totalAccidental.toLocaleString()} repairs</span>
            `;
            
            document.getElementById('tabBtnWarranty').innerHTML = `
                <span class="tab-title">üìã Warranty Status</span>
                <span class="tab-stats">${totalInWarranty.toLocaleString()} in warranty</span>
            `;
            
            document.getElementById('tabBtnAll').innerHTML = `
                <span class="tab-title">üìÑ All Models</span>
                <span class="tab-stats">${warrantyData.length} models | ${totalRepairs.toLocaleString()} repairs</span>
            `;
        }
        
        // All Models table sorting
        let currentSort = { column: 'total', direction: 'desc' };
        
        function renderAllModelsTable(column, direction) {
            currentSort = { column, direction };
            
            const getRateClass = (rate) => {
                const r = parseFloat(rate);
                return r > 10 ? 'rate-high' : r > 5 ? 'rate-medium' : 'rate-low';
            };
            
            const sorted = [...warrantyData].sort((a, b) => {
                let aVal, bVal;
                switch(column) {
                    case 'model': aVal = a.model; bVal = b.model; break;
                    case 'item': aVal = a.item; bVal = b.item; break;
                    case 'sold': aVal = a.sold; bVal = b.sold; break;
                    case 'total': aVal = a.total; bVal = b.total; break;
                    case 'rate': aVal = parseFloat(a.repairRate); bVal = parseFloat(b.repairRate); break;
                    case 'major': aVal = a.major; bVal = b.major; break;
                    case 'minor': aVal = a.minor; bVal = b.minor; break;
                    case 'npu': aVal = a.npu; bVal = b.npu; break;
                    case 'accidental': aVal = a.accidental; bVal = b.accidental; break;
                    case 'inWarranty': aVal = a.inWarranty; bVal = b.inWarranty; break;
                    default: aVal = a.total; bVal = b.total;
                }
                
                if (typeof aVal === 'string') {
                    return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            document.getElementById('allTable').innerHTML = sorted.map(d => `
                <tr onclick="openModal('${d.item}')">
                    <td>${d.model}</td>
                    <td>${d.item}</td>
                    <td>${d.sold.toLocaleString()}</td>
                    <td>${d.total.toLocaleString()}</td>
                    <td class="${getRateClass(d.repairRate)}">${d.repairRate}%</td>
                    <td>${d.major.toLocaleString()}</td>
                    <td>${d.minor.toLocaleString()}</td>
                    <td>${d.npu.toLocaleString()}</td>
                    <td>${d.accidental.toLocaleString()}</td>
                    <td>${d.inWarranty.toLocaleString()}</td>
                </tr>
            `).join('');
            
            // Update header arrows
            document.querySelectorAll('#allTab th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.column === column) {
                    th.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }
        
        function sortAllModels(column) {
            const newDirection = (currentSort.column === column && currentSort.direction === 'desc') ? 'asc' : 'desc';
            renderAllModelsTable(column, newDirection);
        }
    </script>
</body>
</html>
