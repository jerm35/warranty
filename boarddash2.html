<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CTL Warranty â€” Presentation Charts</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap');
:root{--bg:#f5f7fa;--card:#ffffff;--border:#e2e8f0;--text:#1e293b;--muted:#64748b;--accent:#0ea5e9;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--purple:#8b5cf6;--orange:#f97316;--pink:#ec4899}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.password-overlay{position:fixed;inset:0;z-index:1000;background:#0c1220;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:24px}
.password-overlay.hidden{display:none}
.password-overlay h1{font-size:28px;font-weight:600;color:#22d3ee}
.password-overlay p{color:#8899b0;font-size:14px}
.password-overlay input{background:#111a2e;border:1px solid #1e3050;color:#e8edf5;padding:12px 20px;border-radius:8px;font-size:16px;width:280px;text-align:center;font-family:'Space Mono',monospace}
.password-overlay input:focus{outline:none;border-color:#22d3ee}
.password-overlay button{background:linear-gradient(135deg,#4aa3df,#22d3ee);border:none;color:#fff;padding:10px 32px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600}
.pw-error{color:#ef4444;font-size:13px;min-height:18px}
.loading-overlay{position:fixed;inset:0;z-index:999;background:rgba(245,247,250,.97);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
.loading-overlay.hidden{display:none}
.spinner{width:40px;height:40px;border-radius:50%;border:3px solid var(--border);border-top-color:var(--accent);animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.container{max-width:1200px;margin:0 auto;padding:32px 24px}
.container.hidden{display:none}
.page-header{text-align:center;margin-bottom:40px}
.page-header h1{font-size:28px;font-weight:700;color:var(--text)}
.page-header p{color:var(--muted);font-size:14px;margin-top:6px}
.page-header .date-info{font-family:'Space Mono',monospace;font-size:12px;color:var(--muted);margin-top:12px;padding:6px 16px;background:#eef2f7;border-radius:6px;display:inline-block}
.section-title{font-size:20px;font-weight:700;color:var(--text);margin:48px 0 8px;padding-bottom:8px;border-bottom:2px solid var(--accent)}
.section-subtitle{font-size:13px;color:var(--muted);margin-bottom:24px}
.chart-wrap{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:28px;margin-bottom:28px;position:relative;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.chart-wrap h3{font-size:16px;font-weight:600;margin-bottom:4px;color:var(--text)}
.chart-wrap .subtitle{font-size:12px;color:var(--muted);margin-bottom:20px}
.chart-wrap canvas{max-height:420px;cursor:pointer}
.chart-wrap.tall canvas{max-height:520px}
.chart-wrap::after{content:'Click data for details';position:absolute;bottom:8px;left:14px;font-size:10px;color:var(--muted);font-style:italic;opacity:.5}
.dl-btn{position:absolute;top:16px;right:16px;background:var(--accent);color:#fff;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;font-family:'DM Sans',sans-serif;transition:all .15s;z-index:5}
.dl-btn:hover{filter:brightness(1.1);transform:translateY(-1px)}
.dl-all-btn{display:block;margin:0 auto 40px;background:var(--accent);color:#fff;border:none;padding:12px 32px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;font-family:'DM Sans',sans-serif}
.dl-all-btn:hover{filter:brightness(1.1)}
.chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
@media(max-width:900px){.chart-grid{grid-template-columns:1fr}}
.note-box{background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:14px 18px;font-size:12px;color:#92400e;margin-bottom:20px;line-height:1.6}
.legend-note{font-size:11px;color:var(--muted);margin-top:8px;font-style:italic}
.kpi-strip{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:32px}
.kpi-item{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:18px 16px;text-align:center;border-top:3px solid var(--accent)}
.kpi-item .kpi-label{font-size:11px;font-weight:500;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.kpi-item .kpi-value{font-size:22px;font-weight:700;margin-top:4px;font-family:'Space Mono',monospace}
.kpi-item.green{border-top-color:var(--green)}.kpi-item.red{border-top-color:var(--red)}.kpi-item.yellow{border-top-color:var(--yellow)}.kpi-item.purple{border-top-color:var(--purple)}.kpi-item.orange{border-top-color:var(--orange)}
.trend-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;font-family:'Space Mono',monospace}
.trend-up{background:rgba(16,185,129,.12);color:var(--green)}
.trend-down{background:rgba(239,68,68,.12);color:var(--red)}
.trend-flat{background:rgba(245,158,11,.12);color:var(--yellow)}
.chart-controls{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.chart-controls .ctrl-btn{padding:6px 14px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--muted);cursor:pointer;font-size:11px;font-weight:600;font-family:'DM Sans',sans-serif;transition:all .15s}
.chart-controls .ctrl-btn:hover{border-color:var(--accent);color:var(--accent);background:#f0f9ff}
.chart-controls .ctrl-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.chart-controls .ctrl-label{font-size:11px;color:var(--muted);font-weight:500;margin-right:4px}
.chart-controls .nav-btn{min-width:120px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
/* Modal */
.modal-overlay{position:fixed;inset:0;z-index:900;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.modal-overlay.active{opacity:1;pointer-events:all}
.modal{background:#fff;border:1px solid var(--border);border-radius:12px;max-width:960px;width:95%;max-height:82vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.25)}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:18px 24px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff;z-index:2;border-radius:12px 12px 0 0}
.modal-header h3{font-size:17px;font-weight:700;color:var(--text)}
.modal-close{background:none;border:1px solid var(--border);color:var(--muted);width:32px;height:32px;border-radius:6px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}
.modal-close:hover{background:#f1f5f9;color:var(--text)}
.modal-body{padding:20px 24px 28px}
.modal-body .detail-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:24px}
.modal-body .detail-stat{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px 14px;text-align:center}
.modal-body .detail-stat .label{font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.modal-body .detail-stat .value{font-size:18px;font-weight:700;margin-top:3px;font-family:'Space Mono',monospace;color:var(--text)}
.modal-body .section-label{font-size:12px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.5px;margin:20px 0 10px;padding-bottom:6px;border-bottom:1px solid #e2e8f0}
.modal-body table{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:16px}
.modal-body th{text-align:left;padding:8px 12px;font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid #e2e8f0;background:#f8fafc}
.modal-body td{padding:8px 12px;border-bottom:1px solid #f1f5f9;color:#475569}
.modal-body td.mono{font-family:'Space Mono',monospace;font-size:11px}
.modal-body td.positive{color:var(--green)}.modal-body td.negative{color:var(--red)}
.modal-body tr:hover td{background:#f8fafc}
.modal-body .assumption-note{background:#f0f9ff;border:1px solid #bae6fd;border-radius:6px;padding:12px 16px;font-size:11px;color:#0c4a6e;margin-top:20px;line-height:1.7}
.modal-body .assumption-note strong{color:#0369a1}
/* Assumptions section */
.assumptions{background:var(--card);border:1px solid var(--border);border-radius:12px;margin-top:48px;overflow:hidden}
.assumptions-toggle{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;cursor:pointer;user-select:none;transition:background .15s}
.assumptions-toggle:hover{background:#f8fafc}
.assumptions-toggle h3{font-size:15px;font-weight:700;color:var(--text)}
.assumptions-toggle .arrow{font-size:18px;color:var(--muted);transition:transform .2s}
.assumptions.open .arrow{transform:rotate(180deg)}
.assumptions-body{display:none;padding:0 24px 24px;font-size:13px;color:#475569;line-height:1.7}
.assumptions.open .assumptions-body{display:block}
.assumptions-body h4{font-size:13px;font-weight:700;color:var(--text);margin:20px 0 8px}
.assumptions-body ul{margin:0 0 8px 20px}
.assumptions-body li{margin-bottom:4px}
.assumptions-body .group-table{width:100%;border-collapse:collapse;font-size:12px;margin:12px 0 16px}
.assumptions-body .group-table th{text-align:left;padding:8px 12px;font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;background:#f8fafc;border-bottom:1px solid #e2e8f0}
.assumptions-body .group-table td{padding:6px 12px;border-bottom:1px solid #f1f5f9;color:#475569;font-size:11px}
.assumptions-body .group-table td:first-child{font-weight:600;color:var(--text);white-space:nowrap}
.assumptions-body .group-table td.mono{font-family:'Space Mono',monospace;font-size:10px;color:var(--muted)}
.footer{text-align:center;color:var(--muted);font-size:12px;padding:40px 0 24px;border-top:1px solid var(--border);margin-top:48px}
</style>
</head>
<body>

<div class="password-overlay" id="pwOverlay">
  <h1>CTL Warranty â€” Slide Graphics</h1>
  <p>Enter password to access data</p>
  <input type="password" id="pwInput" placeholder="Password" onkeydown="if(event.key==='Enter')checkPw()">
  <div class="pw-error" id="pwError"></div>
  <button onclick="checkPw()">Access</button>
</div>

<div class="loading-overlay hidden" id="loadingOverlay">
  <div class="spinner"></div>
  <p id="loadingMsg">Loading dataâ€¦</p>
</div>

<div class="container hidden" id="app">
  <div class="page-header">
    <h1>CTL Warranty Analysis â€” Presentation Charts</h1>
    <p>Device group analytics with downloadable slide-ready graphics</p>
    <div class="date-info" id="dateLabel"></div>
  </div>

  <button class="dl-all-btn" id="dlAllBtn" onclick="downloadAll()">â¬‡ Download All Charts as ZIP</button>

  <div id="kpiArea"></div>

  <!-- Chart 1: Warranties Sold by Group & Year -->
  <div class="section-title">Warranties Sold & Revenue</div>
  <div class="section-subtitle">Full sales history across all device groups (2018â€“2030)</div>
  <div class="chart-grid">
    <div class="chart-wrap" id="wrap_sold">
      <button class="dl-btn" onclick="dlChart('chSold','Warranty_Units_Sold')">â¬‡ PNG</button>
      <h3>Warranty Units Sold by Device Group</h3>
      <div class="subtitle">Total units sold per group â€” all years combined</div>
      <canvas id="chSold"></canvas>
    </div>
    <div class="chart-wrap" id="wrap_rev">
      <button class="dl-btn" onclick="dlChart('chRev','Warranty_Revenue')">â¬‡ PNG</button>
      <h3>Warranty Revenue by Device Group</h3>
      <div class="subtitle">Total warranty revenue per group â€” all years combined</div>
      <canvas id="chRev"></canvas>
    </div>
  </div>

  <!-- Chart 1b: Sold & Revenue by Year (stacked) -->
  <div class="chart-grid">
    <div class="chart-wrap" id="wrap_soldYr">
      <button class="dl-btn" onclick="dlChart('chSoldYr','Units_Sold_By_Year')">â¬‡ PNG</button>
      <h3>Warranty Units Sold by Year</h3>
      <div class="subtitle">Year-over-year warranty unit sales per device group</div>
      <canvas id="chSoldYr"></canvas>
    </div>
    <div class="chart-wrap" id="wrap_revYr">
      <button class="dl-btn" onclick="dlChart('chRevYr','Revenue_By_Year')">â¬‡ PNG</button>
      <h3>Warranty Revenue by Year</h3>
      <div class="subtitle">Year-over-year revenue per device group</div>
      <canvas id="chRevYr"></canvas>
    </div>
  </div>

  <!-- Chart 2: Frequency & Severity -->
  <div class="section-title">Claim Frequency & Severity</div>
  <div class="section-subtitle">Repair claims analysis across device groups (filtered date range)</div>
  <div class="chart-grid">
    <div class="chart-wrap" id="wrap_freq">
      <button class="dl-btn" onclick="dlChart('chFreq','Claim_Frequency')">â¬‡ PNG</button>
      <h3>Claim Frequency by Device Group</h3>
      <div class="subtitle">Total warranty claims per group with repair rate overlay</div>
      <canvas id="chFreq"></canvas>
    </div>
    <div class="chart-wrap" id="wrap_sev">
      <button class="dl-btn" onclick="dlChart('chSev','Claim_Severity')">â¬‡ PNG</button>
      <h3>Claim Severity Breakdown</h3>
      <div class="subtitle">Major / Minor / NPU / NPF across all groups</div>
      <canvas id="chSev"></canvas>
    </div>
  </div>
  <div class="chart-wrap" id="wrap_sevGrp">
    <button class="dl-btn" onclick="dlChart('chSevGrp','Severity_By_Group')">â¬‡ PNG</button>
    <h3>Claim Severity by Device Group</h3>
    <div class="subtitle">Stacked breakdown: Major, Minor, NPU, NPF per group</div>
    <canvas id="chSevGrp"></canvas>
  </div>
  <div class="chart-wrap" id="wrap_sevPct">
    <button class="dl-btn" onclick="dlChart('chSevPct','Severity_By_Group_Pct')">â¬‡ PNG</button>
    <h3>Claim Severity by Device Group (% of Sold)</h3>
    <div class="subtitle">Each severity category as a percentage of units sold per group</div>
    <canvas id="chSevPct"></canvas>
  </div>

  <!-- Chart 3: Breakage Rate Trends -->
  <div class="section-title">Breakage Rate Trends â€” 3 Year</div>
  <div class="section-subtitle">Quarterly repair trends per device group (colorful multi-line)</div>
  <div class="chart-wrap tall" id="wrap_trend">
    <button class="dl-btn" onclick="dlChart('chTrend','Breakage_Rate_Trends')">â¬‡ PNG</button>
    <h3>Quarterly Repairs by Device Group</h3>
    <div class="subtitle">Repair count per quarter â€” each line is a device group</div>
    <div class="chart-controls" id="trendCtrls">
      <span class="ctrl-label">Show:</span>
      <button class="ctrl-btn" onclick="trendAllOn()">All On</button>
      <button class="ctrl-btn" onclick="trendAllOff()">All Off</button>
      <span class="ctrl-label" style="margin-left:12px">Cycle:</span>
      <button class="ctrl-btn nav-btn" onclick="trendPrev()" id="trendPrevBtn">â—‚ Prev</button>
      <button class="ctrl-btn nav-btn" onclick="trendNext()" id="trendNextBtn">Next â–¸</button>
    </div>
    <canvas id="chTrend"></canvas>
  </div>
  <div class="chart-wrap tall" id="wrap_trendPct">
    <button class="dl-btn" onclick="dlChart('chTrendPct','Breakage_Rate_Pct_Trends')">â¬‡ PNG</button>
    <h3>Quarterly Repair Rate (% of Sold) by Device Group</h3>
    <div class="subtitle">Repairs as percentage of units sold â€” normalized comparison</div>
    <div class="chart-controls" id="trendPctCtrls">
      <span class="ctrl-label">Show:</span>
      <button class="ctrl-btn" onclick="pctAllOn()">All On</button>
      <button class="ctrl-btn" onclick="pctAllOff()">All Off</button>
      <span class="ctrl-label" style="margin-left:12px">Cycle:</span>
      <button class="ctrl-btn nav-btn" onclick="pctPrev()" id="pctPrevBtn">â—‚ Prev</button>
      <button class="ctrl-btn nav-btn" onclick="pctNext()" id="pctNextBtn">Next â–¸</button>
    </div>
    <canvas id="chTrendPct"></canvas>
  </div>

  <!-- Chart 4: Cost Distribution -->
  <div class="section-title">Warranty Cost Distribution</div>
  <div class="section-subtitle">Average repair cost per device group vs. average warranty revenue</div>
  <div class="chart-wrap" id="wrap_dist">
    <button class="dl-btn" onclick="dlChart('chDist','Cost_Distribution')">â¬‡ PNG</button>
    <h3>Avg Repair Cost vs. Avg Warranty Revenue per Unit</h3>
    <div class="subtitle">Bar = avg repair cost per group Â· Dashed line = avg warranty revenue per unit sold (break-even)</div>
    <canvas id="chDist"></canvas>
  </div>

  <!-- Chart 5 & 6: Parts & Labor Trends -->
  <div class="section-title">Parts & Labor Cost Trends</div>
  <div class="section-subtitle">Quarterly cost trends â€” actual labor codes where available, assumed rates otherwise</div>
  <div class="note-box">
    <strong>Methodology:</strong> Labor costs use actual labor charges (LABOR15/30/60 codes) when available. If no labor code is present, assumed rates apply: Major = $30, Minor = $15, NPU/NPF/OS = $7.50. Parts cost = Total repair cost âˆ’ labor cost (min $0).
  </div>
  <div class="chart-grid">
    <div class="chart-wrap" id="wrap_parts">
      <button class="dl-btn" onclick="dlChart('chParts','Parts_Cost_Trend')">â¬‡ PNG</button>
      <h3>Parts Cost by Quarter</h3>
      <div class="subtitle">Total parts cost (area) + avg per repair (dashed)</div>
      <canvas id="chParts"></canvas>
    </div>
    <div class="chart-wrap" id="wrap_labor">
      <button class="dl-btn" onclick="dlChart('chLabor','Labor_Cost_Trend')">â¬‡ PNG</button>
      <h3>Labor Cost by Quarter</h3>
      <div class="subtitle">Total labor cost (area) + avg per repair (dashed)</div>
      <canvas id="chLabor"></canvas>
    </div>
  </div>
  <div class="chart-grid">
    <div class="chart-wrap" id="wrap_partsGrp">
      <button class="dl-btn" onclick="dlChart('chPartsGrp','Parts_Cost_By_Group')">â¬‡ PNG</button>
      <h3>Total Parts Cost by Device Group</h3>
      <div class="subtitle">Cumulative parts cost per group</div>
      <canvas id="chPartsGrp"></canvas>
    </div>
    <div class="chart-wrap" id="wrap_laborGrp">
      <button class="dl-btn" onclick="dlChart('chLaborGrp','Labor_Cost_By_Group')">â¬‡ PNG</button>
      <h3>Total Labor Cost by Device Group</h3>
      <div class="subtitle">Cumulative labor cost per group</div>
      <canvas id="chLaborGrp"></canvas>
    </div>
  </div>

  <!-- Assumptions Section -->
  <div class="assumptions" id="assumSection">
    <div class="assumptions-toggle" onclick="document.getElementById('assumSection').classList.toggle('open')">
      <h3>ðŸ“‹ Data Assumptions & Methodology</h3>
      <span class="arrow">â–¼</span>
    </div>
    <div class="assumptions-body">
      <h4>Device Groups</h4>
      <p>Devices are grouped by product family for aggregate analysis. Each group combines related SKUs/configurations:</p>
      <table class="group-table" id="groupTable"></table>

      <h4>Data Sources</h4>
      <ul>
        <li><strong>Repair Data:</strong> Google Sheets CSV (NetSuite export). One row per repair order. Filtered by <code>Order Received Date</code> within 2023-01-01 to 2025-12-31.</li>
        <li><strong>Sales Data:</strong> Google Sheets CSV. Not date-filtered â€” full history (2018â€“2030) used for accurate repair rate denominators.</li>
        <li><strong>Costs Data:</strong> Google Sheets CSV. Per-order product/labor codes used for parts vs. labor cost split.</li>
      </ul>

      <h4>Key Calculations</h4>
      <ul>
        <li><strong>Units Sold:</strong> Sum of <code>Total Sales Qty</code> across all warranty codes per item, all valid years (2018â€“2030).</li>
        <li><strong>Repair Rate:</strong> <code>Total Repairs Ã· Units Sold Ã— 100</code>. Full sales history used as denominator for accurate rates.</li>
        <li><strong>Repair Cost:</strong> <code>Costs</code> column value + $10 flat shipping per repair.</li>
        <li><strong>Warranty Revenue:</strong> <code>Total Sales</code> from sales CSV, summed across all warranty codes per item.</li>
        <li><strong>Net P/L:</strong> <code>Warranty Revenue + Repair Revenue (OOW) âˆ’ Total Repair Cost</code>.</li>
      </ul>

      <h4>Severity Classification</h4>
      <ul>
        <li><strong>NPU</strong> â€” Repair field matches "NPU" exactly</li>
        <li><strong>NPF</strong> â€” Repair field matches "NPF" exactly</li>
        <li><strong>Major</strong> â€” Major Repairs column = "Yes" (and not NPU/NPF)</li>
        <li><strong>Minor</strong> â€” Everything else</li>
        <li>Priority: NPU â†’ NPF â†’ Major â†’ Minor (each repair classified into exactly one category)</li>
      </ul>

      <h4>Parts vs. Labor Cost Split</h4>
      <ul>
        <li>The <strong>Costs CSV</strong> provides per-order Product codes which may include explicit labor codes.</li>
        <li><strong>If LABOR15, LABOR30, or LABOR60</strong> code found: labor = $7.50, $15, or $30 respectively (actual data).</li>
        <li><strong>If no LABOR code</strong> present: assumed rates â€” Major = $30, Minor = $15, NPU/NPF/OS = $7.50.</li>
        <li><strong>Parts cost</strong> = Total repair cost âˆ’ labor cost (minimum $0).</li>
        <li>Every repair contributes to both parts and labor totals.</li>
      </ul>

      <h4>Cost Distribution Chart</h4>
      <ul>
        <li>Bars show average repair cost per device group (total cost Ã· total repairs).</li>
        <li>Dashed green line shows average warranty revenue per unit sold across all groups (break-even reference).</li>
        <li>Groups above the line cost more to repair on average than the warranty revenue generated per unit.</li>
      </ul>

      <h4>Caveats</h4>
      <ul>
        <li>Models with "No Match" in Model Name or Item Number are excluded.</li>
        <li>Rows missing Order Received Date are excluded from repair data.</li>
        <li>$10/repair shipping cost is a flat estimate added to every repair.</li>
        <li>Accidental Damage includes both "Yes" and "Liquid" values.</li>
        <li>Year filtering restricts to 2018â€“2030 to exclude erroneous dates.</li>
      </ul>
    </div>
  </div>

  <div class="footer">CTL Warranty Board Report â€” Presentation Charts Â· Live from Google Sheets<br><span style="font-size:11px">Sales: full history (2018â€“2030) Â· Repairs: 2023-01-01 â€” 2025-12-31</span></div>
</div>

<!-- Detail Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalTitle"></h3>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
const PW='CTLdata2026',SHIP=10,MIN_YR=2018,MAX_YR=2030;
const RU='https://docs.google.com/spreadsheets/d/e/2PACX-1vS9yLbvcLU16R73aNEIqwAVzJwz82UghVY5buEK5uuX9LHojAE9JoQoJ00-uuR2KzXTL-e6AwepOlFq/pub?gid=986703446&single=true&output=csv';
const SU='https://docs.google.com/spreadsheets/d/e/2PACX-1vS9yLbvcLU16R73aNEIqwAVzJwz82UghVY5buEK5uuX9LHojAE9JoQoJ00-uuR2KzXTL-e6AwepOlFq/pub?gid=235319241&single=true&output=csv';
const CU='https://docs.google.com/spreadsheets/d/e/2PACX-1vS9yLbvcLU16R73aNEIqwAVzJwz82UghVY5buEK5uuX9LHojAE9JoQoJ00-uuR2KzXTL-e6AwepOlFq/pub?gid=151668355&single=true&output=csv';

// ===== DEVICE GROUPS =====
const GROUPS = {
  'NL72': ['CBUS1100015','CBUS1100016'],
  'NL72T': ['CBUS1100011','CBUS1100017','CBUS1100023'],
  'NL72-L / CT-L': ['CBUS1100013','CBUS1100019','CBUS1100020','CBUS1100021'],
  'NL73': ['CBUS1100024','CBUS1100026','CBUS1100028'],
  'NL73T': ['CBUS1100025','CBUS1100027','CBUS1100030'],
  'PX111E': ['CBUS1100033','CBUS1100034'],
  'PX14E': ['CBUS1400003','CBUS1400004','CBUS1400005','CBUS1400006','CBUS1400007','CBUS1400008','CBUS1400009','CBUS1400010'],
  'PX141E': ['CBUS1400011','CBUS1400012','CBUS1400013','CBUS1400015','ZPX141GXT'],
  'Chromebox': ['CBXEU190010','CBXEU190011','CBXUS190003','CBXUS190004','CBXUS190010','CBXUS190011','CBXUS190022'],
  'NL73TW Gen2': ['CBUS1100035'],
  'NL73 Gen2': ['CBUS1100037'],
  'PX121E': ['CBUS1200001'],
  'Meet Systems': ['CBXUS190005','CBXUS190020']
};
const GROUP_NAMES = Object.keys(GROUPS);
const ALL_ITEMS = new Set(Object.values(GROUPS).flat());

// Color palette â€” distinct and presentation-friendly
const GC = ['#0ea5e9','#8b5cf6','#f59e0b','#ef4444','#10b981','#ec4899','#f97316','#6366f1','#14b8a6','#e11d48','#84cc16','#0891b2','#d946ef'];

let rawR=null,rawS=null,rawC=null,costsLU={},charts=[];
let chTrendRef=null, chTrendPctRef=null, trendCycleIdx=-1, pctCycleIdx=-1;
let gData={}, sL_global={};
const fmt=n=>n==null?'N/A':n.toLocaleString('en-US');
const fD=n=>n==null?'N/A':'$'+Math.round(n).toLocaleString('en-US');
const fP=n=>n==null?'N/A':n.toFixed(2)+'%';
function vY(y){const n=parseInt(y);return!isNaN(n)&&n>=MIN_YR&&n<=MAX_YR;}
function pD(s){if(!s)return null;const d=new Date(s);return isNaN(d)?null:new Date(d.getFullYear(),d.getMonth(),d.getDate());}
function qL(d){return`${d.getFullYear()} Q${Math.floor(d.getMonth()/3)+1}`;}
function itemToGroup(itemN){for(const[g,items]of Object.entries(GROUPS)){if(items.includes(itemN))return g;}return null;}
function trd(vals){const f=vals.filter(x=>x!=null&&x!==0);if(f.length<2)return{t:'â€”',c:'flat'};const a=f[0],b=f[f.length-1];if(!a)return{t:'â†‘',c:'up'};const p=((b-a)/Math.abs(a))*100;if(p>10)return{t:`â†‘ +${p.toFixed(0)}%`,c:'up'};if(p<-10)return{t:`â†“ ${p.toFixed(0)}%`,c:'down'};return{t:'â†’ Flat',c:'flat'};}

function checkPw(){
  if(document.getElementById('pwInput').value===PW){
    document.getElementById('pwOverlay').classList.add('hidden');
    document.getElementById('loadingOverlay').classList.remove('hidden');
    fetchAll();
  } else document.getElementById('pwError').textContent='Incorrect password';
}

function fetchAll(){
  document.getElementById('loadingMsg').textContent='Fetching repair dataâ€¦';
  let rd=false,sd=false,cd=false;
  function tryGo(){if(rd&&sd&&cd)processAndRender();}
  Papa.parse(RU,{download:true,header:true,skipEmptyLines:true,complete:r=>{rawR=r.data;rd=true;document.getElementById('loadingMsg').textContent='Fetching salesâ€¦';tryGo();}});
  Papa.parse(SU,{download:true,header:true,skipEmptyLines:true,complete:r=>{rawS=r.data;sd=true;document.getElementById('loadingMsg').textContent='Fetching costsâ€¦';tryGo();}});
  Papa.parse(CU,{download:true,header:true,skipEmptyLines:true,complete:r=>{rawC=r.data;cd=true;buildCostsLU();tryGo();}});
}
function buildCostsLU(){
  costsLU={};if(!rawC)return;
  rawC.forEach(r=>{
    const oid=(r['Order Id']||'').trim(),prod=(r['Product']||'').trim().toUpperCase();
    if(oid)costsLU[oid]={product:prod,isLabor:/^LABOR\d+/.test(prod),laborRate:prod==='LABOR15'?7.5:prod==='LABOR30'?15:prod==='LABOR60'?30:0};
  });
}

function processAndRender(){
  document.getElementById('loadingMsg').textContent='Processingâ€¦';
  const startDate=new Date(2023,0,1), endDate=new Date(2025,11,31,23,59,59);

  // Build sales lookup (full history, no date filter)
  const sL={};
  rawS.forEach(r=>{
    const it=(r['Item No']||'').trim(),co=(r['Warranty Code']||'').trim(),yr=(r['Year']||'').trim();
    if(!it||!co||(!vY(yr)&&yr))return;
    if(!ALL_ITEMS.has(it))return;
    const qt=parseFloat(r['Total Sales Qty'])||0,pr=parseFloat((r['Price']||'').replace(/[$,]/g,''))||0;
    let rv=parseFloat((r['Total Sales']||'').replace(/[$,]/g,''))||0;if(!rv&&qt&&pr)rv=qt*pr;
    if(!sL[it])sL[it]={_byYr:{},_total:0,_totalRev:0};
    sL[it]._total+=qt;sL[it]._totalRev+=rv;
    if(yr&&vY(yr)){sL[it]._byYr[yr]=sL[it]._byYr[yr]||{qty:0,rev:0};sL[it]._byYr[yr].qty+=qt;sL[it]._byYr[yr].rev+=rv;}
  });

  // Filter repairs to date range & our items
  const filt=rawR.filter(r=>{
    const it=(r['Item Number']||'').trim(),m=(r['Model Name']||'').trim(),ds=(r['Order Received Date']||'').trim();
    if(!ds||!m||m==='No Match'||!it||!ALL_ITEMS.has(it))return false;
    const d=pD(ds);return d&&d>=startDate&&d<=endDate;
  });

  // Build group-level aggregates
  const _gData={};
  GROUP_NAMES.forEach(g=>{_gData[g]={sold:0,rev:0,repairs:0,cost:0,major:0,minor:0,npu:0,npf:0,accidental:0,inW:0,outW:0,repairRev:0,
    quarterlyData:{},yearlyRepairs:{},yearlySold:{},yearlyRev:{},
    partsCost:0,laborCost:0,quarterlyParts:{},quarterlyLabor:{},
    repairTypes:{},itemData:{},labActual:0,labAssumed:0};});

  // Add sales data per group (also track per-item)
  for(const[g,items]of Object.entries(GROUPS)){
    items.forEach(it=>{
      const s=sL[it];if(!s)return;
      if(!_gData[g].itemData[it])_gData[g].itemData[it]={name:'',sold:0,rev:0,repairs:0,cost:0,major:0,minor:0,npu:0,npf:0};
      _gData[g].itemData[it].sold+=s._total;_gData[g].itemData[it].rev+=s._totalRev;
      _gData[g].sold+=s._total;_gData[g].rev+=s._totalRev;
      Object.entries(s._byYr).forEach(([yr,d])=>{
        if(!_gData[g].yearlySold[yr])_gData[g].yearlySold[yr]=0;
        if(!_gData[g].yearlyRev[yr])_gData[g].yearlyRev[yr]=0;
        _gData[g].yearlySold[yr]+=d.qty;_gData[g].yearlyRev[yr]+=d.rev;
      });
    });
  }

  // Process repairs
  filt.forEach(r=>{
    const it=(r['Item Number']||'').trim(),g=itemToGroup(it);if(!g)return;
    const mn=(r['Model Name']||'').trim();
    const rep=(r['Repair']||'').trim(),isMaj=(r['Major Repairs']||'').trim().toLowerCase()==='yes';
    const isNPU=/^npu$/i.test(rep),isNPF=/^npf$/i.test(rep),isNPX=isNPU||isNPF;
    const isAcc=['yes','liquid'].includes((r['Accidental Damage']||'').trim().toLowerCase());
    const cost=(parseFloat(r['Costs'])||0)+SHIP,rRev=parseFloat(r['Repair Revenue'])||0;
    const ws=(r['Warranty Status']||'').trim();
    const d=pD(r['Order Received Date']),yr=d?d.getFullYear().toString():'?',qt=d?qL(d):'?';

    const gd=_gData[g];gd.repairs++;gd.cost+=cost;gd.repairRev+=rRev;
    if(isNPU)gd.npu++;else if(isNPF)gd.npf++;else if(isMaj)gd.major++;else gd.minor++;
    if(isAcc)gd.accidental++;
    if(ws==='In Warranty')gd.inW++;else if(ws==='Out of Warranty')gd.outW++;

    // Repair type tracking
    if(rep){gd.repairTypes[rep]=(gd.repairTypes[rep]||0)+1;}

    // Per-item tracking
    if(!gd.itemData[it])gd.itemData[it]={name:mn,sold:0,rev:0,repairs:0,cost:0,major:0,minor:0,npu:0,npf:0};
    const id=gd.itemData[it];id.name=mn;id.repairs++;id.cost+=cost;
    if(isNPU)id.npu++;else if(isNPF)id.npf++;else if(isMaj)id.major++;else id.minor++;

    // Yearly
    if(vY(yr)){
      if(!gd.yearlyRepairs[yr])gd.yearlyRepairs[yr]={rep:0,cost:0,maj:0,min:0,npu:0,npf:0};
      const yd=gd.yearlyRepairs[yr];yd.rep++;yd.cost+=cost;
      if(isNPU)yd.npu++;else if(isNPF)yd.npf++;else if(isMaj)yd.maj++;else yd.min++;
    }

    // Quarterly
    if(qt!=='?'){
      if(!gd.quarterlyData[qt])gd.quarterlyData[qt]={rep:0,cost:0,pC:0,lC:0};
      const qd=gd.quarterlyData[qt];qd.rep++;qd.cost+=cost;
      // Labor split
      const oid=(r['Order Id']||'').trim(),cEntry=costsLU[oid];
      let labC;
      if(cEntry&&cEntry.isLabor){labC=cEntry.laborRate;gd.labActual++;}
      else{const isOS=/os issue/i.test(rep);labC=isNPX||isOS?7.5:isMaj?30:15;gd.labAssumed++;}
      qd.lC+=labC;qd.pC+=Math.max(0,cost-labC);
      gd.partsCost+=Math.max(0,cost-labC);gd.laborCost+=labC;
    }
  });

  // Assign to global
  gData=_gData;
  sL_global=sL;

  // Build all quarter labels (2023-2025)
  const allQ=new Set();
  for(let yr=2023;yr<=2025;yr++)for(let q=1;q<=4;q++)allQ.add(`${yr} Q${q}`);
  const sQA=[...allQ].sort();

  // Build all year labels from sales
  const allYrs=new Set();
  GROUP_NAMES.forEach(g=>{Object.keys(gData[g].yearlySold).forEach(y=>allYrs.add(y));Object.keys(gData[g].yearlyRev).forEach(y=>allYrs.add(y));});
  const salesYrs=[...allYrs].filter(vY).sort();

  // ======== RENDER ========
  document.getElementById('dateLabel').textContent=`Repairs: 2023-01-01 â€” 2025-12-31 | Sales: All (${MIN_YR}â€“${MAX_YR})`;

  // KPIs
  let tSold=0,tRep=0,tCost=0,tRev=0,tRepRev=0;
  GROUP_NAMES.forEach(g=>{tSold+=gData[g].sold;tRep+=gData[g].repairs;tCost+=gData[g].cost;tRev+=gData[g].rev;tRepRev+=gData[g].repairRev;});
  const nPL=tRev+tRepRev-tCost;
  document.getElementById('kpiArea').innerHTML=`<div class="kpi-strip">
    <div class="kpi-item"><div class="kpi-label">Units Sold</div><div class="kpi-value">${fmt(tSold)}</div></div>
    <div class="kpi-item yellow"><div class="kpi-label">Total Repairs</div><div class="kpi-value">${fmt(tRep)}</div></div>
    <div class="kpi-item red"><div class="kpi-label">Repair Rate</div><div class="kpi-value">${tSold>0?fP(tRep/tSold*100):'N/A'}</div></div>
    <div class="kpi-item orange"><div class="kpi-label">Repair Cost</div><div class="kpi-value">${fD(tCost)}</div></div>
    <div class="kpi-item purple"><div class="kpi-label">Warranty Revenue</div><div class="kpi-value">${fD(tRev)}</div></div>
    <div class="kpi-item ${nPL>=0?'green':'red'}"><div class="kpi-label">Net P/L</div><div class="kpi-value" style="color:${nPL>=0?'var(--green)':'var(--red)'}">${fD(nPL)}</div></div>
  </div>`;

  // Destroy old charts
  charts.forEach(c=>{try{c.destroy();}catch(e){}});charts=[];

  const chartOpts=(extra={})=>({responsive:true,animation:{duration:600},plugins:{legend:{labels:{color:'#64748b',font:{family:'DM Sans',size:11},padding:14,usePointStyle:true},...(extra.legendOpts||{})},...(extra.pluginOpts||{})},scales:{...(extra.scales||{})}});

  // ===== CHART 1: Units Sold by Group =====
  charts.push(new Chart(document.getElementById('chSold'),{type:'bar',data:{labels:GROUP_NAMES,datasets:[{label:'Units Sold',data:GROUP_NAMES.map(g=>gData[g].sold),backgroundColor:GC.slice(0,GROUP_NAMES.length),borderRadius:6,barPercentage:.7}]},options:{...chartOpts({scales:{y:{ticks:{color:'#64748b',callback:v=>fmt(v)},grid:{color:'#e2e8f0'}},x:{ticks:{color:'#64748b',font:{size:10},maxRotation:45},grid:{display:false}}}}),plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmt(c.raw)+' units'}}}}}));

  // ===== CHART 2: Revenue by Group =====
  charts.push(new Chart(document.getElementById('chRev'),{type:'bar',data:{labels:GROUP_NAMES,datasets:[{label:'Revenue',data:GROUP_NAMES.map(g=>gData[g].rev),backgroundColor:GC.slice(0,GROUP_NAMES.length),borderRadius:6,barPercentage:.7}]},options:{...chartOpts({scales:{y:{ticks:{color:'#64748b',callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'#e2e8f0'}},x:{ticks:{color:'#64748b',font:{size:10},maxRotation:45},grid:{display:false}}}}),plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fD(c.raw)}}}}}));

  // ===== CHART 1b: Units Sold by Year (stacked) =====
  const soldYrDS=GROUP_NAMES.map((g,i)=>({label:g,data:salesYrs.map(yr=>gData[g].yearlySold[yr]||0),backgroundColor:GC[i%GC.length],borderRadius:3,barPercentage:.75}));
  charts.push(new Chart(document.getElementById('chSoldYr'),{type:'bar',data:{labels:salesYrs,datasets:soldYrDS},options:{...chartOpts({scales:{y:{stacked:true,ticks:{color:'#64748b',callback:v=>fmt(v)},grid:{color:'#e2e8f0'}},x:{stacked:true,ticks:{color:'#64748b'},grid:{display:false}}}}),plugins:{legend:{position:'bottom',labels:{color:'#64748b',font:{size:10},usePointStyle:true,padding:10}},tooltip:{mode:'index'}}}}));

  // Revenue by Year (stacked)
  const revYrDS=GROUP_NAMES.map((g,i)=>({label:g,data:salesYrs.map(yr=>gData[g].yearlyRev[yr]||0),backgroundColor:GC[i%GC.length],borderRadius:3,barPercentage:.75}));
  charts.push(new Chart(document.getElementById('chRevYr'),{type:'bar',data:{labels:salesYrs,datasets:revYrDS},options:{...chartOpts({scales:{y:{stacked:true,ticks:{color:'#64748b',callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'#e2e8f0'}},x:{stacked:true,ticks:{color:'#64748b'},grid:{display:false}}}}),plugins:{legend:{position:'bottom',labels:{color:'#64748b',font:{size:10},usePointStyle:true,padding:10}},tooltip:{mode:'index',callbacks:{label:c=>c.dataset.label+': '+fD(c.raw)}}}}}));

  // ===== CHART 3: Claim Frequency + Repair Rate =====
  charts.push(new Chart(document.getElementById('chFreq'),{type:'bar',data:{labels:GROUP_NAMES,datasets:[{label:'Repairs',data:GROUP_NAMES.map(g=>gData[g].repairs),backgroundColor:GC.map(c=>c+'cc'),borderColor:GC,borderWidth:1,borderRadius:6,barPercentage:.65,yAxisID:'y'},{label:'Repair Rate %',data:GROUP_NAMES.map(g=>gData[g].sold>0?(gData[g].repairs/gData[g].sold*100):0),type:'line',borderColor:'#ef4444',backgroundColor:'transparent',borderWidth:2.5,pointRadius:5,pointBackgroundColor:'#ef4444',tension:.3,yAxisID:'y1'}]},options:{...chartOpts({scales:{y:{title:{display:true,text:'Repairs',color:'#64748b'},ticks:{color:'#64748b'},grid:{color:'#e2e8f0'}},y1:{position:'right',title:{display:true,text:'Repair Rate %',color:'#ef4444'},ticks:{color:'#ef4444',callback:v=>v.toFixed(1)+'%'},grid:{display:false}},x:{ticks:{color:'#64748b',font:{size:10},maxRotation:45},grid:{display:false}}}}),plugins:{legend:{position:'bottom'},tooltip:{callbacks:{label:c=>c.datasetIndex===0?fmt(c.raw)+' repairs':c.raw.toFixed(2)+'%'}}}}}));

  // ===== CHART 4: Severity Doughnut =====
  let tMaj=0,tMin=0,tNPU=0,tNPF=0;
  GROUP_NAMES.forEach(g=>{tMaj+=gData[g].major;tMin+=gData[g].minor;tNPU+=gData[g].npu;tNPF+=gData[g].npf;});
  charts.push(new Chart(document.getElementById('chSev'),{type:'doughnut',data:{labels:['Major','Minor','NPU','NPF'],datasets:[{data:[tMaj,tMin,tNPU,tNPF],backgroundColor:['#ef4444','#f59e0b','#0ea5e9','#8b5cf6'],borderWidth:2,borderColor:'#ffffff'}]},options:{responsive:true,cutout:'52%',plugins:{legend:{position:'bottom',labels:{color:'#64748b',padding:16,font:{size:12}}},tooltip:{callbacks:{label:c=>{const total=tMaj+tMin+tNPU+tNPF;return c.label+': '+fmt(c.raw)+' ('+((c.raw/total)*100).toFixed(1)+'%)';}}}}}}));

  // ===== Severity by Group (stacked bar) =====
  charts.push(new Chart(document.getElementById('chSevGrp'),{type:'bar',data:{labels:GROUP_NAMES,datasets:[
    {label:'Major',data:GROUP_NAMES.map(g=>gData[g].major),backgroundColor:'#ef4444',borderRadius:2},
    {label:'Minor',data:GROUP_NAMES.map(g=>gData[g].minor),backgroundColor:'#f59e0b',borderRadius:2},
    {label:'NPU',data:GROUP_NAMES.map(g=>gData[g].npu),backgroundColor:'#0ea5e9',borderRadius:2},
    {label:'NPF',data:GROUP_NAMES.map(g=>gData[g].npf),backgroundColor:'#8b5cf6',borderRadius:2}
  ]},options:{...chartOpts({scales:{y:{stacked:true,ticks:{color:'#64748b'},grid:{color:'#e2e8f0'}},x:{stacked:true,ticks:{color:'#64748b',font:{size:10},maxRotation:45},grid:{display:false}}}}),plugins:{legend:{position:'bottom',labels:{color:'#64748b',padding:14,usePointStyle:true}},tooltip:{mode:'index'}}}}));

  // ===== Severity by Group (% of Sold) =====
  const pctOf=(count,g)=>gData[g].sold>0?parseFloat(((count/gData[g].sold)*100).toFixed(3)):0;
  charts.push(new Chart(document.getElementById('chSevPct'),{type:'bar',data:{labels:GROUP_NAMES,datasets:[
    {label:'Major %',data:GROUP_NAMES.map(g=>pctOf(gData[g].major,g)),backgroundColor:'#ef4444',borderRadius:2},
    {label:'Minor %',data:GROUP_NAMES.map(g=>pctOf(gData[g].minor,g)),backgroundColor:'#f59e0b',borderRadius:2},
    {label:'NPU %',data:GROUP_NAMES.map(g=>pctOf(gData[g].npu,g)),backgroundColor:'#0ea5e9',borderRadius:2},
    {label:'NPF %',data:GROUP_NAMES.map(g=>pctOf(gData[g].npf,g)),backgroundColor:'#8b5cf6',borderRadius:2}
  ]},options:{...chartOpts({scales:{y:{stacked:true,ticks:{color:'#64748b',callback:v=>v.toFixed(1)+'%'},grid:{color:'#e2e8f0'},title:{display:true,text:'% of Units Sold',color:'#64748b'}},x:{stacked:true,ticks:{color:'#64748b',font:{size:10},maxRotation:45},grid:{display:false}}}}),plugins:{legend:{position:'bottom',labels:{color:'#64748b',padding:14,usePointStyle:true}},tooltip:{mode:'index',callbacks:{label:c=>c.dataset.label+': '+c.raw.toFixed(3)+'%'}}}}}));

  // ===== CHART 5: Quarterly Trend (count) =====
  trendCycleIdx=-1;
  const trendDS=GROUP_NAMES.map((g,i)=>{
    const d=gData[g];
    return{label:g,data:sQA.map(q=>d.quarterlyData[q]?.rep||0),borderColor:GC[i%GC.length],backgroundColor:'transparent',borderWidth:2.5,pointRadius:3,pointBackgroundColor:GC[i%GC.length],tension:.35};
  });
  chTrendRef=new Chart(document.getElementById('chTrend'),{type:'line',data:{labels:sQA,datasets:trendDS},options:{...chartOpts({scales:{y:{ticks:{color:'#64748b'},grid:{color:'#e2e8f0'}},x:{ticks:{color:'#64748b',font:{size:10},maxRotation:45},grid:{display:false}}}}),interaction:{mode:'index',intersect:false},plugins:{legend:{position:'bottom',labels:{color:'#64748b',font:{size:10},usePointStyle:true,padding:10}},tooltip:{mode:'index'}}}});
  charts.push(chTrendRef);
  document.getElementById('trendPrevBtn').textContent='â—‚ Prev';
  document.getElementById('trendNextBtn').textContent='Next â–¸';

  // ===== CHART 5b: Quarterly Trend (% of sold) =====
  pctCycleIdx=-1;
  const trendPctDS=GROUP_NAMES.map((g,i)=>{
    const d=gData[g];
    return{label:g,data:sQA.map(q=>{const r=d.quarterlyData[q]?.rep||0;return d.sold>0?parseFloat(((r/d.sold)*100).toFixed(3)):null;}),borderColor:GC[i%GC.length],backgroundColor:'transparent',borderWidth:2.5,pointRadius:3,pointBackgroundColor:GC[i%GC.length],tension:.35};
  });
  chTrendPctRef=new Chart(document.getElementById('chTrendPct'),{type:'line',data:{labels:sQA,datasets:trendPctDS},options:{...chartOpts({scales:{y:{ticks:{color:'#64748b',callback:v=>v.toFixed(2)+'%'},grid:{color:'#e2e8f0'}},x:{ticks:{color:'#64748b',font:{size:10},maxRotation:45},grid:{display:false}}}}),interaction:{mode:'index',intersect:false},plugins:{legend:{position:'bottom',labels:{color:'#64748b',font:{size:10},usePointStyle:true,padding:10}},tooltip:{mode:'index',callbacks:{label:c=>c.dataset.label+': '+(c.raw!=null?c.raw.toFixed(3)+'%':'N/A')}}}}});
  charts.push(chTrendPctRef);
  document.getElementById('pctPrevBtn').textContent='â—‚ Prev';
  document.getElementById('pctNextBtn').textContent='Next â–¸';

  // ===== CHART 6: Cost Distribution (avg repair cost per group vs avg warranty rev) =====
  const avgRepCost=GROUP_NAMES.map(g=>gData[g].repairs>0?(gData[g].cost/gData[g].repairs):0);
  const avgWarrantyRevPerUnit=tSold>0?(tRev/tSold):0;
  charts.push(new Chart(document.getElementById('chDist'),{type:'bar',data:{labels:GROUP_NAMES,datasets:[
    {label:'Avg Repair Cost',data:avgRepCost,backgroundColor:GC.map(c=>c+'aa'),borderColor:GC,borderWidth:1,borderRadius:6,barPercentage:.65,yAxisID:'y'},
    {label:`Avg Warranty Rev/Unit: ${fD(avgWarrantyRevPerUnit)}`,data:GROUP_NAMES.map(()=>avgWarrantyRevPerUnit),type:'line',borderColor:'#10b981',borderWidth:2.5,borderDash:[8,4],pointRadius:0,fill:false,yAxisID:'y'}
  ]},options:{...chartOpts({scales:{y:{title:{display:true,text:'Cost ($)',color:'#64748b'},ticks:{color:'#64748b',callback:v=>'$'+v.toFixed(0)},grid:{color:'#e2e8f0'}},x:{ticks:{color:'#64748b',font:{size:10},maxRotation:45},grid:{display:false}}}}),plugins:{legend:{position:'bottom',labels:{color:'#64748b',padding:14,usePointStyle:true}},tooltip:{callbacks:{label:c=>c.dataset.label.split(':')[0]+': '+fD(c.raw)}}}}}));

  // ===== CHART 7a: Parts Cost by Quarter =====
  const qParts=sQA.map(q=>{let t=0,r=0;GROUP_NAMES.forEach(g=>{const d=gData[g].quarterlyData[q];if(d){t+=d.pC;r+=d.rep;}});return{t,r};});
  charts.push(new Chart(document.getElementById('chParts'),{type:'line',data:{labels:sQA,datasets:[
    {label:'Total Parts Cost',data:qParts.map(d=>d.t),borderColor:'#f97316',backgroundColor:'#f9731618',fill:true,tension:.3,borderWidth:2.5,pointRadius:4,yAxisID:'y'},
    {label:'Avg/Repair',data:qParts.map(d=>d.r>0?Math.round(d.t/d.r):null),borderColor:'#fbbf24',backgroundColor:'transparent',borderDash:[6,3],tension:.3,borderWidth:2,pointRadius:3,yAxisID:'y1'}
  ]},options:{...chartOpts({scales:{y:{title:{display:true,text:'Total Cost',color:'#f97316'},ticks:{color:'#f97316',callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'#e2e8f0'}},y1:{position:'right',title:{display:true,text:'Avg/Repair',color:'#fbbf24'},ticks:{color:'#fbbf24',callback:v=>'$'+v},grid:{display:false}},x:{ticks:{color:'#64748b',font:{size:10},maxRotation:45},grid:{display:false}}}}),interaction:{mode:'index',intersect:false},plugins:{legend:{position:'bottom',labels:{color:'#64748b',padding:12,usePointStyle:true}},tooltip:{callbacks:{label:c=>c.dataset.label+': '+fD(c.raw)}}}}}));

  // ===== CHART 7b: Labor Cost by Quarter =====
  const qLabor=sQA.map(q=>{let t=0,r=0;GROUP_NAMES.forEach(g=>{const d=gData[g].quarterlyData[q];if(d){t+=d.lC;r+=d.rep;}});return{t,r};});
  charts.push(new Chart(document.getElementById('chLabor'),{type:'line',data:{labels:sQA,datasets:[
    {label:'Total Labor Cost',data:qLabor.map(d=>d.t),borderColor:'#8b5cf6',backgroundColor:'#8b5cf618',fill:true,tension:.3,borderWidth:2.5,pointRadius:4,yAxisID:'y'},
    {label:'Avg/Repair',data:qLabor.map(d=>d.r>0?Math.round(d.t/d.r):null),borderColor:'#ec4899',backgroundColor:'transparent',borderDash:[6,3],tension:.3,borderWidth:2,pointRadius:3,yAxisID:'y1'}
  ]},options:{...chartOpts({scales:{y:{title:{display:true,text:'Total Cost',color:'#8b5cf6'},ticks:{color:'#8b5cf6',callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'#e2e8f0'}},y1:{position:'right',title:{display:true,text:'Avg/Repair',color:'#ec4899'},ticks:{color:'#ec4899',callback:v=>'$'+v},grid:{display:false}},x:{ticks:{color:'#64748b',font:{size:10},maxRotation:45},grid:{display:false}}}}),interaction:{mode:'index',intersect:false},plugins:{legend:{position:'bottom',labels:{color:'#64748b',padding:12,usePointStyle:true}},tooltip:{callbacks:{label:c=>c.dataset.label+': '+fD(c.raw)}}}}}));

  // ===== Parts cost by group bar =====
  charts.push(new Chart(document.getElementById('chPartsGrp'),{type:'bar',data:{labels:GROUP_NAMES,datasets:[{label:'Parts Cost',data:GROUP_NAMES.map(g=>gData[g].partsCost),backgroundColor:'#f97316aa',borderColor:'#f97316',borderWidth:1,borderRadius:6,barPercentage:.65}]},options:{...chartOpts({scales:{y:{ticks:{color:'#64748b',callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'#e2e8f0'}},x:{ticks:{color:'#64748b',font:{size:10},maxRotation:45},grid:{display:false}}}}),plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fD(c.raw)}}}}}));

  // ===== Labor cost by group bar =====
  charts.push(new Chart(document.getElementById('chLaborGrp'),{type:'bar',data:{labels:GROUP_NAMES,datasets:[{label:'Labor Cost',data:GROUP_NAMES.map(g=>gData[g].laborCost),backgroundColor:'#8b5cf6aa',borderColor:'#8b5cf6',borderWidth:1,borderRadius:6,barPercentage:.65}]},options:{...chartOpts({scales:{y:{ticks:{color:'#64748b',callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'#e2e8f0'}},x:{ticks:{color:'#64748b',font:{size:10},maxRotation:45},grid:{display:false}}}}),plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fD(c.raw)}}}}}));

  // Done â€” build assumptions group table & wire click handlers
  buildGroupTable();
  wireChartClicks();
  document.getElementById('loadingOverlay').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
}

// ===== TREND CHART CONTROLS =====
function setChartVisibility(chart, showArr, cycleIdx, prevBtnId, nextBtnId){
  const n=GROUP_NAMES.length;
  chart.data.datasets.forEach((ds,i)=>{
    const visible=showArr[i];
    ds.hidden=!visible;
    // Highlight solo mode: thicker line for active, faded for others
    if(cycleIdx>=0){
      ds.borderWidth=i===cycleIdx?4:1.5;
      ds.borderColor=i===cycleIdx?GC[i%GC.length]:(GC[i%GC.length]+'44');
      ds.pointRadius=i===cycleIdx?5:0;
    } else {
      ds.borderWidth=2.5;
      ds.borderColor=GC[i%GC.length];
      ds.pointRadius=3;
    }
  });
  chart.update();
  // Update button labels
  if(cycleIdx>=0){
    const prev=(cycleIdx-1+n)%n;
    const next=(cycleIdx+1)%n;
    document.getElementById(prevBtnId).textContent='â—‚ '+GROUP_NAMES[prev];
    document.getElementById(nextBtnId).textContent=GROUP_NAMES[next]+' â–¸';
  } else {
    document.getElementById(prevBtnId).textContent='â—‚ Prev';
    document.getElementById(nextBtnId).textContent='Next â–¸';
  }
}

// -- Count trend controls --
function trendAllOn(){trendCycleIdx=-1;setChartVisibility(chTrendRef,GROUP_NAMES.map(()=>true),trendCycleIdx,'trendPrevBtn','trendNextBtn');}
function trendAllOff(){trendCycleIdx=-1;setChartVisibility(chTrendRef,GROUP_NAMES.map(()=>false),trendCycleIdx,'trendPrevBtn','trendNextBtn');}
function trendNext(){trendCycleIdx=(trendCycleIdx+1)%GROUP_NAMES.length;setChartVisibility(chTrendRef,GROUP_NAMES.map((_,i)=>i===trendCycleIdx),trendCycleIdx,'trendPrevBtn','trendNextBtn');}
function trendPrev(){const n=GROUP_NAMES.length;trendCycleIdx=trendCycleIdx<=0?(n-1):(trendCycleIdx-1);setChartVisibility(chTrendRef,GROUP_NAMES.map((_,i)=>i===trendCycleIdx),trendCycleIdx,'trendPrevBtn','trendNextBtn');}

// -- Pct trend controls --
function pctAllOn(){pctCycleIdx=-1;setChartVisibility(chTrendPctRef,GROUP_NAMES.map(()=>true),pctCycleIdx,'pctPrevBtn','pctNextBtn');}
function pctAllOff(){pctCycleIdx=-1;setChartVisibility(chTrendPctRef,GROUP_NAMES.map(()=>false),pctCycleIdx,'pctPrevBtn','pctNextBtn');}
function pctNext(){pctCycleIdx=(pctCycleIdx+1)%GROUP_NAMES.length;setChartVisibility(chTrendPctRef,GROUP_NAMES.map((_,i)=>i===pctCycleIdx),pctCycleIdx,'pctPrevBtn','pctNextBtn');}
function pctPrev(){const n=GROUP_NAMES.length;pctCycleIdx=pctCycleIdx<=0?(n-1):(pctCycleIdx-1);setChartVisibility(chTrendPctRef,GROUP_NAMES.map((_,i)=>i===pctCycleIdx),pctCycleIdx,'pctPrevBtn','pctNextBtn');}

// ===== MODAL FUNCTIONS =====
function openModal(title,html){document.getElementById('modalTitle').textContent=title;document.getElementById('modalBody').innerHTML=html;document.getElementById('modalOverlay').classList.add('active');}
function closeModal(){document.getElementById('modalOverlay').classList.remove('active');}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});

// ===== BUILD GROUP TABLE =====
function buildGroupTable(){
  const MODEL_NAMES={
    'CBUS1100015':'NL72 N5100 8/64','CBUS1100016':'NL72 4/64',
    'CBUS1100011':'NL72TW 8/64','CBUS1100017':'NL72T N4500 4/64','CBUS1100023':'NL72T N5100 4/64',
    'CBUS1100013':'NL72-L 4/64 LTE','CBUS1100019':'NL72-L 4/64 LTE','CBUS1100020':'NL72CT-L 4/64 LTE','CBUS1100021':'NL72CT',
    'CBUS1100024':'NL73 N100 8/64','CBUS1100026':'NL73CT N100 8/64','CBUS1100028':'NL73 N100 4/64',
    'CBUS1100025':'NL73TW N100 360','CBUS1100027':'NL73T N100 360','CBUS1100030':'NL73TWB N200 8/64',
    'CBUS1100033':'PX111E 4/64','CBUS1100034':'PX111E 8/64',
    'CBUS1400003':'PX14E 14" HD','CBUS1400004':'PX14EX 14" FHD','CBUS1400005':'PX14EXT 14" Touch',
    'CBUS1400006':'PX14EX 8/64 N6000','CBUS1400007':'PX14EXT 8/64 N6000','CBUS1400008':'PX14EX 8/128 N6000',
    'CBUS1400009':'PX14EXT 8/128 N6000','CBUS1400010':'PX14E 4/64 N6000',
    'CBUS1400011':'PX141E N100 8/64','CBUS1400012':'PX141EXT','CBUS1400013':'PX141GX','CBUS1400015':'PX141GXT','ZPX141GXT':'PX141GXT',
    'CBXEU190010':'CBx3 Celeron 7305','CBXEU190011':'CBx3-7 i7 1355U','CBXUS190003':'CBx2 4/64 5205U',
    'CBXUS190004':'CBx2-7 8/128','CBXUS190010':'CBx3 Cel 7305','CBXUS190011':'CBx3-7 i7-1355U','CBXUS190022':'OPS OPx1-3',
    'CBUS1100035':'NL73TW Gen2','CBUS1100037':'NL73 Gen2','CBUS1200001':'PX121E',
    'CBXUS190005':'Meet GQE15C','CBXUS190020':'Meet GQE20C'
  };
  let h='<thead><tr><th>Group</th><th>SKUs</th><th>Models Included</th><th>Units Sold</th><th>Repairs</th></tr></thead><tbody>';
  GROUP_NAMES.forEach(g=>{
    const items=GROUPS[g];const d=gData[g];
    const models=items.map(it=>{const n=MODEL_NAMES[it]||it;return n;}).join(', ');
    h+=`<tr><td>${g}</td><td class="mono">${items.length}</td><td>${models}</td><td class="mono">${fmt(d.sold)}</td><td class="mono">${fmt(d.repairs)}</td></tr>`;
  });
  h+='</tbody>';
  document.getElementById('groupTable').innerHTML=h;
}

// ===== GROUP DETAIL MODAL =====
function showGroupDetail(groupName){
  const d=gData[groupName];if(!d)return;
  const rr=d.sold>0?(d.repairs/d.sold*100):null;
  const nPL=d.rev+d.repairRev-d.cost;
  const accP=d.repairs>0?(d.accidental/d.repairs*100):0;
  const inWP=(d.inW+d.outW)>0?(d.inW/(d.inW+d.outW)*100):0;
  const avgC=d.repairs>0?(d.cost/d.repairs):0;

  let h=`<div class="detail-stats">
    <div class="detail-stat"><div class="label">Units Sold</div><div class="value">${fmt(d.sold)}</div></div>
    <div class="detail-stat"><div class="label">Repairs</div><div class="value">${fmt(d.repairs)}</div></div>
    <div class="detail-stat"><div class="label">Repair Rate</div><div class="value">${rr!=null?fP(rr):'N/A'}</div></div>
    <div class="detail-stat"><div class="label">Avg Cost/Repair</div><div class="value">${fD(avgC)}</div></div>
    <div class="detail-stat"><div class="label">Total Cost</div><div class="value">${fD(d.cost)}</div></div>
    <div class="detail-stat"><div class="label">Warranty Rev</div><div class="value">${fD(d.rev)}</div></div>
    <div class="detail-stat"><div class="label">Repair Rev (OOW)</div><div class="value">${fD(d.repairRev)}</div></div>
    <div class="detail-stat"><div class="label">Net P/L</div><div class="value" style="color:${nPL>=0?'var(--green)':'var(--red)'}">${fD(nPL)}</div></div>
  </div>`;

  h+=`<div class="detail-stats" style="grid-template-columns:repeat(auto-fit,minmax(100px,1fr))">
    <div class="detail-stat"><div class="label">Major</div><div class="value">${fmt(d.major)}</div></div>
    <div class="detail-stat"><div class="label">Minor</div><div class="value">${fmt(d.minor)}</div></div>
    <div class="detail-stat"><div class="label">NPU</div><div class="value">${fmt(d.npu)}</div></div>
    <div class="detail-stat"><div class="label">NPF</div><div class="value">${fmt(d.npf)}</div></div>
    <div class="detail-stat"><div class="label">Accidental %</div><div class="value">${fP(accP)}</div></div>
    <div class="detail-stat"><div class="label">In Warranty %</div><div class="value">${fP(inWP)}</div></div>
    <div class="detail-stat"><div class="label">Parts Cost</div><div class="value">${fD(d.partsCost)}</div></div>
    <div class="detail-stat"><div class="label">Labor Cost</div><div class="value">${fD(d.laborCost)}</div></div>
  </div>`;

  // Item breakdown
  const items=Object.entries(d.itemData).sort((a,b)=>b[1].sold-a[1].sold);
  if(items.length){
    h+=`<div class="section-label">Models in This Group</div><table><thead><tr><th>Item #</th><th>Model</th><th>Sold</th><th>Repairs</th><th>Rate</th><th>Cost</th><th>Maj</th><th>Min</th><th>NPU</th><th>NPF</th></tr></thead><tbody>`;
    items.forEach(([it,id])=>{
      const r=id.sold>0?(id.repairs/id.sold*100):null;
      h+=`<tr><td class="mono">${it}</td><td>${id.name||it}</td><td class="mono">${fmt(id.sold)}</td><td class="mono">${fmt(id.repairs)}</td><td class="mono">${r!=null?fP(r):'â€”'}</td><td class="mono">${fD(id.cost)}</td><td class="mono">${fmt(id.major)}</td><td class="mono">${fmt(id.minor)}</td><td class="mono">${fmt(id.npu)}</td><td class="mono">${fmt(id.npf)}</td></tr>`;
    });
    h+='</tbody></table>';
  }

  // Repair types
  const rTypes=Object.entries(d.repairTypes).sort((a,b)=>b[1]-a[1]);
  if(rTypes.length){
    h+=`<div class="section-label">Top Repair Types</div><table><thead><tr><th>Repair Type</th><th>Count</th><th>% of Group Repairs</th></tr></thead><tbody>`;
    rTypes.slice(0,15).forEach(([rep,cnt])=>{
      h+=`<tr><td>${rep}</td><td class="mono">${fmt(cnt)}</td><td class="mono">${fP(cnt/d.repairs*100)}</td></tr>`;
    });
    h+='</tbody></table>';
  }

  // Year-by-year
  const yrs=Object.keys(d.yearlyRepairs).filter(vY).sort();
  if(yrs.length){
    h+=`<div class="section-label">Year-by-Year Repairs</div><table><thead><tr><th>Year</th><th>Repairs</th><th>Cost</th><th>Major</th><th>Minor</th><th>NPU</th><th>NPF</th><th>Units Sold</th></tr></thead><tbody>`;
    yrs.forEach(yr=>{
      const yd=d.yearlyRepairs[yr];
      h+=`<tr><td>${yr}</td><td class="mono">${fmt(yd.rep)}</td><td class="mono">${fD(yd.cost)}</td><td class="mono">${fmt(yd.maj||0)}</td><td class="mono">${fmt(yd.min||0)}</td><td class="mono">${fmt(yd.npu||0)}</td><td class="mono">${fmt(yd.npf||0)}</td><td class="mono">${fmt(d.yearlySold[yr]||0)}</td></tr>`;
    });
    h+='</tbody></table>';
  }

  // Quarterly data
  const qtrs=Object.keys(d.quarterlyData).sort();
  if(qtrs.length){
    h+=`<div class="section-label">Quarterly Breakdown</div><table><thead><tr><th>Quarter</th><th>Repairs</th><th>Total Cost</th><th>Parts</th><th>Labor</th><th>Avg/Repair</th></tr></thead><tbody>`;
    qtrs.forEach(q=>{
      const qd=d.quarterlyData[q];
      h+=`<tr><td>${q}</td><td class="mono">${fmt(qd.rep)}</td><td class="mono">${fD(qd.cost)}</td><td class="mono">${fD(qd.pC)}</td><td class="mono">${fD(qd.lC)}</td><td class="mono">${qd.rep>0?fD(qd.cost/qd.rep):'â€”'}</td></tr>`;
    });
    h+='</tbody></table>';
  }

  openModal(groupName+' â€” Detail',h);
}

// ===== SEVERITY DETAIL MODAL =====
function showSeverityDetail(category){
  let h=`<div class="detail-stats">`;
  let total=0;GROUP_NAMES.forEach(g=>{const d=gData[g];total+=category==='Major'?d.major:category==='Minor'?d.minor:category==='NPU'?d.npu:d.npf;});
  let tRep=0;GROUP_NAMES.forEach(g=>tRep+=gData[g].repairs);
  h+=`<div class="detail-stat"><div class="label">Total ${category}</div><div class="value">${fmt(total)}</div></div>`;
  h+=`<div class="detail-stat"><div class="label">% of All Repairs</div><div class="value">${tRep>0?fP(total/tRep*100):'N/A'}</div></div></div>`;
  h+=`<div class="section-label">${category} Repairs by Device Group</div><table><thead><tr><th>Group</th><th>Count</th><th>% of Group</th><th>Units Sold</th><th>% of Sold</th></tr></thead><tbody>`;
  GROUP_NAMES.forEach(g=>{
    const d=gData[g];const cnt=category==='Major'?d.major:category==='Minor'?d.minor:category==='NPU'?d.npu:d.npf;
    if(cnt===0)return;
    h+=`<tr style="cursor:pointer" onclick="showGroupDetail('${g}')"><td>${g}</td><td class="mono">${fmt(cnt)}</td><td class="mono">${d.repairs>0?fP(cnt/d.repairs*100):'â€”'}</td><td class="mono">${fmt(d.sold)}</td><td class="mono">${d.sold>0?fP(cnt/d.sold*100):'â€”'}</td></tr>`;
  });
  h+='</tbody></table>';
  h+=`<div class="assumption-note"><strong>Severity classification:</strong> NPU â†’ NPF â†’ Major (Major Repairs="Yes") â†’ Minor (everything else). Each repair classified into exactly one category. Priority order prevents double-counting.</div>`;
  openModal(category+' Repairs â€” Detail',h);
}

// ===== QUARTER DETAIL MODAL =====
function showQuarterDetail(quarter,type){
  const label=type==='parts'?'Parts':'Labor';
  let tCost=0,tRep=0;
  const rows=[];
  GROUP_NAMES.forEach(g=>{
    const qd=gData[g].quarterlyData[quarter];if(!qd||qd.rep===0)return;
    const val=type==='parts'?qd.pC:qd.lC;
    rows.push({g,rep:qd.rep,cost:val,avg:val/qd.rep,totalCost:qd.cost});
    tCost+=val;tRep+=qd.rep;
  });
  rows.sort((a,b)=>b.cost-a.cost);
  let h=`<div class="detail-stats">
    <div class="detail-stat"><div class="label">Quarter</div><div class="value">${quarter}</div></div>
    <div class="detail-stat"><div class="label">Total ${label} Cost</div><div class="value">${fD(tCost)}</div></div>
    <div class="detail-stat"><div class="label">Total Repairs</div><div class="value">${fmt(tRep)}</div></div>
    <div class="detail-stat"><div class="label">Avg ${label}/Repair</div><div class="value">${tRep>0?fD(tCost/tRep):'â€”'}</div></div>
  </div>`;
  h+=`<div class="section-label">${label} Cost by Device Group</div><table><thead><tr><th>Group</th><th>Repairs</th><th>${label} Cost</th><th>Avg/Repair</th><th>Total Repair Cost</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    h+=`<tr style="cursor:pointer" onclick="showGroupDetail('${r.g}')"><td>${r.g}</td><td class="mono">${fmt(r.rep)}</td><td class="mono">${fD(r.cost)}</td><td class="mono">${fD(r.avg)}</td><td class="mono">${fD(r.totalCost)}</td></tr>`;
  });
  h+='</tbody></table>';
  h+=`<div class="assumption-note"><strong>${label} cost note:</strong> ${type==='parts'?'Parts cost = Total repair cost (incl. $10 shipping) âˆ’ labor cost (min $0).':'Labor uses actual LABOR15/30/60 codes ($7.50/$15/$30) when available. Otherwise assumed: Major=$30, Minor=$15, NPU/NPF/OS=$7.50.'}</div>`;
  openModal(quarter+' â€” '+label+' Cost Detail',h);
}

// ===== COST DISTRIBUTION DETAIL =====
function showCostDistDetail(groupName){
  const d=gData[groupName];if(!d)return;
  const avgC=d.repairs>0?(d.cost/d.repairs):0;
  const avgRev=d.sold>0?(d.rev/d.sold):0;
  const gap=avgRev-avgC;
  let h=`<div class="detail-stats">
    <div class="detail-stat"><div class="label">Avg Repair Cost</div><div class="value">${fD(avgC)}</div></div>
    <div class="detail-stat"><div class="label">Avg Warranty Rev/Unit</div><div class="value">${fD(avgRev)}</div></div>
    <div class="detail-stat"><div class="label">Gap (Rev âˆ’ Cost)</div><div class="value" style="color:${gap>=0?'var(--green)':'var(--red)'}">${fD(gap)}</div></div>
    <div class="detail-stat"><div class="label">Total Repairs</div><div class="value">${fmt(d.repairs)}</div></div>
    <div class="detail-stat"><div class="label">Total Cost</div><div class="value">${fD(d.cost)}</div></div>
    <div class="detail-stat"><div class="label">Total Revenue</div><div class="value">${fD(d.rev)}</div></div>
  </div>`;
  h+=`<div class="assumption-note"><strong>Cost distribution:</strong> Avg Repair Cost = Total repair cost (incl. $10 shipping) Ã· total repairs. Avg Warranty Rev/Unit = Total warranty revenue Ã· units sold. Groups where avg repair cost exceeds avg revenue per unit indicate warranty programs that cost more per repair event than the revenue generated per unit sold.</div>`;
  openModal(groupName+' â€” Cost Analysis',h);
}

// ===== WIRE CHART CLICK HANDLERS =====
function wireChartClicks(){
  // For bar charts indexed by GROUP_NAMES â€” click opens group detail
  const groupBarIds=['chSold','chRev','chFreq','chSevGrp','chSevPct','chPartsGrp','chLaborGrp'];
  groupBarIds.forEach(id=>{
    const canvas=document.getElementById(id);
    if(!canvas)return;
    canvas.onclick=function(evt){
      const ch=Chart.getChart(canvas);if(!ch)return;
      const pts=ch.getElementsAtEventForMode(evt,'nearest',{intersect:true},false);
      if(pts.length){
        const idx=pts[0].index;
        if(id==='chDist') showCostDistDetail(GROUP_NAMES[idx]);
        else showGroupDetail(GROUP_NAMES[idx]);
      }
    };
  });

  // Cost distribution bar
  const distCanvas=document.getElementById('chDist');
  if(distCanvas){
    distCanvas.onclick=function(evt){
      const ch=Chart.getChart(distCanvas);if(!ch)return;
      const pts=ch.getElementsAtEventForMode(evt,'nearest',{intersect:true},false);
      if(pts.length) showCostDistDetail(GROUP_NAMES[pts[0].index]);
    };
  }

  // Severity doughnut
  const sevCanvas=document.getElementById('chSev');
  if(sevCanvas){
    sevCanvas.onclick=function(evt){
      const ch=Chart.getChart(sevCanvas);if(!ch)return;
      const pts=ch.getElementsAtEventForMode(evt,'nearest',{intersect:true},false);
      if(pts.length) showSeverityDetail(['Major','Minor','NPU','NPF'][pts[0].index]);
    };
  }

  // Stacked year charts â€” click a segment to show that group
  ['chSoldYr','chRevYr'].forEach(id=>{
    const canvas=document.getElementById(id);if(!canvas)return;
    canvas.onclick=function(evt){
      const ch=Chart.getChart(canvas);if(!ch)return;
      const pts=ch.getElementsAtEventForMode(evt,'nearest',{intersect:true},false);
      if(pts.length) showGroupDetail(GROUP_NAMES[pts[0].datasetIndex]);
    };
  });

  // Trend line charts â€” click shows group detail
  ['chTrend','chTrendPct'].forEach(id=>{
    const canvas=document.getElementById(id);if(!canvas)return;
    canvas.onclick=function(evt){
      const ch=Chart.getChart(canvas);if(!ch)return;
      const pts=ch.getElementsAtEventForMode(evt,'nearest',{intersect:true},false);
      if(pts.length) showGroupDetail(GROUP_NAMES[pts[0].datasetIndex]);
    };
  });

  // Parts & labor quarterly â€” click shows quarter detail
  const partsCanvas=document.getElementById('chParts');
  if(partsCanvas){
    partsCanvas.onclick=function(evt){
      const ch=Chart.getChart(partsCanvas);if(!ch)return;
      const pts=ch.getElementsAtEventForMode(evt,'nearest',{intersect:true},false);
      if(pts.length){const lbl=ch.data.labels[pts[0].index];showQuarterDetail(lbl,'parts');}
    };
  }
  const laborCanvas=document.getElementById('chLabor');
  if(laborCanvas){
    laborCanvas.onclick=function(evt){
      const ch=Chart.getChart(laborCanvas);if(!ch)return;
      const pts=ch.getElementsAtEventForMode(evt,'nearest',{intersect:true},false);
      if(pts.length){const lbl=ch.data.labels[pts[0].index];showQuarterDetail(lbl,'labor');}
    };
  }
}

// ===== DOWNLOAD FUNCTIONS =====
function dlChart(canvasId, filename){
  const canvas=document.getElementById(canvasId);
  if(!canvas)return;
  // Create high-res version
  const scale=2;
  const tmpCanvas=document.createElement('canvas');
  tmpCanvas.width=canvas.width*scale;
  tmpCanvas.height=canvas.height*scale;
  const ctx=tmpCanvas.getContext('2d');
  ctx.scale(scale,scale);
  ctx.fillStyle='#ffffff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(canvas,0,0,canvas.width,canvas.height);
  const link=document.createElement('a');
  link.download=filename+'.png';
  link.href=tmpCanvas.toDataURL('image/png',1.0);
  link.click();
}

function downloadAll(){
  const btn=document.getElementById('dlAllBtn');
  btn.disabled=true;btn.textContent='â³ Building ZIPâ€¦';
  const ids=[
    ['chSold','Warranty_Units_Sold_By_Group'],
    ['chRev','Warranty_Revenue_By_Group'],
    ['chSoldYr','Units_Sold_By_Year_Stacked'],
    ['chRevYr','Revenue_By_Year_Stacked'],
    ['chFreq','Claim_Frequency_By_Group'],
    ['chSev','Claim_Severity_Doughnut'],
    ['chSevGrp','Severity_By_Group_Stacked'],
    ['chSevPct','Severity_By_Group_Pct_Sold'],
    ['chTrend','Breakage_Rate_Quarterly_Count'],
    ['chTrendPct','Breakage_Rate_Quarterly_Pct'],
    ['chDist','Cost_Distribution_vs_Revenue'],
    ['chParts','Parts_Cost_Quarterly'],
    ['chLabor','Labor_Cost_Quarterly'],
    ['chPartsGrp','Parts_Cost_By_Group'],
    ['chLaborGrp','Labor_Cost_By_Group']
  ];
  const zip=new JSZip();
  ids.forEach(([canvasId,filename])=>{
    const canvas=document.getElementById(canvasId);
    if(!canvas)return;
    const scale=2;
    const tmp=document.createElement('canvas');
    tmp.width=canvas.width*scale;tmp.height=canvas.height*scale;
    const ctx=tmp.getContext('2d');
    ctx.scale(scale,scale);
    ctx.fillStyle='#ffffff';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(canvas,0,0,canvas.width,canvas.height);
    const dataUrl=tmp.toDataURL('image/png',1.0);
    const base64=dataUrl.split(',')[1];
    zip.file(filename+'.png',base64,{base64:true});
  });
  zip.generateAsync({type:'blob'}).then(blob=>{
    const link=document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download='CTL_Warranty_Charts.zip';
    link.click();
    URL.revokeObjectURL(link.href);
    btn.disabled=false;btn.textContent='â¬‡ Download All Charts as ZIP';
  });
}
</script>
</body>
</html>
